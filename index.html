<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Macrely">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<title>Macrely</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#000000;
--card:#1C1C1E;
--card-border:#2C2C2E;
--primary:#10b981;
--text:#ffffff;
--muted:rgba(255,255,255,0.5);
--input-bg:#1C1C1E;
--input-border:#2C2C2E;
--weight-color:#A78BFA;
--energy-color:#FB923C;
--steps-color:#2DD4BF;
--sleep-color:#22D3EE;
--nutriscore-a:#22C55E;
--nutriscore-b:#84CC16;
--nutriscore-c:#F59E0B;
--nutriscore-d:#F97316;
--nutriscore-e:#EF4444;
--ring-bg:rgba(255,255,255,0.1);
}
:root.light{
--bg:#f8f9fa;--card:#ffffff;--card-border:rgba(0,0,0,0.08);--text:#1a1a2e;
--muted:rgba(0,0,0,0.5);--input-bg:#f0f0f0;--input-border:rgba(0,0,0,0.1);
--ring-bg:rgba(0,0,0,0.08);
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,select,textarea{background:var(--input-bg);border:1px solid var(--input-border);color:var(--text);padding:14px 16px;border-radius:12px;width:100%;font-size:16px;outline:none;transition:border-color 0.3s;font-family:inherit}
input:focus,select:focus{border-color:var(--primary)}
input::placeholder{color:var(--muted)}
select option{background:var(--card);color:var(--text)}
.progress-ring{transform:rotate(-90deg)}
.progress-ring circle{transition:stroke-dashoffset 0.8s ease}
@keyframes modalSlideUp{0%{transform:translateY(100%);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
@keyframes slideUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
@keyframes toastIn{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes toastOut{from{opacity:1}to{opacity:0}}
@keyframes ringFill{0%{stroke-dashoffset:var(--ring-full)}100%{stroke-dashoffset:var(--ring-target)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes voicePulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(16,185,129,0.4)}50%{transform:scale(1.1);box-shadow:0 0 0 20px rgba(16,185,129,0)}}
.voice-pulse{animation:voicePulse 1.5s ease-in-out infinite}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);display:flex;align-items:flex-end;justify-content:center;z-index:100}
.modal{animation:modalSlideUp 0.3s ease-out;background:var(--card);border-radius:24px 24px 0 0;width:100%;max-width:500px;padding:24px;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.toast{position:fixed;top:env(safe-area-inset-top,20px);left:50%;transform:translateX(-50%);z-index:300;background:#1C1C1E;border:1px solid #2C2C2E;border-radius:16px;padding:14px 20px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:toastIn 0.3s ease-out;max-width:90vw;font-size:14px}
.toast.out{animation:toastOut 0.3s ease-in forwards}
.card{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:16px}
.btn{padding:12px 24px;border-radius:50px;border:none;font-weight:600;cursor:pointer;font-size:15px;font-family:inherit;transition:transform 0.15s,opacity 0.15s}
.btn:active{transform:scale(0.96);opacity:0.9}
.btn-primary{background:#fff;color:#000;width:100%;padding:16px}
.btn-outline{background:transparent;border:1px solid var(--card-border);color:var(--text)}
.fab-cluster{position:fixed;bottom:100px;right:20px;display:flex;flex-direction:column;align-items:flex-end;gap:10px;z-index:50}
.fab{width:44px;height:44px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:transform 0.2s,opacity 0.2s}
.fab:active{transform:scale(0.92)}
.fab-main{background:var(--primary);width:48px;height:48px;font-size:22px;color:#fff;transition:transform 0.3s}
.fab-main.open{transform:rotate(45deg)}
.fab-option{background:#2C2C2E;color:#fff;opacity:0;transform:scale(0.5) translateY(10px);pointer-events:none;transition:all 0.2s ease}
.fab-option.visible{opacity:1;transform:scale(1) translateY(0);pointer-events:auto}
.fab-label{position:absolute;right:54px;background:rgba(0,0,0,0.8);color:#fff;padding:4px 10px;border-radius:8px;font-size:12px;white-space:nowrap;pointer-events:none}
.tab-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);border-top:1px solid #1C1C1E;display:flex;padding:8px 0;padding-bottom:max(8px,env(safe-area-inset-bottom));z-index:90}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px;color:var(--muted);font-size:10px;font-weight:500;cursor:pointer;transition:color 0.2s;border:none;background:none}
.tab-item.active{color:var(--primary)}
.tab-item svg{width:24px;height:24px}
.onboarding{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
.onboarding-content{flex:1;padding:20px 24px;padding-top:max(60px,env(safe-area-inset-top,60px))}
.onboarding-footer{padding:20px 24px;padding-bottom:max(24px,env(safe-area-inset-bottom))}
.step-dots{display:flex;gap:6px;justify-content:center;padding:12px;padding-top:max(50px,env(safe-area-inset-top,50px))}
.step-dot{width:8px;height:8px;border-radius:4px;background:#2C2C2E;transition:all 0.3s}
.step-dot.active{background:#fff;width:24px}
.option-card{background:var(--card);border:2px solid var(--card-border);border-radius:16px;padding:18px;cursor:pointer;transition:border-color 0.2s,background 0.2s;display:flex;align-items:center;gap:14px}
.option-card.selected{border-color:var(--primary);background:rgba(16,185,129,0.08)}
.option-card:active{transform:scale(0.98)}
.check-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:12px}
.check-card.selected{border-color:var(--primary);background:rgba(16,185,129,0.08)}
.checkbox{width:22px;height:22px;border-radius:6px;border:2px solid var(--card-border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
.check-card.selected .checkbox{background:var(--primary);border-color:var(--primary)}
.nutriscore-pill{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;font-weight:700;font-size:14px;color:#fff;opacity:0.4;transition:all 0.2s}
.nutriscore-pill.active{opacity:1;width:40px;height:40px;font-size:18px;border-radius:10px}
.sparkline{display:block}
.scroll-row{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.scroll-row::-webkit-scrollbar{display:none}
.insight-card{min-width:160px;background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:16px;flex-shrink:0}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}
.calendar-day{width:100%;aspect-ratio:1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);cursor:pointer;position:relative}
.calendar-day.has-meals{color:var(--text);font-weight:600}
.calendar-day.has-meals::after{content:'';position:absolute;bottom:2px;width:4px;height:4px;border-radius:50%;background:var(--primary)}
.calendar-day.today{background:rgba(16,185,129,0.2);color:var(--primary)}
.health-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.health-card{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:14px}
.health-card h4{font-size:13px;font-weight:600;margin-bottom:8px}
.macro-ring-row{display:flex;justify-content:space-around;padding:12px 0}
.meal-timeline-item{display:flex;gap:12px;padding:14px;background:var(--card);border:1px solid var(--card-border);border-radius:14px;margin-bottom:10px;align-items:center;cursor:pointer}
.meal-timeline-item:active{opacity:0.8}
.meal-photo-thumb{width:52px;height:52px;border-radius:12px;object-fit:cover;background:#2C2C2E;flex-shrink:0}
.section-title{font-size:18px;font-weight:700;margin-bottom:12px}
.page-scroll{padding:16px;padding-top:max(16px,env(safe-area-inset-top));padding-bottom:120px;max-width:500px;margin:0 auto}
/* Tab indicator dot */
.tab-item::after{content:'';display:block;width:4px;height:4px;border-radius:2px;background:transparent;transition:width 0.3s cubic-bezier(0.4,0,0.2,1),background 0.3s}
.tab-item.active::after{width:16px;background:var(--primary)}
/* Page enter animation */
@keyframes pageEnter{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
.page-enter{animation:pageEnter 0.3s cubic-bezier(0.4,0,0.2,1) both}
/* Meal card stagger */
.meal-card-stagger{animation:slideUp 0.35s cubic-bezier(0.4,0,0.2,1) both;animation-delay:calc(var(--i) * 0.05s)}
/* Meal timeline press */
.meal-timeline-item{transition:transform 0.15s,opacity 0.15s}
.meal-timeline-item:active{transform:scale(0.97);opacity:0.85}
/* Button glow */
.btn-primary{position:relative;overflow:hidden}
.btn-primary::after{content:'';position:absolute;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.25) 0%,transparent 70%);top:calc(var(--tap-y,50%) - 60px);left:calc(var(--tap-x,50%) - 60px);opacity:0;transition:opacity 0.15s;pointer-events:none}
.btn-primary:active::after{opacity:1}
/* Macro ring entrance */
@keyframes macroRingEnter{0%{opacity:0;transform:scale(0.8)}100%{opacity:1;transform:scale(1)}}
.macro-ring-enter{animation:macroRingEnter 0.4s cubic-bezier(0.4,0,0.2,1) both;animation-delay:calc(var(--ri) * 0.08s)}
/* Toast bounce */
@keyframes toastBounce{0%{transform:translateX(-50%) translateY(-120%);opacity:0}50%{transform:translateX(-50%) translateY(8px);opacity:1}70%{transform:translateX(-50%) translateY(-4px)}100%{transform:translateX(-50%) translateY(0);opacity:1}}
.toast{animation:toastBounce 0.45s cubic-bezier(0.34,1.56,0.64,1)}
/* Modal backdrop */
@keyframes backdropFade{0%{opacity:0}100%{opacity:1}}
.modal-overlay{animation:backdropFade 0.35s ease both}
/* Option/check card press */
.option-card:active{transform:scale(0.98)}
.check-card:active{transform:scale(0.98)}
/* Satisfying button press */
.btn:active{transform:scale(0.95)}
/* Success celebration */
@keyframes successPop{0%{transform:scale(0.8);opacity:0}50%{transform:scale(1.08)}100%{transform:scale(1);opacity:1}}
.success-pop{animation:successPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both}
/* Smooth card hover/press */
.card{transition:transform 0.15s ease}
.card:active{transform:scale(0.98)}
/* Calendar day press */
.calendar-day.has-meals{transition:transform 0.15s,background 0.15s}
.calendar-day.has-meals:active{transform:scale(0.85);background:rgba(16,185,129,0.3)}
/* Health card press */
.health-card{transition:transform 0.15s}
.health-card:active{transform:scale(0.97)}
/* Insight card press */
.insight-card{transition:transform 0.15s}
.insight-card:active{transform:scale(0.96)}
/* Tab bar spring */
@keyframes tabBounce{0%{transform:scale(1)}30%{transform:scale(0.88)}60%{transform:scale(1.06)}100%{transform:scale(1)}}
.tab-item:active{animation:tabBounce 0.3s ease}
/* Streak pulse */
@keyframes streakGlow{0%,100%{filter:brightness(1)}50%{filter:brightness(1.3)}}
.streak-glow{animation:streakGlow 2s ease-in-out infinite}
/* Share button shine */
@keyframes btnShine{0%{background-position:200% center}100%{background-position:-200% center}}
/* Smooth number transitions */
@keyframes countUp{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.count-enter{animation:countUp 0.3s ease-out both}
</style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

/* ==================== CONSTANTS ==================== */
const APP_NAME='Macrely';
const APP_VERSION='2.2.0';
const ACT_MULT={sedentary:1.2,light:1.375,moderate:1.55,very_active:1.725,athlete:1.9};
const PROTEIN_MULT={weight_loss:2.0,muscle_building:1.9,maintain:1.5,general_health:1.3};
const GOAL_CAL_ADJ={weight_loss:-400,muscle_building:300,maintain:0,general_health:0};
const EMPTY={calories:0,protein:0,carbs:0,fat:0,fiber:0,sugar:0,sodium:0,potassium:0,calcium:0,magnesium:0};
const r2=n=>Math.round((n||0)*100)/100;
const getD=(d=new Date())=>d.toLocaleDateString('en-NZ');
const getT=()=>new Date().toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});
const getMealSlot=()=>{const h=new Date().getHours();return h>=5&&h<11?'Breakfast':h>=11&&h<14?'Lunch':h>=14&&h<17?'Afternoon Snack':h>=17&&h<21?'Dinner':'Evening Snack'};
const st={get:k=>{try{return localStorage.getItem(k)}catch{return null}},set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}};
const getStorageUsage=()=>{let t=0;for(let k in localStorage){if(localStorage.hasOwnProperty(k))t+=localStorage[k].length*2}return t};
const STORAGE_LIMIT=4*1024*1024;

/* ==================== HAPTIC & SOUND ==================== */
const haptic=(type='light')=>{if(!navigator.vibrate)return;try{const patterns={light:10,medium:20,success:[10,50,20],error:[30,20,30]};navigator.vibrate(patterns[type]||10)}catch{}};

const _audioCtx={ctx:null};
const playSound=(type='tap')=>{try{
  if(!_audioCtx.ctx)_audioCtx.ctx=new(window.AudioContext||window.webkitAudioContext)();
  const ctx=_audioCtx.ctx;if(ctx.state==='suspended')ctx.resume();
  const now=ctx.currentTime;
  if(type==='tap'){
    const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.setValueAtTime(800,now);o.frequency.linearRampToValueAtTime(600,now+0.03);g.gain.setValueAtTime(0.06,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.03);o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.03);
  } else if(type==='success'){
    [880,1175].forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.08,now+i*0.12);g.gain.exponentialRampToValueAtTime(0.001,now+i*0.12+0.15);o.connect(g);g.connect(ctx.destination);o.start(now+i*0.12);o.stop(now+i*0.12+0.15)});
  } else if(type==='pop'){
    const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.setValueAtTime(600,now);o.frequency.linearRampToValueAtTime(200,now+0.06);g.gain.setValueAtTime(0.07,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.06);o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.06);
  } else if(type==='swoosh'){
    const bufLen=ctx.sampleRate*0.12;const buf=ctx.createBuffer(1,bufLen,ctx.sampleRate);const d=buf.getChannelData(0);for(let i=0;i<bufLen;i++)d[i]=(Math.random()*2-1);
    const src=ctx.createBufferSource();src.buffer=buf;const f=ctx.createBiquadFilter();f.type='bandpass';f.frequency.setValueAtTime(2000,now);f.frequency.linearRampToValueAtTime(500,now+0.12);f.Q.value=2;const g=ctx.createGain();g.gain.setValueAtTime(0.05,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.12);src.connect(f);f.connect(g);g.connect(ctx.destination);src.start(now);src.stop(now+0.12);
  }
}catch{}};

/* Tap position tracker for .btn-primary glow */
document.addEventListener('pointerdown',e=>{const b=e.target.closest('.btn-primary');if(b){const r=b.getBoundingClientRect();b.style.setProperty('--tap-x',e.clientX-r.left+'px');b.style.setProperty('--tap-y',e.clientY-r.top+'px')}});

/* ==================== IMAGE COMPRESSION ==================== */
const compress=(file,maxW=800)=>new Promise(res=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(w>maxW){h=(h*maxW)/w;w=maxW}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',0.7))};img.src=e.target.result};rd.readAsDataURL(file)});
const compressForStorage=(base64,maxW=400)=>new Promise(res=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(w>maxW){h=(h*maxW)/w;w=maxW}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',0.5))};img.src=base64});

/* ==================== NUTRISCORE ==================== */
function calculateNutriScore(meal, profile) {
  let score = 50;
  const cals = meal.calories || 0;
  const protein = meal.protein || 0;
  const fiber = meal.fiber || 0;
  const sugar = meal.sugar || 0;
  const sodium = meal.sodium || 0;
  const fat = meal.fat || 0;
  // Positive
  if (protein > 0 && cals > 0) score += Math.min(15, (protein / (cals / 100)) * 5);
  if (fiber >= 5) score += 10; else if (fiber >= 3) score += 5;
  if ((meal.potassium || 0) > 200) score += 3;
  if ((meal.calcium || 0) > 100) score += 3;
  if ((meal.magnesium || 0) > 30) score += 3;
  // Negative
  if (sugar > 20) score -= 15; else if (sugar > 12) score -= 8; else if (sugar > 6) score -= 3;
  if (sodium > 800) score -= 12; else if (sodium > 400) score -= 6;
  if (fat > 30) score -= 10; else if (fat > 20) score -= 5;
  if (cals > 800) score -= 10; else if (cals > 600) score -= 5;
  // Goal modifier
  if (profile) {
    if (profile.goal === 'muscle_building' && protein > 30) score += 8;
    if (profile.goal === 'weight_loss' && cals < 400) score += 8;
    if (profile.goal === 'general_health' && fiber >= 5 && (meal.potassium||0) > 200) score += 5;
  }
  score = Math.max(0, Math.min(100, Math.round(score)));
  let grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : score >= 20 ? 'D' : 'E';
  let reason = grade === 'A' ? 'Excellent nutritional balance' : grade === 'B' ? 'Good nutritional profile' : grade === 'C' ? 'Average - room for improvement' : grade === 'D' ? 'Below average nutrition' : 'Poor nutritional value';
  if (profile?.goal === 'muscle_building' && protein > 30) reason += '. High protein supports your muscle building goal';
  if (profile?.goal === 'weight_loss' && cals < 400) reason += '. Low calorie density supports your weight loss goal';
  return { grade, score, reason };
}
const NUTRISCORE_COLORS = {A:'#22C55E',B:'#84CC16',C:'#F59E0B',D:'#F97316',E:'#EF4444'};

/* ==================== CALC TARGETS ==================== */
function calcTargets(p) {
  const w = p.weight || 70, h = p.height || 170, a = p.age || 25;
  const bmr = p.gender === 'female' ? 10*w + 6.25*h - 5*a - 161 : 10*w + 6.25*h - 5*a + 5;
  const tdee = bmr * (ACT_MULT[p.activityLevel] || 1.55);
  const calTarget = Math.round(tdee + (GOAL_CAL_ADJ[p.goal] || 0));
  const proteinTarget = Math.round(w * (PROTEIN_MULT[p.goal] || 1.5));
  const proteinCals = proteinTarget * 4;
  const remainCals = calTarget - proteinCals;
  const carbTarget = Math.round((remainCals * 0.55) / 4);
  const fatTarget = Math.round((remainCals * 0.45) / 9);
  return { bmr: Math.round(bmr), tdee: Math.round(tdee), calories: calTarget, protein: proteinTarget, carbs: carbTarget, fat: fatTarget, fiber: 25, sugar: 50, water: 2000 };
}

/* ==================== PROGRESS RING ==================== */
const ProgressRing=({pct,size=80,stroke=8,color='#10b981',trackColor,children})=>{
  const r=(size-stroke)/2, c=2*Math.PI*r;
  const offset=c-Math.min(pct||0,100)/100*c;
  return React.createElement('div',{style:{position:'relative',width:size,height:size}},
    React.createElement('svg',{width:size,height:size,className:'progress-ring'},
      React.createElement('circle',{cx:size/2,cy:size/2,r,fill:'none',stroke:trackColor||'var(--ring-bg)',strokeWidth:stroke}),
      React.createElement('circle',{cx:size/2,cy:size/2,r,fill:'none',stroke:color,strokeWidth:stroke,strokeDasharray:c,strokeDashoffset:offset,strokeLinecap:'round',style:{'--ring-full':c,'--ring-target':offset}})
    ),
    React.createElement('div',{style:{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}},children)
  );
};

/* ==================== SPARKLINE ==================== */
const Sparkline=({data,width=120,height=40,color='#A78BFA'})=>{
  if(!data||data.length<2) return null;
  const min=Math.min(...data), max=Math.max(...data), range=max-min||1;
  const pts=data.map((v,i)=>`${(i/(data.length-1))*width},${height-((v-min)/range)*height*0.8-height*0.1}`).join(' ');
  return React.createElement('svg',{width,height,className:'sparkline',style:{display:'block'}},
    React.createElement('polyline',{points:pts,fill:'none',stroke:color,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'})
  );
};

/* ==================== MAIN APP ==================== */
function App(){
const [profile, setProfile] = useState(null);
const [meals, setMeals] = useState([]);
const [hist, setHist] = useState([]);
const [weights, setWeights] = useState([]);
const [api, setApi] = useState('');
const [tab, setTab] = useState('home');
const [modal, setModal] = useState(null);
const [pending, setPending] = useState(null);
const [loading, setLoading] = useState(false);
const [foodPhoto, setFoodPhoto] = useState(null);
const [toast, setToast] = useState(null);
const [lightMode, setLightMode] = useState(false);
const [onboardStep, setOnboardStep] = useState(0);
const [onboardData, setOnboardData] = useState({goal:'',height:'',weight:'',age:'',gender:'male',unitSystem:'metric',heightFt:'',heightIn:'',activityLevel:'',dietaryPreference:'',allergies:[],mealSlots:['Breakfast','Lunch','Dinner'],eatingPatterns:[],openToSupplements:null});
const [selDate, setSelDate] = useState(getD());
const [calMonth, setCalMonth] = useState(new Date());
const [calDay, setCalDay] = useState(null);
const [showTargets, setShowTargets] = useState(true);
const [expandNutrients, setExpandNutrients] = useState(false);
const [newWt, setNewWt] = useState('');
const [editingItem, setEditingItem] = useState(null);
const [editItemText, setEditItemText] = useState('');
const [editItemLoading, setEditItemLoading] = useState(false);
const [editItemSuggestion, setEditItemSuggestion] = useState(null);
const [addingItem, setAddingItem] = useState(false);
const [addItemText, setAddItemText] = useState('');
const [addItemSuggestion, setAddItemSuggestion] = useState(null);
const [voiceRecording, setVoiceRecording] = useState(false);
const [voiceTranscript, setVoiceTranscript] = useState('');
const [voiceProcessing, setVoiceProcessing] = useState(false);
const [voiceFallback, setVoiceFallback] = useState(false);
const [voiceFallbackText, setVoiceFallbackText] = useState('');
const [barcodeScanning, setBarcodeScanning] = useState(false);
const [barcodeError, setBarcodeError] = useState('');
const [pendingMealSlot, setPendingMealSlot] = useState('');
const [expandNutriScore, setExpandNutriScore] = useState(false);
const [manualEntry, setManualEntry] = useState({name:'',calories:'',protein:'',carbs:'',fat:''});
const [weightView, setWeightView] = useState(null);
/* AI Chat state */
const [chatMessages, setChatMessages] = useState([]);
const [chatInput, setChatInput] = useState('');
const [chatLoading, setChatLoading] = useState(false);
const [chatStarted, setChatStarted] = useState(false);
/* Diet Plan state */
const [selectedFoods, setSelectedFoods] = useState([]);
const [dietPlan, setDietPlan] = useState(null);
const [dietPlanLoading, setDietPlanLoading] = useState(false);
const [dietPlanTab, setDietPlanTab] = useState('plan');
const [groceryChecked, setGroceryChecked] = useState({});
const [expandedMealOption, setExpandedMealOption] = useState(null);
const [fabOpen, setFabOpen] = useState(false);
/* Settings state */
const [showGuide, setShowGuide] = useState(false);
const barcodeVideoRef = useRef(null);
const barcodeStreamRef = useRef(null);
const voiceTranscriptRef = useRef('');
const photoRef = useRef(null);
const galleryRef = useRef(null);
const chatEndRef = useRef(null);

/* ---- Load data ---- */
useEffect(()=>{
  const p = JSON.parse(st.get('nt_profile')||'null');
  const m = JSON.parse(st.get('nt_meals')||'[]');
  const h = JSON.parse(st.get('nt_hist')||'[]');
  const w = JSON.parse(st.get('nt_weights')||'[]');
  const a = st.get('nt_api')||'';
  const lm = st.get('nt_light')==='true';
  const sf = JSON.parse(st.get('nt_foods')||'[]');
  const dp = JSON.parse(st.get('nt_dietplan')||'null');
  if(p) setProfile(p);
  setMeals(m); setHist(h); setWeights(w); setApi(a); setLightMode(lm);
  if(sf.length) setSelectedFoods(sf);
  if(dp) setDietPlan(dp);
  if(lm) document.documentElement.classList.add('light');
  // Day rollover
  if(p && p.lastDate && p.lastDate !== getD() && m.length > 0){
    const newHist = [...h, {date: p.lastDate, meals: m}].slice(-90);
    const newStreak = m.length > 0 ? (p.currentStreak||0)+1 : 0;
    const np = {...p, lastDate: getD(), currentStreak: newStreak};
    st.set('nt_hist', JSON.stringify(newHist));
    st.set('nt_meals', '[]');
    st.set('nt_profile', JSON.stringify(np));
    setHist(newHist); setMeals([]); setProfile(np);
  } else if(p && !p.lastDate) {
    const np = {...p, lastDate: getD()};
    st.set('nt_profile', JSON.stringify(np));
    setProfile(np);
  }
},[]);

/* ---- Modal sound ---- */
useEffect(()=>{if(modal)playSound('swoosh')},[modal]);

/* ---- Chat auto-scroll ---- */
useEffect(()=>{chatEndRef.current?.scrollIntoView({behavior:'smooth'})},[chatMessages,chatLoading]);

/* ---- Save helpers ---- */
const saveProfile=(p)=>{setProfile(p);st.set('nt_profile',JSON.stringify(p))};
const saveMeals=(m)=>{setMeals(m);st.set('nt_meals',JSON.stringify(m))};
const saveHist=(h)=>{setHist(h);st.set('nt_hist',JSON.stringify(h))};
const saveWeights=(w)=>{setWeights(w);st.set('nt_weights',JSON.stringify(w))};

/* ---- Toast ---- */
const showToast=(msg,icon='â„¹ï¸')=>{setToast({msg,icon});setTimeout(()=>setToast(null),3000)};

/* ---- Targets / totals ---- */
const tgt = profile ? calcTargets(profile) : {calories:2000,protein:150,carbs:250,fat:70,fiber:25,sugar:50,water:2000};
const todayMeals = selDate===getD() ? meals : (hist.find(h=>h.date===selDate)||{}).meals||[];
const tot = todayMeals.reduce((a,m)=>{Object.keys(EMPTY).forEach(k=>a[k]+=(m[k]||0));return a},{...EMPTY});

/* ---- Streak ---- */
const streak = profile?.currentStreak || 0;

/* ---- Toggle light mode ---- */
const toggleLight=()=>{haptic('light');const v=!lightMode;setLightMode(v);st.set('nt_light',v?'true':'false');if(v)document.documentElement.classList.add('light');else document.documentElement.classList.remove('light')};

/* ==================== AI PROMPTS (Powered by onboarding) ==================== */
const buildUserContext=()=>{
  if(!profile) return '';
  let ctx = `\nUser profile for personalized analysis:`;
  ctx += `\n- Goal: ${(profile.goal||'').replace('_',' ')}`;
  ctx += `\n- Age: ${profile.age}, Gender: ${profile.gender}`;
  ctx += `\n- Weight: ${profile.weight}kg, Height: ${profile.height}cm`;
  ctx += `\n- Activity: ${(profile.activityLevel||'').replace('_',' ')}`;
  ctx += `\n- Diet: ${profile.dietaryPreference||'omnivore'}`;
  if(profile.allergies?.length && !profile.allergies.includes('none')) ctx += `\n- Allergies/restrictions: ${profile.allergies.join(', ')} â€” FLAG any items containing these!`;
  if(profile.eatingPatterns?.length && !profile.eatingPatterns.includes('none')) ctx += `\n- Eating patterns: ${profile.eatingPatterns.join(', ')}`;
  ctx += `\n- Open to supplements: ${profile.openToSupplements?'Yes':'No'}`;
  ctx += `\n- Daily targets: ${tgt.calories} cal, ${tgt.protein}g protein, ${tgt.carbs}g carbs, ${tgt.fat}g fat`;
  return ctx;
};

const is429=(err)=>err&&(String(err.message||err).includes('429')||String(err.message||err).toLowerCase().includes('resource exhausted'));

/* ---- Photo scan ---- */
const handlePhoto=async(e)=>{
  const file=e.target.files?.[0];if(!file)return;
  if(!api){showToast('Set API key in Settings','âš ï¸');return}
  setModal(null);setLoading(true);
  try{
    const imgData=await compress(file);setFoodPhoto(imgData);
    const b64=imgData.split(',')[1];
    const userCtx=buildUserContext();
    const prompt=`Expert nutritionist: analyze this food photo carefully. Estimate the actual visible portion size â€” use visual cues like plate size, utensil scale, and food depth. Do NOT default to generic serving sizes.${userCtx}

Return ONLY valid JSON: {"items":[{"name":"food name","emoji":"ðŸ•","quantity":"150g","calories":250,"protein":20,"carbs":30,"fat":10,"fiber":3,"sugar":5,"sodium":400,"potassium":200,"calcium":40,"magnesium":15}],"totals":{same fields without name/emoji/quantity},"allergenWarnings":["list any detected allergens from user restrictions"]}`;
    const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt},{inlineData:{mimeType:'image/jpeg',data:b64}}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});
    const d=await res.json();
    if(d.error){if(is429(d.error))showToast('Rate limited, try again in a minute','â³');else showToast('Error: '+(d.error.message||'Unknown'),'âŒ');setLoading(false);return}
    const txt=(d.candidates?.[0]?.content?.parts?.[0]?.text)||'';
    const s=txt.indexOf('{'),en=txt.lastIndexOf('}');
    if(s===-1){showToast('Could not parse response','âŒ');setLoading(false);return}
    const j=JSON.parse(txt.substring(s,en+1));
    if(!j.totals&&j.items){j.totals={};Object.keys(EMPTY).forEach(k=>j.totals[k]=j.items.reduce((a,i)=>a+(i[k]||0),0))}
    const photoDate=file.lastModified?new Date(file.lastModified):new Date();
    const ph=photoDate.getHours();
    const pSlot=ph>=5&&ph<11?'Breakfast':ph>=11&&ph<14?'Lunch':ph>=14&&ph<17?'Afternoon Snack':ph>=17&&ph<21?'Dinner':'Evening Snack';
    setPending({...j.totals,items:j.items||[],mealSlot:pSlot,time:getT(),date:getD(photoDate),allergenWarnings:j.allergenWarnings||[]});
    setPendingMealSlot(pSlot);
    setModal('confirm');
    if(j.allergenWarnings?.length) showToast('âš ï¸ Allergen detected: '+j.allergenWarnings.join(', '),'âš ï¸');
  }catch(err){if(is429(err))showToast('Rate limited','â³');else showToast('Error: '+err.message,'âŒ')}
  setLoading(false);
};

/* ---- Voice ---- */
const processVoiceMeal=async(transcript)=>{
  if(!api){showToast('Set API key in Settings','âš ï¸');return}
  setVoiceProcessing(true);
  try{
    const userCtx=buildUserContext();
    const prompt=`Expert nutritionist. The user described what they ate:\n"${transcript}"\n${userCtx}\n\nParse into individual food items with accurate USDA nutritional values. Return ONLY JSON:\n{"items":[{"name":"...","emoji":"ðŸ•","quantity":"...","calories":N,"protein":N,"carbs":N,"fat":N,"fiber":N,"sugar":N,"sodium":N,"potassium":N,"calcium":N,"magnesium":N}],"totals":{same fields},"allergenWarnings":[]}`;
    const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});
    const d=await res.json();
    if(d.error){showToast('Error: '+(d.error.message||'Unknown'),'âŒ');setVoiceProcessing(false);setVoiceRecording(false);return}
    const txt=(d.candidates?.[0]?.content?.parts?.[0]?.text)||'';
    const s=txt.indexOf('{'),en=txt.lastIndexOf('}');
    if(s===-1){showToast('Could not parse','âŒ');setVoiceProcessing(false);setVoiceRecording(false);return}
    const j=JSON.parse(txt.substring(s,en+1));
    if(!j.totals&&j.items){j.totals={};Object.keys(EMPTY).forEach(k=>j.totals[k]=j.items.reduce((a,i)=>a+(i[k]||0),0))}
    setPending({...j.totals,items:j.items||[],mealSlot:getMealSlot(),time:getT(),date:getD(),allergenWarnings:j.allergenWarnings||[]});
    setPendingMealSlot(getMealSlot());
    setVoiceRecording(false);setVoiceProcessing(false);setVoiceTranscript('');setModal('confirm');
  }catch(err){showToast('Error: '+err.message,'âŒ');setVoiceRecording(false);setVoiceProcessing(false)}
};

const startVoice=()=>{
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){setVoiceFallback(true);setVoiceRecording(true);return}
  const r=new SR();r.continuous=false;r.interimResults=true;r.lang='en-NZ';
  let final='';
  r.onresult=(e)=>{let interim='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)final+=e.results[i][0].transcript;else interim+=e.results[i][0].transcript}const t=final||interim;setVoiceTranscript(t);voiceTranscriptRef.current=t};
  r.onerror=(e)=>{if(e.error==='not-allowed'){showToast('Microphone access denied','ðŸŽ¤');setVoiceRecording(false)}};
  window._sr=r;r.start();setVoiceRecording(true);setVoiceTranscript('');voiceTranscriptRef.current='';setVoiceFallback(false);
};
const stopVoice=()=>{if(window._sr)try{window._sr.stop()}catch(e){}setVoiceRecording(false)};
const handleVoiceDone=()=>{if(window._sr)try{window._sr.stop()}catch(e){}window._sr=null;const text=voiceFallback?voiceFallbackText:voiceTranscriptRef.current;if(text?.trim())processVoiceMeal(text.trim());else setVoiceRecording(false)};

/* ---- AI item cleanup ---- */
const aiCleanupItem=async(text,addMode=false)=>{
  if(!api){showToast('Set API key in Settings','âš ï¸');return}
  setEditItemLoading(true);
  try{
    const userCtx=buildUserContext();
    const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`Expert nutritionist. User typed: '${text}'.${userCtx}\nReturn accurate USDA nutritional values. Return ONLY JSON: {"name":"cleaned name","emoji":"ðŸ•","quantity":"amount","calories":N,"protein":N,"carbs":N,"fat":N,"fiber":N,"sugar":N,"sodium":N,"potassium":N,"calcium":N,"magnesium":N}`}]}],generationConfig:{temperature:0.3,maxOutputTokens:1024}})});
    const d=await res.json();
    if(d.error){showToast('Error','âŒ');setEditItemLoading(false);return}
    const txt=(d.candidates?.[0]?.content?.parts?.[0]?.text)||'';
    const s=txt.indexOf('{'),en=txt.lastIndexOf('}');
    if(s!==-1){const parsed=JSON.parse(txt.substring(s,en+1));if(addMode)setAddItemSuggestion(parsed);else setEditItemSuggestion(parsed)}
  }catch(err){showToast('Error: '+err.message,'âŒ')}
  setEditItemLoading(false);
};

/* ---- Barcode ---- */
const stopBarcode=()=>{if(barcodeStreamRef.current){barcodeStreamRef.current.getTracks().forEach(t=>t.stop());barcodeStreamRef.current=null}setBarcodeScanning(false)};

const lookupBarcode=async(code)=>{
  stopBarcode();setLoading(true);setBarcodeError('');
  try{
    const offRes=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const off=await offRes.json();
    if(off.status===1&&off.product){
      const p=off.product,n=p.nutriments||{};
      const item={name:(p.brands?`${p.product_name} (${p.brands})`:p.product_name)||'Unknown',emoji:'ðŸ“¦',quantity:p.serving_size||'1 serving',
        calories:Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0),protein:r2(n.proteins_serving||n.proteins_100g||0),carbs:r2(n.carbohydrates_serving||n.carbohydrates_100g||0),fat:r2(n.fat_serving||n.fat_100g||0),fiber:r2(n.fiber_serving||n.fiber_100g||0),sugar:r2(n.sugars_serving||n.sugars_100g||0),sodium:Math.round((n.sodium_serving||n.sodium_100g||0)*1000),potassium:Math.round(n.potassium_serving||n.potassium_100g||0),calcium:r2(n.calcium_serving||n.calcium_100g||0),magnesium:r2(n.magnesium_serving||n.magnesium_100g||0)};
      const totals={...item};delete totals.name;delete totals.emoji;delete totals.quantity;
      setPending({...totals,items:[item],mealSlot:getMealSlot(),time:getT(),date:getD(),allergenWarnings:[]});
      setPendingMealSlot(getMealSlot());setModal('confirm');setLoading(false);return;
    }
    const usdaRes=await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${code}&pageSize=1&api_key=DEMO_KEY`);
    const usda=await usdaRes.json();
    if(usda.foods?.length>0){
      const f=usda.foods[0];const gn=(id)=>{const n=f.foodNutrients?.find(x=>x.nutrientId===id);return n?n.value:0};
      const item={name:f.description||'Unknown',emoji:'ðŸ“¦',quantity:f.servingSize?`${f.servingSize}${f.servingSizeUnit||'g'}`:'100g',
        calories:Math.round(gn(1008)),protein:r2(gn(1003)),carbs:r2(gn(1005)),fat:r2(gn(1004)),fiber:r2(gn(1079)),sugar:r2(gn(2000)),sodium:Math.round(gn(1093)),potassium:Math.round(gn(1092)),calcium:r2(gn(1087)),magnesium:r2(gn(1090))};
      const totals={...item};delete totals.name;delete totals.emoji;delete totals.quantity;
      setPending({...totals,items:[item],mealSlot:getMealSlot(),time:getT(),date:getD(),allergenWarnings:[]});
      setPendingMealSlot(getMealSlot());setModal('confirm');setLoading(false);return;
    }
    setBarcodeError('Product not found');setModal('barcode');
  }catch(err){setBarcodeError('Lookup failed: '+err.message);setModal('barcode')}
  setLoading(false);
};

const startBarcode=async()=>{
  setBarcodeError('');setModal('barcode');setBarcodeScanning(true);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    barcodeStreamRef.current=stream;
    setTimeout(()=>{
      const video=barcodeVideoRef.current;if(!video){stopBarcode();return}
      video.srcObject=stream;video.play();
      if('BarcodeDetector' in window){
        const detector=new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e']});
        const scan=async()=>{if(!barcodeStreamRef.current)return;try{const codes=await detector.detect(video);if(codes.length>0){lookupBarcode(codes[0].rawValue);return}}catch(e){}requestAnimationFrame(scan)};
        requestAnimationFrame(scan);
      }
    },500);
  }catch(e){setBarcodeError('Camera access denied');setBarcodeScanning(false)}
};

/* ---- Meal management ---- */
const recalcPending=(items)=>{const totals={};Object.keys(EMPTY).forEach(k=>totals[k]=items.reduce((a,i)=>a+(i[k]||0),0));setPending(p=>({...totals,items,mealSlot:p.mealSlot,time:p.time,date:p.date,allergenWarnings:p.allergenWarnings}))};
const removeIngredient=(idx)=>{const items=[...(pending.items||[])];items.splice(idx,1);recalcPending(items)};
const replaceIngredient=(idx,item)=>{const items=[...(pending.items||[])];items[idx]=item;recalcPending(items);setEditingItem(null);setEditItemText('');setEditItemSuggestion(null)};
const appendIngredient=(item)=>{const items=[...(pending.items||[]),item];recalcPending(items);setAddingItem(false);setAddItemText('');setAddItemSuggestion(null)};

const addMeal=async(mealData,photo)=>{
  const ns = calculateNutriScore(mealData, profile);
  const meal={...mealData,id:Date.now(),nutriScore:ns.grade,nutriScoreVal:ns.score,nutriScoreReason:ns.reason,mealSlot:pendingMealSlot||getMealSlot()};
  if(photo&&getStorageUsage()<STORAGE_LIMIT){try{meal.photo=await compressForStorage(photo)}catch{}}
  const mealDate=meal.date||getD();delete meal.date;
  if(mealDate!==getD()){
    const hi=hist.findIndex(h=>h.date===mealDate);
    const newHist=[...hist];
    if(hi>=0){newHist[hi]={...newHist[hi],meals:[...newHist[hi].meals,meal]}}
    else{newHist.push({date:mealDate,meals:[meal]})}
    saveHist(newHist);
  } else {
    saveMeals([...meals,meal]);
  }
  setModal(null);setPending(null);setFoodPhoto(null);
  haptic('success');playSound('success');showToast('Meal logged!','âœ…');
  /* Brief vibration pattern for extra satisfaction */
  setTimeout(()=>haptic('light'),200);
};

const deleteMeal=(id,date)=>{haptic('error');if(!date||date===getD()){saveMeals(meals.filter(m=>m.id!==id))}else{const newHist=hist.map(h=>h.date===date?{...h,meals:h.meals.filter(m=>m.id!==id)}:h).filter(h=>h.meals.length>0);saveHist(newHist)}showToast('Meal removed','ðŸ—‘ï¸')};

/* ---- Share Meal Image ---- */
const shareMealImage=async(meal,photoSrc)=>{
  if(!photoSrc){showToast('No photo to share','ðŸ“·');return}
  try{
    const img=new Image();img.crossOrigin='anonymous';
    await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=photoSrc});
    const W=img.naturalWidth||720;const H=img.naturalHeight||720;
    const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,W,H);
    /* Dark gradient bar at bottom */
    const barH=H*0.18;
    const grad=ctx.createLinearGradient(0,H-barH*1.5,0,H);
    grad.addColorStop(0,'rgba(0,0,0,0)');grad.addColorStop(0.4,'rgba(0,0,0,0.7)');grad.addColorStop(1,'rgba(0,0,0,0.85)');
    ctx.fillStyle=grad;ctx.fillRect(0,H-barH*1.5,W,barH*1.5);
    /* Meal name */
    const name=(meal.items?.map(i=>i.name).join(', ')||'Meal').slice(0,40);
    const nameFontSize=Math.max(16,Math.round(W*0.04));
    ctx.font=`600 ${nameFontSize}px -apple-system,BlinkMacSystemFont,sans-serif`;
    ctx.fillStyle='#ffffff';ctx.textAlign='left';
    ctx.fillText(name,W*0.05,H-barH*0.65);
    /* Macro pills */
    const macros=[
      {label:'Cal',value:Math.round(meal.calories||0),color:'#2DD4BF'},
      {label:'Pro',value:Math.round(meal.protein||0)+'g',color:'#ffffff'},
      {label:'Carbs',value:Math.round(meal.carbs||0)+'g',color:'#3B82F6'},
      {label:'Fat',value:Math.round(meal.fat||0)+'g',color:'#60A5FA'}
    ];
    const pillFontSize=Math.max(12,Math.round(W*0.03));
    const pillGap=W*0.04;const startX=W*0.05;const pillY=H-barH*0.25;
    ctx.font=`700 ${pillFontSize}px -apple-system,BlinkMacSystemFont,sans-serif`;
    let px=startX;
    macros.forEach(m=>{
      ctx.fillStyle=m.color;ctx.textAlign='left';
      ctx.fillText(m.value,px,pillY);
      const valW=ctx.measureText(m.value).width;
      ctx.fillStyle='rgba(255,255,255,0.5)';
      ctx.font=`400 ${Math.round(pillFontSize*0.85)}px -apple-system,BlinkMacSystemFont,sans-serif`;
      ctx.fillText(' '+m.label,px+valW,pillY);
      px+=valW+ctx.measureText(' '+m.label).width+pillGap;
      ctx.font=`700 ${pillFontSize}px -apple-system,BlinkMacSystemFont,sans-serif`;
    });
    /* Branding */
    const brandFontSize=Math.max(10,Math.round(W*0.025));
    ctx.font=`600 ${brandFontSize}px -apple-system,BlinkMacSystemFont,sans-serif`;
    ctx.fillStyle='rgba(255,255,255,0.4)';ctx.textAlign='right';
    ctx.fillText('Macrely',W*0.95,H-barH*0.25);
    /* Export and share */
    const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.92));
    const file=new File([blob],'macrely-meal.jpg',{type:'image/jpeg'});
    if(navigator.canShare?.({files:[file]})){
      await navigator.share({files:[file],title:name,text:`${name} â€” ${Math.round(meal.calories||0)} cal | ${Math.round(meal.protein||0)}g protein`});
    }else{
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='macrely-meal.jpg';a.click();URL.revokeObjectURL(url);
      showToast('Image saved!','ðŸ“¥');
    }
  }catch(err){if(err.name!=='AbortError')showToast('Share failed','âŒ')}
};

/* ---- Weight ---- */
const addWeight=()=>{
  const w=parseFloat(newWt);if(!w||w<20||w>500)return;
  const entry={date:getD(),weight:profile?.unitSystem==='imperial'?r2(w/2.205):w};
  const nw=[...weights.filter(x=>x.date!==getD()),entry];
  saveWeights(nw);
  if(profile){const np={...profile,weight:entry.weight};saveProfile(np)}
  setNewWt('');setModal(null);haptic('success');playSound('success');showToast('Weight logged','âš–ï¸');
};

/* ---- Weekly insights ---- */
const getInsights=()=>{
  const last7=hist.slice(-7);
  if(last7.length<3) return [{icon:'ðŸ’¡',text:'Log meals for 3+ days to unlock personalized insights'},{icon:'ðŸŽ¯',text:`Your daily target: ${tgt.calories} calories, ${tgt.protein}g protein`}];
  const insights=[];
  const avgProtein=last7.reduce((a,d)=>a+d.meals.reduce((b,m)=>b+(m.protein||0),0),0)/last7.length;
  const pctOfTarget=Math.round((avgProtein/tgt.protein)*100);
  insights.push({icon:'ðŸ’ª',text:`Avg protein: ${Math.round(avgProtein)}g/day (${pctOfTarget}% of ${tgt.protein}g target)`});
  const avgCals=last7.reduce((a,d)=>a+d.meals.reduce((b,m)=>b+(m.calories||0),0),0)/last7.length;
  insights.push({icon:'ðŸ”¥',text:`Avg calories: ${Math.round(avgCals)}/day vs ${tgt.calories} target`});
  const daysWithBreakfast=last7.filter(d=>d.meals.some(m=>m.mealSlot==='Breakfast')).length;
  if(daysWithBreakfast>0) insights.push({icon:'ðŸ¥£',text:`Breakfast logged ${daysWithBreakfast}/${last7.length} days`});
  const avgFiber=last7.reduce((a,d)=>a+d.meals.reduce((b,m)=>b+(m.fiber||0),0),0)/last7.length;
  if(avgFiber<25) insights.push({icon:'ðŸ¥¦',text:`Fiber avg: ${Math.round(avgFiber)}g â€” aim for 25g+`});
  const scores=last7.flatMap(d=>d.meals.filter(m=>m.nutriScore).map(m=>m.nutriScore));
  if(scores.length>0){const best=scores.sort()[0];insights.push({icon:'ðŸ†',text:`Best NutriScore this week: ${best}`})}
  return insights.slice(0,4);
};

/* ==================== ONBOARDING ==================== */
const finishOnboarding=()=>{
  const w=onboardData.unitSystem==='imperial'?r2(parseFloat(onboardData.weight)/2.205):parseFloat(onboardData.weight);
  const h=onboardData.unitSystem==='imperial'?(parseFloat(onboardData.heightFt||0)*30.48)+(parseFloat(onboardData.heightIn||0)*2.54):parseFloat(onboardData.height);
  const p={...onboardData,weight:w,height:h,age:parseInt(onboardData.age),onboardingCompleted:true,lastDate:getD(),currentStreak:0};
  const t=calcTargets(p);
  Object.assign(p,{bmr:t.bmr,tdee:t.tdee,dailyCalorieTarget:t.calories,dailyProteinTarget:t.protein,dailyCarbTarget:t.carbs,dailyFatTarget:t.fat});
  saveProfile(p);saveWeights([{date:getD(),weight:w}]);
  setOnboardStep(9);
};

const onboardingValid=()=>{
  const d=onboardData;
  if(onboardStep===0) return !!d.goal;
  if(onboardStep===1) return d.unitSystem==='imperial'?(d.heightFt&&d.weight&&d.age):(d.height&&d.weight&&d.age);
  if(onboardStep===2) return !!d.activityLevel;
  if(onboardStep===3) return !!d.dietaryPreference;
  if(onboardStep===4) return d.allergies.length>0;
  if(onboardStep===5) return d.mealSlots.length>0;
  if(onboardStep===6) return d.eatingPatterns.length>0;
  if(onboardStep===7) return d.openToSupplements!==null;
  return true;
};

if(!profile || !profile.onboardingCompleted) {
  /* ---- ONBOARDING SCREENS ---- */
  const steps=['Goal','Body Stats','Activity','Diet','Allergies','Schedule','Patterns','Supplements','Complete'];

  const renderOnboardingStep=()=>{
    const d=onboardData;
    const upd=(k,v)=>setOnboardData({...d,[k]:v});

    if(onboardStep===9){
      /* Completion screen */
      const t=calcTargets({...d,weight:d.unitSystem==='imperial'?r2(parseFloat(d.weight)/2.205):parseFloat(d.weight),height:d.unitSystem==='imperial'?(parseFloat(d.heightFt||0)*30.48)+(parseFloat(d.heightIn||0)*2.54):parseFloat(d.height),age:parseInt(d.age)});
      return React.createElement('div',{style:{textAlign:'center',padding:'40px 20px'}},
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Your Targets'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:32}},'Personalized to your goals'),
        React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:16,flexWrap:'wrap',marginBottom:24}},
          React.createElement(ProgressRing,{pct:100,size:90,color:'#2DD4BF'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},t.calories),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Calories')),
          React.createElement(ProgressRing,{pct:100,size:90,color:'#fff'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},t.protein+'g'),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Protein')),
          React.createElement(ProgressRing,{pct:100,size:90,color:'#3B82F6'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},t.carbs+'g'),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Carbs'))
        ),
        React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:16,flexWrap:'wrap',marginBottom:40}},
          React.createElement(ProgressRing,{pct:100,size:90,color:'#60A5FA'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},t.fat+'g'),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Fat')),
          React.createElement(ProgressRing,{pct:100,size:90,color:'#22C55E'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},'25g'),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Fiber')),
          React.createElement(ProgressRing,{pct:100,size:90,color:'#06B6D4'},React.createElement('span',{style:{fontSize:18,fontWeight:700}},'2L'),React.createElement('span',{style:{fontSize:9,color:'var(--muted)'}},'Water'))
        ),
        React.createElement('button',{className:'btn btn-primary',onClick:()=>{finishOnboarding();setOnboardStep(0)},style:{marginTop:16}},"Let's Start Tracking")
      );
    }

    if(onboardStep===0){
      const goals=[{id:'weight_loss',emoji:'ðŸ”¥',title:'Weight Loss',desc:'Lose fat while preserving muscle'},{id:'muscle_building',emoji:'ðŸ’ª',title:'Muscle Building',desc:'Build lean muscle mass'},{id:'maintain',emoji:'âš–ï¸',title:'Maintain Weight',desc:'Stay at your current weight'},{id:'general_health',emoji:'ðŸŒ¿',title:'General Health',desc:'Improve overall wellbeing'}];
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'What\'s your goal?'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'This powers your personalized targets'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:12}},
          goals.map(g=>React.createElement('div',{key:g.id,className:`option-card${d.goal===g.id?' selected':''}`,onClick:()=>{haptic('medium');playSound('tap');upd('goal',g.id)}},
            React.createElement('span',{style:{fontSize:28}},g.emoji),
            React.createElement('div',null,React.createElement('div',{style:{fontWeight:600,fontSize:16}},g.title),React.createElement('div',{style:{fontSize:13,color:'var(--muted)'}},g.desc))
          ))
        )
      );
    }

    if(onboardStep===1){
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Body Stats'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'Used to calculate your BMR & TDEE'),
        React.createElement('div',{style:{display:'flex',gap:8,marginBottom:20}},
          ['metric','imperial'].map(u=>React.createElement('button',{key:u,className:'btn',style:{flex:1,background:d.unitSystem===u?'var(--primary)':'var(--card)',color:d.unitSystem===u?'#fff':'var(--text)',border:'1px solid var(--card-border)'},onClick:()=>upd('unitSystem',u)},u==='metric'?'Metric (kg/cm)':'Imperial (lbs/ft)'))
        ),
        d.unitSystem==='imperial'?
          React.createElement('div',{style:{display:'flex',gap:8,marginBottom:14}},
            React.createElement('div',{style:{flex:1}},React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},'Height (ft)'),React.createElement('input',{type:'number',value:d.heightFt,onChange:e=>upd('heightFt',e.target.value),placeholder:'5'})),
            React.createElement('div',{style:{flex:1}},React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},'Height (in)'),React.createElement('input',{type:'number',value:d.heightIn,onChange:e=>upd('heightIn',e.target.value),placeholder:'10'}))
          ):
          React.createElement('div',{style:{marginBottom:14}},React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},'Height (cm)'),React.createElement('input',{type:'number',value:d.height,onChange:e=>upd('height',e.target.value),placeholder:'170'})),
        React.createElement('div',{style:{marginBottom:14}},React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},`Weight (${d.unitSystem==='imperial'?'lbs':'kg'})`),React.createElement('input',{type:'number',value:d.weight,onChange:e=>upd('weight',e.target.value),placeholder:d.unitSystem==='imperial'?'165':'75'})),
        React.createElement('div',{style:{marginBottom:14}},React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},'Age'),React.createElement('input',{type:'number',value:d.age,onChange:e=>upd('age',e.target.value),placeholder:'25'})),
        React.createElement('div',null,React.createElement('label',{style:{fontSize:13,color:'var(--muted)',marginBottom:4,display:'block'}},'Gender'),
          React.createElement('div',{style:{display:'flex',gap:8}},
            ['male','female','other'].map(g=>React.createElement('button',{key:g,className:'btn',style:{flex:1,background:d.gender===g?'var(--primary)':'var(--card)',color:d.gender===g?'#fff':'var(--text)',border:'1px solid var(--card-border)',textTransform:'capitalize'},onClick:()=>upd('gender',g)},g))
          )
        ),
        React.createElement('div',{className:'card',style:{marginTop:20,background:'rgba(16,185,129,0.08)',border:'1px solid rgba(16,185,129,0.2)'}},
          React.createElement('p',{style:{fontSize:13,color:'var(--muted)'}},'ðŸ’¡ We use the Mifflin-St Jeor equation â€” the gold standard for estimating your metabolic rate.')
        )
      );
    }

    if(onboardStep===2){
      const levels=[{id:'sedentary',emoji:'ðŸª‘',title:'Sedentary',desc:'Desk job, little exercise',mult:'Ã—1.2'},{id:'light',emoji:'ðŸš¶',title:'Lightly Active',desc:'Light exercise 1-3 days/week',mult:'Ã—1.375'},{id:'moderate',emoji:'ðŸƒ',title:'Moderately Active',desc:'Moderate exercise 3-5 days/week',mult:'Ã—1.55'},{id:'very_active',emoji:'ðŸ‹ï¸',title:'Very Active',desc:'Hard exercise 6-7 days/week',mult:'Ã—1.725'},{id:'athlete',emoji:'ðŸ†',title:'Athlete',desc:'2Ã— daily training or physical job',mult:'Ã—1.9'}];
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Activity Level'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'Determines your calorie multiplier'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:10}},
          levels.map(l=>React.createElement('div',{key:l.id,className:`option-card${d.activityLevel===l.id?' selected':''}`,onClick:()=>{haptic('medium');playSound('tap');upd('activityLevel',l.id)}},
            React.createElement('span',{style:{fontSize:26}},l.emoji),
            React.createElement('div',{style:{flex:1}},React.createElement('div',{style:{fontWeight:600}},l.title),React.createElement('div',{style:{fontSize:12,color:'var(--muted)'}},l.desc)),
            React.createElement('span',{style:{fontSize:12,color:'var(--primary)',fontWeight:600}},l.mult)
          ))
        )
      );
    }

    if(onboardStep===3){
      const diets=[{id:'omnivore',emoji:'ðŸ¥©'},{id:'vegetarian',emoji:'ðŸ¥¬'},{id:'vegan',emoji:'ðŸŒ±'},{id:'pescatarian',emoji:'ðŸŸ'},{id:'keto',emoji:'ðŸ¥‘'},{id:'paleo',emoji:'ðŸ¦´'}];
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Dietary Preference'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'Helps AI contextualize your meals'),
        React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}},
          diets.map(dt=>React.createElement('div',{key:dt.id,className:`option-card${d.dietaryPreference===dt.id?' selected':''}`,onClick:()=>{haptic('medium');playSound('tap');upd('dietaryPreference',dt.id)},style:{flexDirection:'column',textAlign:'center',padding:20}},
            React.createElement('span',{style:{fontSize:32}},dt.emoji),
            React.createElement('div',{style:{fontWeight:600,textTransform:'capitalize',marginTop:4}},dt.id)
          ))
        )
      );
    }

    if(onboardStep===4){
      const allergens=['Gluten','Dairy','Nuts','Soy','Shellfish','Eggs','Lactose','None'];
      const toggle=(a)=>{
        if(a==='None') upd('allergies',['none']);
        else{let n=d.allergies.filter(x=>x!=='none');if(n.includes(a.toLowerCase()))n=n.filter(x=>x!==a.toLowerCase());else n.push(a.toLowerCase());upd('allergies',n)}
      };
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Allergies & Restrictions'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'AI will flag meals containing these'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:10}},
          allergens.map(a=>React.createElement('div',{key:a,className:`check-card${d.allergies.includes(a.toLowerCase())?' selected':''}`,onClick:()=>{haptic('light');playSound('tap');toggle(a)}},
            React.createElement('div',{className:'checkbox'},d.allergies.includes(a.toLowerCase())&&React.createElement('span',{style:{color:'#fff',fontSize:14}},'âœ“')),
            React.createElement('span',{style:{fontWeight:500}},a)
          ))
        )
      );
    }

    if(onboardStep===5){
      const slots=[{id:'Breakfast',emoji:'ðŸ¥£'},{id:'Mid-Morning Snack',emoji:'ðŸ§ˆ'},{id:'Lunch',emoji:'ðŸ±'},{id:'Afternoon Snack',emoji:'ðŸ'},{id:'Dinner',emoji:'ðŸ›'},{id:'Evening Snack',emoji:'ðŸ›ï¸'}];
      const toggle=(s)=>{let n=[...d.mealSlots];if(n.includes(s))n=n.filter(x=>x!==s);else n.push(s);upd('mealSlots',n)};
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Eating Schedule'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},'Which meals do you typically eat?'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:10}},
          slots.map(s=>React.createElement('div',{key:s.id,className:`check-card${d.mealSlots.includes(s.id)?' selected':''}`,onClick:()=>{haptic('light');playSound('tap');toggle(s.id)}},
            React.createElement('div',{className:'checkbox'},d.mealSlots.includes(s.id)&&React.createElement('span',{style:{color:'#fff',fontSize:14}},'âœ“')),
            React.createElement('span',{style:{fontSize:20,marginRight:4}},s.emoji),
            React.createElement('span',{style:{fontWeight:500}},s.id)
          ))
        )
      );
    }

    if(onboardStep===6){
      const patterns=['None','Snacking Tendencies','Cravings','Emotional Eating'];
      const toggle=(p)=>{
        if(p==='None') upd('eatingPatterns',['none']);
        else{let n=d.eatingPatterns.filter(x=>x!=='none');if(n.includes(p.toLowerCase()))n=n.filter(x=>x!==p.toLowerCase());else n.push(p.toLowerCase());upd('eatingPatterns',n)}
      };
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Your Eating Patterns'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:8}},'By your eating patterns, we can build strategies to manage cravings and promote healthier habits.'),
        React.createElement('p',{style:{color:'var(--primary)',fontSize:14,fontWeight:500,marginBottom:20}},'Food Habits'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:10}},
          patterns.map(p=>React.createElement('div',{key:p,className:`check-card${d.eatingPatterns.includes(p.toLowerCase())?' selected':''}`,onClick:()=>{haptic('light');playSound('tap');toggle(p)}},
            React.createElement('div',{className:'checkbox'},d.eatingPatterns.includes(p.toLowerCase())&&React.createElement('span',{style:{color:'#fff',fontSize:14}},'âœ“')),
            React.createElement('span',{style:{fontWeight:500}},p)
          ))
        )
      );
    }

    if(onboardStep===7){
      return React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:28,fontWeight:700,marginBottom:8}},'Open to Nutritional Supplements?'),
        React.createElement('p',{style:{color:'var(--muted)',marginBottom:24}},"If you're willing to include supplements, we can address any nutritional gaps to enhance your overall health."),
        React.createElement('p',{style:{color:'var(--primary)',fontSize:14,fontWeight:500,marginBottom:16}},'Can you take Nutritional Supplements?'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:10}},
          [{id:true,label:'Yes'},{id:false,label:'No'}].map(opt=>React.createElement('div',{key:String(opt.id),className:`option-card${d.openToSupplements===opt.id?' selected':''}`,onClick:()=>{haptic('medium');playSound('tap');upd('openToSupplements',opt.id)},style:{justifyContent:'flex-start'}},
            React.createElement('div',{style:{width:22,height:22,borderRadius:'50%',border:d.openToSupplements===opt.id?'none':'2px solid var(--card-border)',background:d.openToSupplements===opt.id?'var(--primary)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}},d.openToSupplements===opt.id&&React.createElement('div',{style:{width:8,height:8,borderRadius:'50%',background:'#fff'}})),
            React.createElement('span',{style:{fontWeight:500,fontSize:16}},opt.label)
          ))
        ),
        React.createElement('div',{className:'card',style:{marginTop:24,background:'rgba(16,185,129,0.08)',border:'1px solid rgba(16,185,129,0.2)'}},
          React.createElement('p',{style:{fontSize:13,color:'var(--muted)'}},'Recommendations would be based on general goals. For personalized advice or health conditions, please consult a professional.')
        )
      );
    }

    return null;
  };

  return React.createElement('div',{className:'onboarding'},
    onboardStep<9&&React.createElement('div',{className:'step-dots'},steps.slice(0,8).map((_,i)=>React.createElement('div',{key:i,className:`step-dot${i===onboardStep?' active':''}`}))),
    React.createElement('div',{className:'onboarding-content'},renderOnboardingStep()),
    onboardStep<8&&React.createElement('div',{className:'onboarding-footer'},
      React.createElement('div',{style:{display:'flex',gap:12}},
        onboardStep>0&&React.createElement('button',{className:'btn btn-outline',onClick:()=>{haptic('light');playSound('tap');setOnboardStep(s=>s-1)},style:{padding:'16px 24px'}},'Back'),
        React.createElement('button',{className:'btn btn-primary',style:{opacity:onboardingValid()?1:0.4},onClick:()=>{if(!onboardingValid())return;haptic('medium');playSound('success');if(onboardStep===7){finishOnboarding()}else setOnboardStep(s=>s+1)}},onboardStep===7?'Calculate Targets':onboardStep===5?'Next: Eating Patterns':onboardStep===6?'Next: Supplements':'Next')
      )
    )
  );
}

/* ==================== MAIN APP (post-onboarding) ==================== */

/* ---- HOME TAB ---- */
const renderHome=()=>{
  const insights=getInsights();
  const todayWeight=weights.find(w=>w.date===getD());
  const last7Weights=weights.slice(-7).map(w=>w.weight);

  /* Build sorted list of dates with meals */
  const datesWithMeals=(()=>{
    const s=new Set(hist.filter(h=>h.meals?.length>0).map(h=>h.date));
    if(meals.length>0) s.add(getD());
    return [...s].sort();
  })();
  const navigateDay=(dir)=>{
    const idx=datesWithMeals.indexOf(selDate);
    if(dir===-1){
      if(idx>0) setSelDate(datesWithMeals[idx-1]);
      else if(idx===-1){const prev=datesWithMeals.filter(d=>d<selDate);if(prev.length)setSelDate(prev[prev.length-1])}
    }else{
      if(idx>=0&&idx<datesWithMeals.length-1) setSelDate(datesWithMeals[idx+1]);
      else if(idx===-1){const nxt=datesWithMeals.filter(d=>d>selDate);if(nxt.length)setSelDate(nxt[0])}
    }
  };
  const isToday=selDate===getD();
  const canGoNext=!isToday&&datesWithMeals.some(d=>d>selDate);
  const canGoPrev=datesWithMeals.some(d=>d<selDate);

  /* Format date for display */
  const formatDateHeader=(d)=>{
    if(d===getD()) return 'Today';
    const dt=new Date(d+'T12:00:00');
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return days[dt.getDay()]+', '+months[dt.getMonth()]+' '+dt.getDate();
  };

  return React.createElement('div',{className:'page-scroll'},
    /* Date header with navigation */
    React.createElement('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}},
      React.createElement('div',{style:{display:'flex',alignItems:'center',gap:8}},
        React.createElement('button',{style:{background:'none',border:'none',color:canGoPrev?'var(--text)':'var(--card-border)',fontSize:20,cursor:canGoPrev?'pointer':'default',padding:'4px 8px',lineHeight:1},onClick:()=>{if(canGoPrev){haptic('light');playSound('tap');navigateDay(-1)}}},'â€¹'),
        React.createElement('h2',{style:{fontSize:22,fontWeight:700,margin:0}},formatDateHeader(selDate)),
        React.createElement('button',{style:{background:'none',border:'none',color:canGoNext?'var(--text)':'var(--card-border)',fontSize:20,cursor:canGoNext?'pointer':'default',padding:'4px 8px',lineHeight:1,visibility:isToday?'hidden':'visible'},onClick:()=>{if(canGoNext){haptic('light');playSound('tap');navigateDay(1)}}},'â€º')
      ),
      !isToday&&React.createElement('button',{className:'btn btn-outline',style:{padding:'8px 16px',fontSize:13},onClick:()=>{haptic('light');playSound('tap');setSelDate(getD())}},'Today')
    ),

    /* Today's Counts */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
        React.createElement('h3',{style:{fontSize:16,fontWeight:600}},isToday?"Today's Counts":"Daily Counts"),
        React.createElement('button',{className:'btn btn-outline',style:{padding:'4px 12px',fontSize:11},onClick:()=>{haptic('light');setShowTargets(!showTargets)}},showTargets?'Hide Target':'Show Target')
      ),
      React.createElement('div',{className:'macro-ring-row'},
        [{label:'Calories',val:Math.round(tot.calories),target:tgt.calories,color:'#2DD4BF',unit:''},{label:'Protein',val:Math.round(tot.protein),target:tgt.protein,color:'#ffffff',unit:'g'},{label:'Carbs',val:Math.round(tot.carbs),target:tgt.carbs,color:'#3B82F6',unit:'g'},{label:'Fat',val:Math.round(tot.fat),target:tgt.fat,color:'#60A5FA',unit:'g'}].map((m,idx)=>
          React.createElement('div',{key:m.label,className:'macro-ring-enter',style:{textAlign:'center','--ri':idx}},
            React.createElement(ProgressRing,{pct:m.target?(m.val/m.target)*100:0,size:72,stroke:7,color:m.color},
              React.createElement('span',{style:{fontSize:14,fontWeight:700}},m.val),
              showTargets&&React.createElement('span',{style:{fontSize:8,color:'var(--muted)'}},'/'+m.target+m.unit)
            ),
            React.createElement('div',{style:{fontSize:11,color:'var(--muted)',marginTop:4}},m.label)
          )
        )
      )
    ),

    /* Meal Timeline */
    React.createElement('div',{style:{marginBottom:16}},
      React.createElement('h3',{className:'section-title'},'Meals'),
      todayMeals.length===0?
        React.createElement('div',{className:'card',style:{textAlign:'center',padding:32}},
          React.createElement('div',{style:{fontSize:48,marginBottom:12}},'ðŸ½ï¸'),
          React.createElement('p',{style:{color:'var(--muted)',fontSize:14}},isToday?'No meals logged today':'No meals logged this day'),
          React.createElement('p',{style:{color:'var(--muted)',fontSize:12,marginTop:4}},'Tap the camera or pencil to log a meal')
        ):
        todayMeals.map((m,i)=>{
          const ns=m.nutriScore?NUTRISCORE_COLORS[m.nutriScore]:null;
          return React.createElement('div',{key:m.id||i,className:'meal-timeline-item meal-card-stagger',style:{'--i':i},onClick:()=>{haptic('light');setModal({type:'mealDetail',meal:m,date:selDate})}},
            m.photo?React.createElement('img',{src:m.photo,className:'meal-photo-thumb',alt:''}):React.createElement('div',{className:'meal-photo-thumb',style:{display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},m.items?.[0]?.emoji||'ðŸ½ï¸'),
            React.createElement('div',{style:{flex:1,minWidth:0}},
              React.createElement('div',{style:{fontWeight:600,fontSize:14,marginBottom:2}},m.items?.map(i=>i.name).join(', ')||'Meal'),
              React.createElement('div',{style:{fontSize:12,color:'var(--muted)'}},m.mealSlot||'Meal',' Â· ',m.time||'')
            ),
            React.createElement('div',{style:{textAlign:'right',flexShrink:0}},
              React.createElement('div',{style:{fontWeight:600,fontSize:14}},Math.round(m.calories||0)+' cal'),
              m.nutriScore&&React.createElement('span',{style:{display:'inline-block',padding:'2px 8px',borderRadius:6,fontSize:11,fontWeight:700,color:'#fff',background:ns,marginTop:2}},m.nutriScore)
            )
          );
        })
    ),

    /* Report / Health Cards */
    React.createElement('div',{style:{marginBottom:16}},
      React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
        React.createElement('h3',{className:'section-title',style:{margin:0}},'Report'),
        React.createElement('span',{style:{fontSize:12,color:'var(--muted)'}},'Today')
      ),
      React.createElement('div',{className:'health-grid'},
        React.createElement('div',{className:'health-card',onClick:()=>setModal('weight'),style:{cursor:'pointer'}},
          React.createElement('h4',{style:{color:'var(--weight-color)'}},'Weight'),
          React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
            React.createElement('span',{style:{fontSize:22,fontWeight:700}},todayWeight?todayWeight.weight+(profile?.unitSystem==='imperial'?' lbs':' kg'):'--'),
            React.createElement('span',{style:{fontSize:12,color:'var(--primary)',cursor:'pointer'}},'+Add')
          ),
          last7Weights.length>1&&React.createElement(Sparkline,{data:last7Weights,color:'var(--weight-color)',width:100,height:30})
        ),
        React.createElement('div',{className:'health-card'},
          React.createElement('h4',{style:{color:'var(--energy-color)'}},'Active Energy'),
          React.createElement('div',{style:{fontSize:13,color:'var(--muted)',marginTop:8}},'Not Synced')
        ),
        React.createElement('div',{className:'health-card'},
          React.createElement('h4',{style:{color:'var(--steps-color)'}},'Steps'),
          React.createElement('div',{style:{fontSize:13,color:'var(--muted)',marginTop:8}},'Not Synced')
        ),
        React.createElement('div',{className:'health-card'},
          React.createElement('h4',{style:{color:'var(--sleep-color)'}},'Sleep'),
          React.createElement('div',{style:{fontSize:13,color:'var(--muted)',marginTop:8}},'Not Synced')
        )
      )
    ),

    /* Today's Total Count */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('h3',{style:{fontSize:16,fontWeight:600,marginBottom:12}},"Today's Total Count"),
      React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:8}},
        [{l:'Calories',v:Math.round(tot.calories),u:''},{l:'Protein',v:Math.round(tot.protein),u:'g'},{l:'Carbs',v:Math.round(tot.carbs),u:'g'},{l:'Fat',v:Math.round(tot.fat),u:'g'}].map(x=>
          React.createElement('div',{key:x.l,style:{textAlign:'center'}},
            React.createElement('div',{style:{fontSize:18,fontWeight:700}},x.v+x.u),
            React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l)
          )
        )
      ),
      React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,borderTop:'1px solid var(--card-border)',paddingTop:8}},
        [{l:'Fiber',v:r2(tot.fiber),u:'g'},{l:'Sugar',v:r2(tot.sugar),u:'g'},{l:'Potassium',v:Math.round(tot.potassium),u:'mg'},{l:'Calcium',v:Math.round(tot.calcium),u:'mg'}].map(x=>
          React.createElement('div',{key:x.l,style:{textAlign:'center'}},
            React.createElement('div',{style:{fontSize:14,fontWeight:600}},x.v+x.u),
            React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l)
          )
        )
      ),
      expandNutrients&&React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,borderTop:'1px solid var(--card-border)',paddingTop:8,marginTop:8}},
        [{l:'Sodium',v:Math.round(tot.sodium),u:'mg'},{l:'Magnesium',v:Math.round(tot.magnesium||0),u:'mg'}].map(x=>
          React.createElement('div',{key:x.l,style:{textAlign:'center'}},
            React.createElement('div',{style:{fontSize:14,fontWeight:600}},x.v+x.u),
            React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l)
          )
        )
      ),
      React.createElement('button',{onClick:()=>{haptic('light');setExpandNutrients(!expandNutrients)},style:{background:'none',border:'none',color:'#3B82F6',fontSize:13,fontWeight:500,cursor:'pointer',marginTop:8,padding:0}},expandNutrients?'Less â–²':'More Nutrients â–¼')
    ),

    /* Insights Row */
    React.createElement('div',{style:{marginBottom:16}},
      React.createElement('h3',{className:'section-title'},'Insights'),
      React.createElement('div',{className:'scroll-row'},
        /* Calendar card */
        React.createElement('div',{className:'insight-card',style:{minWidth:140,cursor:'pointer'},onClick:()=>setModal('calendar')},
          React.createElement('div',{style:{fontSize:13,fontWeight:600,marginBottom:8}},'ðŸ“… Calendar'),
          React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},'View meal history')
        ),
        /* Insights */
        insights.map((ins,i)=>React.createElement('div',{key:i,className:'insight-card'},
          React.createElement('div',{style:{fontSize:20,marginBottom:6}},ins.icon),
          React.createElement('div',{style:{fontSize:12,color:'var(--muted)'}},ins.text)
        )),
        /* Streak */
        React.createElement('div',{className:'insight-card'+(streak>0?' streak-glow':''),style:{minWidth:120}},
          React.createElement('div',{style:{fontSize:28}},streak>0?'ðŸ”¥':'â„ï¸'),
          React.createElement('div',{style:{fontSize:22,fontWeight:700}},streak),
          React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},'Day Streak')
        )
      )
    ),

    /* Tagline */
    React.createElement('div',{style:{textAlign:'center',padding:'16px 0',marginBottom:20}},
      React.createElement('p',{style:{fontSize:14,fontWeight:600,color:'var(--muted)'}},'Know What You Eat!')
    )
  );
};

/* ---- YOU / SETTINGS TAB ---- */
const renderYou=()=>{
  return React.createElement('div',{className:'page-scroll'},
    React.createElement('h2',{style:{fontSize:22,fontWeight:700,marginBottom:20}},'You'),

    /* Profile summary */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('div',{style:{display:'flex',alignItems:'center',gap:16,marginBottom:12}},
        React.createElement('div',{style:{width:56,height:56,borderRadius:'50%',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'ðŸ‘¤'),
        React.createElement('div',null,
          React.createElement('div',{style:{fontWeight:600,fontSize:16}},profile?.goal?.replace('_',' ')||''),
          React.createElement('div',{style:{fontSize:13,color:'var(--muted)'}},`${profile?.weight}kg Â· ${profile?.height}cm Â· ${profile?.age}y`)
        )
      ),
      React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}},
        [{l:'Calories',v:tgt.calories},{l:'Protein',v:tgt.protein+'g'},{l:'Carbs',v:tgt.carbs+'g'},{l:'Fat',v:tgt.fat+'g'}].map(x=>
          React.createElement('div',{key:x.l,style:{padding:8,background:'rgba(255,255,255,0.05)',borderRadius:8,textAlign:'center'}},
            React.createElement('div',{style:{fontSize:16,fontWeight:600}},x.v),
            React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},x.l)
          )
        )
      )
    ),

    /* How to Use Guide */
    React.createElement('div',{className:'card',style:{marginBottom:16,cursor:'pointer'},onClick:()=>setShowGuide(!showGuide)},
      React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
        React.createElement('h3',{style:{fontWeight:600}},'How to Use Macrely'),
        React.createElement('span',{style:{fontSize:16,color:'var(--muted)',transition:'transform 0.3s',transform:showGuide?'rotate(180deg)':'rotate(0deg)'}},showGuide?'â–²':'â–¼')
      ),
      showGuide&&React.createElement('div',{style:{marginTop:12,paddingTop:12,borderTop:'1px solid var(--card-border)'}},
        [
          'Complete onboarding to set your goals and dietary preferences',
          'Tap the camera button to scan meals with AI',
          'Use voice or manual entry to log what you eat',
          'Check your daily progress rings on the Home tab',
          'View your NutriScore grades to eat healthier',
          'Track your weight with the weight card',
          'Generate a personalized diet plan in the Diet Plan tab',
          'Chat with MacAI for personalized nutrition advice'
        ].map((step,i)=>React.createElement('div',{key:i,style:{display:'flex',gap:10,padding:'8px 0'}},
          React.createElement('span',{style:{fontSize:13,fontWeight:700,color:'var(--primary)',flexShrink:0,width:20}},i+1+'.'),
          React.createElement('span',{style:{fontSize:13,color:'var(--muted)',lineHeight:1.4}},step)
        ))
      )
    ),

    /* Quick links */
    React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:16}},
      React.createElement('div',{className:'card',style:{cursor:'pointer',textAlign:'center',padding:16},onClick:()=>setTab('nutribites')},
        React.createElement('div',{style:{fontSize:28,marginBottom:8}},'ðŸ¤–'),
        React.createElement('div',{style:{fontWeight:600,fontSize:14,marginBottom:4}},'MacAI'),
        React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},'Your AI nutritionist')
      ),
      React.createElement('div',{className:'card',style:{cursor:'pointer',textAlign:'center',padding:16},onClick:()=>setTab('diet')},
        React.createElement('div',{style:{fontSize:28,marginBottom:8}},'ðŸ“…'),
        React.createElement('div',{style:{fontWeight:600,fontSize:14,marginBottom:4}},'Diet Plan'),
        React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},'Create your meal plan')
      )
    ),

    /* API Key */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('h3',{style:{fontWeight:600,marginBottom:12}},'Gemini API Key'),
      React.createElement('input',{type:'password',value:api,onChange:e=>{setApi(e.target.value);st.set('nt_api',e.target.value)},placeholder:'Enter your Gemini API key',style:{marginBottom:8}}),
      React.createElement('p',{style:{fontSize:11,color:'var(--muted)'}},'Get a free key from Google AI Studio')
    ),

    /* Appearance */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('h3',{style:{fontWeight:600,marginBottom:12}},'Appearance'),
      React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
        React.createElement('span',null,'Light Mode'),
        React.createElement('button',{onClick:toggleLight,style:{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:lightMode?'var(--primary)':'#333',position:'relative',transition:'background 0.3s'}},
          React.createElement('div',{style:{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:lightMode?27:3,transition:'left 0.3s'}})
        )
      )
    ),

    /* Diet / Profile edit */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('h3',{style:{fontWeight:600,marginBottom:12}},'Profile'),
      React.createElement('button',{className:'btn',style:{width:'100%',background:'var(--card)',border:'1px solid var(--card-border)',color:'var(--text)',marginBottom:8},onClick:()=>{setOnboardData({...onboardData,...profile,weight:String(profile?.weight||''),height:String(profile?.height||''),age:String(profile?.age||'')});setOnboardStep(0);saveProfile({...profile,onboardingCompleted:false})}},'Redo Onboarding')
    ),

    /* Reset */
    React.createElement('div',{className:'card',style:{marginBottom:16}},
      React.createElement('h3',{style:{fontWeight:600,marginBottom:12}},'Data'),
      React.createElement('button',{className:'btn',style:{width:'100%',background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',color:'#EF4444'},onClick:()=>{if(confirm('Clear all data? This cannot be undone.')){haptic('error');localStorage.clear();location.reload()}}},'Clear All Data')
    ),

    React.createElement('p',{style:{textAlign:'center',fontSize:12,color:'var(--muted)',marginTop:16}},APP_NAME+' v'+APP_VERSION)
  );
};

/* ---- AI NUTRITIONIST CHAT ---- */
const buildMealHistoryContext=()=>{
  let ctx='\n\nRecent meal history for data-driven answers:';
  const todayM=meals;
  if(todayM.length>0){
    ctx+='\nToday ('+getD()+'):';
    todayM.forEach(m=>ctx+='\n  - '+m.mealSlot+': '+(m.items?.map(i=>i.name).join(', ')||'Meal')+' ('+Math.round(m.calories||0)+' cal, '+Math.round(m.protein||0)+'g protein, '+Math.round(m.carbs||0)+'g carbs, '+Math.round(m.fat||0)+'g fat)');
  }
  const last7=hist.slice(-7);
  last7.forEach(day=>{
    ctx+='\n'+day.date+':';
    day.meals.forEach(m=>ctx+='\n  - '+m.mealSlot+': '+(m.items?.map(i=>i.name).join(', ')||'Meal')+' ('+Math.round(m.calories||0)+' cal, '+Math.round(m.protein||0)+'g protein, '+Math.round(m.carbs||0)+'g carbs, '+Math.round(m.fat||0)+'g fat)');
  });
  if(todayM.length===0&&last7.length===0) ctx+='\nNo meals logged yet.';
  return ctx;
};

const sendChatMessage=async(text)=>{
  if(!text?.trim())return;
  if(!api){showToast('Set API key in Settings','âš ï¸');return}
  const userMsg={role:'user',text:text.trim()};
  setChatMessages(prev=>[...prev,userMsg]);
  setChatInput('');setChatLoading(true);
  try{
    const userCtx=buildUserContext();
    const mealCtx=buildMealHistoryContext();
    const systemPrompt='You are MacAI, the friendly AI nutritionist built into the Macrely app. You have access to the user\'s profile and meal history. Answer nutrition questions helpfully and concisely. Use the user\'s logged meal data to give specific, data-driven answers. Keep responses short and conversational (2-4 paragraphs max). Use simple formatting.'+userCtx+mealCtx;
    const contents=[{role:'user',parts:[{text:systemPrompt+'\n\nUser question: '+text.trim()}]}];
    const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents,generationConfig:{temperature:0.7,maxOutputTokens:1024}})});
    const d=await res.json();
    if(d.error){if(is429(d.error))showToast('Rate limited, try again in a minute','â³');else showToast('Error: '+(d.error.message||'Unknown'),'âŒ');setChatLoading(false);return}
    const reply=(d.candidates?.[0]?.content?.parts?.[0]?.text)||'Sorry, I couldn\'t generate a response.';
    setChatMessages(prev=>[...prev,{role:'ai',text:reply}]);
  }catch(err){showToast('Error: '+err.message,'âŒ')}
  setChatLoading(false);
};

const renderAIChat=()=>{
  const suggestedPrompts=[
    {cat:'food',text:'Last week\'s summary, please?'},
    {cat:'food',text:'How much protein this month?'},
    {cat:'food',text:'Which meal had most fat?'},
    {cat:'health',text:'Am I eating too many carbs?'},
    {cat:'food',text:'Average calorie intake last week?'},
    {cat:'health',text:'Which day had most calories?'}
  ];

  if(!chatStarted&&chatMessages.length===0){
    /* Welcome state */
    return React.createElement('div',{className:'page-scroll',style:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',minHeight:'70vh'}},
      React.createElement('div',{style:{width:80,height:80,borderRadius:'50%',background:'linear-gradient(135deg,#10b981,#3B82F6)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:36,marginBottom:24}},'ðŸ¤–'),
      React.createElement('h2',{style:{fontSize:24,fontWeight:700,marginBottom:8}},'MacAI'),
      React.createElement('p',{style:{color:'var(--muted)',textAlign:'center',maxWidth:280,marginBottom:32,fontSize:14}},'Your personal AI nutritionist. Get advice powered by your meals, goals & health data.'),
      React.createElement('button',{className:'btn btn-primary',style:{maxWidth:200},onClick:()=>setChatStarted(true)},'Chat with AI')
    );
  }

  /* Chat state */
  return React.createElement('div',{style:{display:'flex',flexDirection:'column',height:'100vh',paddingTop:'max(16px,env(safe-area-inset-top))'}},
    /* Header */
    React.createElement('div',{style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',borderBottom:'1px solid var(--card-border)'}},
      React.createElement('button',{style:{background:'none',border:'none',color:'var(--text)',fontSize:20,cursor:'pointer',padding:0},onClick:()=>{setChatStarted(false)}},'â†'),
      React.createElement('div',{style:{width:36,height:36,borderRadius:'50%',background:'linear-gradient(135deg,#10b981,#3B82F6)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18}},'ðŸ¤–'),
      React.createElement('h3',{style:{fontSize:16,fontWeight:600}},'MacAI')
    ),

    /* Messages area */
    React.createElement('div',{style:{flex:1,overflowY:'auto',padding:16,paddingBottom:8}},
      chatMessages.length===0&&React.createElement(React.Fragment,null,
        /* Suggested prompts */
        React.createElement('p',{style:{fontSize:13,color:'var(--muted)',marginBottom:12}},'Try asking:'),
        React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}},
          suggestedPrompts.map((p,i)=>React.createElement('button',{key:i,style:{background:'var(--card)',border:'1px solid var(--card-border)',borderRadius:12,padding:12,color:'var(--text)',fontSize:13,textAlign:'left',cursor:'pointer',fontFamily:'inherit'},onClick:()=>{setChatStarted(true);sendChatMessage(p.text)}},p.text))
        )
      ),
      chatMessages.map((msg,i)=>React.createElement('div',{key:i,style:{display:'flex',justifyContent:msg.role==='user'?'flex-end':'flex-start',marginBottom:12}},
        React.createElement('div',{style:{maxWidth:'85%',padding:'10px 14px',borderRadius:msg.role==='user'?'16px 16px 4px 16px':'16px 16px 16px 4px',background:msg.role==='user'?'var(--primary)':'var(--card)',border:msg.role==='ai'?'1px solid var(--card-border)':'none',color:msg.role==='user'?'#fff':'var(--text)',fontSize:14,lineHeight:1.5,whiteSpace:'pre-wrap'}},msg.text)
      )),
      chatLoading&&React.createElement('div',{style:{display:'flex',justifyContent:'flex-start',marginBottom:12}},
        React.createElement('div',{style:{padding:'10px 14px',borderRadius:'16px 16px 16px 4px',background:'var(--card)',border:'1px solid var(--card-border)',fontSize:14,color:'var(--muted)'}},'Thinking...')
      ),
      React.createElement('div',{ref:chatEndRef})
    ),

    /* Input bar */
    React.createElement('div',{style:{padding:'12px 16px',paddingBottom:'max(12px,env(safe-area-inset-bottom))',borderTop:'1px solid var(--card-border)',background:'var(--bg)',display:'flex',gap:8,alignItems:'center'}},
      React.createElement('input',{value:chatInput,onChange:e=>setChatInput(e.target.value),onKeyDown:e=>{if(e.key==='Enter'&&!e.shiftKey&&chatInput.trim()){e.preventDefault();sendChatMessage(chatInput)}},placeholder:'Ask about your nutrition...',style:{flex:1,padding:'10px 14px',borderRadius:20,fontSize:14}}),
      React.createElement('button',{style:{width:40,height:40,borderRadius:'50%',background:chatInput.trim()?'var(--primary)':'var(--card)',border:'none',color:chatInput.trim()?'#fff':'var(--muted)',fontSize:18,cursor:'pointer',flexShrink:0,display:'flex',alignItems:'center',justifyContent:'center'},onClick:()=>chatInput.trim()&&sendChatMessage(chatInput),disabled:chatLoading},'â†‘')
    )
  );
};

/* ---- DIET PLAN TAB ---- */
const FOOD_CATEGORIES={
  'Protein':['Chicken','Fish','Eggs','Beef','Turkey','Tofu','Shrimp','Pork','Lamb','Prawns'],
  'Grains':['Rice','Oats','Quinoa','Wheat','Barley','Corn','Pasta','Millet'],
  'Legumes':['Lentils','Chickpeas','Black beans','Kidney beans','Mung beans','Split peas','Bengal Gram'],
  'Vegetables':['Spinach','Broccoli','Carrots','Bell peppers','Tomatoes','Zucchini','Sweet potato','Cauliflower','Cucumber','Cabbage','Eggplant','Green beans','Capsicum'],
  'Fruits':['Apples','Bananas','Oranges','Strawberries','Blueberries','Avocado','Grapes','Pineapple','Papaya','Kiwi'],
  'Dairy':['Milk','Yogurt','Cheese','Butter','Paneer (Cottage Cheese)'],
  'Nuts & Dry Fruits':['Almonds','Walnuts','Cashews','Pistachios','Hazelnuts','Raisins','Dates','Figs','Apricots','Prunes'],
  'Breads':['Whole wheat bread','Sourdough','Pita bread','Multigrain bread'],
  'Supplements':['Whey Protein','Vitamin D3','Omega 3','Multivitamins','Probiotics','Creatine','BCAAs','Zinc','Magnesium','Collagen','Vitamin C','Ashwagandha','L-Glutamine','Iron','Calcium','Coenzyme Q10','Vitamin B6']
};

const toggleFood=(food)=>{
  haptic('light');
  const nf=selectedFoods.includes(food)?selectedFoods.filter(f=>f!==food):[...selectedFoods,food];
  setSelectedFoods(nf);st.set('nt_foods',JSON.stringify(nf));
};

const generateDietPlan=async()=>{
  if(!api){showToast('Set API key in Settings','âš ï¸');return}
  if(selectedFoods.length<5){showToast('Select at least 5 foods','âš ï¸');return}
  setDietPlanLoading(true);
  try{
    const userCtx=buildUserContext();
    const eatingPatternsCtx=profile?.eatingPatterns?.length&&!profile.eatingPatterns.includes('none')?`\nEating patterns: ${profile.eatingPatterns.join(', ')} â€” address these in your lifestyle tips.`:'';
    const supplementsCtx=profile?.openToSupplements?'\nUser is open to nutritional supplements â€” include supplement recommendations.':'\nUser prefers no supplements.';
    const prompt=`Generate a personalized daily diet plan.${userCtx}${eatingPatternsCtx}${supplementsCtx}
The user has these foods available: ${selectedFoods.join(', ')}
Their meal slots are: ${(profile?.mealSlots||['Breakfast','Lunch','Dinner']).join(', ')}
Their daily targets: ${tgt.calories} calories, ${tgt.protein}g protein, ${tgt.carbs}g carbs, ${tgt.fat}g fat

Return ONLY valid JSON (no markdown): {
  "dailyTip": "1-2 sentence tip about their nutrition focus based on their goal and micronutrient needs",
  "meals": [
    {
      "slot": "Breakfast",
      "timeRange": "7:00-9:00 AM",
      "options": [
        {"name": "meal name", "emoji": "ðŸ¥£", "description": "brief 1-line how to prepare", "ingredients": ["item1 with amount", "item2 with amount"], "calories": 400, "protein": 30, "carbs": 45, "fat": 12},
        {"name": "alternate meal", "emoji": "ðŸ³", "description": "brief description", "ingredients": ["item1 with amount"], "calories": 380, "protein": 28, "carbs": 40, "fat": 14}
      ]
    }
  ],
  "groceryList": {"Proteins": ["chicken breast 500g"], "Vegetables": ["spinach 200g"], "Grains": ["rice 1kg"]},
  "supplements": ${profile?.openToSupplements?'[{"name":"supplement name","emoji":"ðŸ’Š","dosage":"amount","timing":"when to take","benefit":"why this helps their goal"}]':'[]'},
  "lifestyle": {"goal": "paragraph about daily target strategy for their goal", "overall": ["bullet point lifestyle tips addressing their eating patterns, training, nutrition timing, hydration, and meal scanning strategy â€” at least 6-8 detailed points"]}
}

Create 2 options per meal slot. Use ONLY the user's available foods. Make portions realistic.`;
    const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:4096}})});
    const d=await res.json();
    if(d.error){if(is429(d.error))showToast('Rate limited, try again in a minute','â³');else showToast('Error: '+(d.error.message||'Unknown'),'âŒ');setDietPlanLoading(false);return}
    const txt=(d.candidates?.[0]?.content?.parts?.[0]?.text)||'';
    const s=txt.indexOf('{'),en=txt.lastIndexOf('}');
    if(s===-1){showToast('Could not parse plan','âŒ');setDietPlanLoading(false);return}
    const plan=JSON.parse(txt.substring(s,en+1));
    plan.createdAt=new Date().toISOString();
    plan.endsAt=new Date(Date.now()+30*24*60*60*1000).toISOString();
    setDietPlan(plan);st.set('nt_dietplan',JSON.stringify(plan));
    setDietPlanTab('plan');setGroceryChecked({});
    haptic('success');playSound('success');showToast('Diet plan generated!','âœ…');
  }catch(err){showToast('Error: '+err.message,'âŒ')}
  setDietPlanLoading(false);
};

const renderDietPlan=()=>{
  if(dietPlanLoading){
    return React.createElement('div',{className:'page-scroll',style:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',minHeight:'60vh'}},
      React.createElement('div',{style:{width:48,height:48,border:'3px solid var(--card-border)',borderTop:'3px solid var(--primary)',borderRadius:'50%',animation:'spin 1s linear infinite',marginBottom:16}}),
      React.createElement('p',{style:{fontSize:16,fontWeight:600}},'Creating your diet plan...'),
      React.createElement('p',{style:{fontSize:13,color:'var(--muted)',marginTop:8}},'This may take a moment')
    );
  }

  /* Show generated plan */
  if(dietPlan){
    const startDate=new Date(dietPlan.createdAt);
    const endDate=new Date(dietPlan.endsAt);
    const now=new Date();
    const totalDays=(endDate-startDate)/(1000*60*60*24);
    const elapsed=(now-startDate)/(1000*60*60*24);
    const pct=Math.min(100,Math.max(0,(elapsed/totalDays)*100));

    const planSubTabs=profile?.openToSupplements?['plan','grocery','supplements','lifestyle']:['plan','grocery','lifestyle'];
    return React.createElement('div',{className:'page-scroll'},
      /* Header with Today button */
      React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
        React.createElement('button',{className:'btn btn-outline',style:{padding:'6px 14px',fontSize:12},onClick:()=>setTab('home')},'Today >'),
        React.createElement('h2',{style:{fontSize:22,fontWeight:700}},'Daily Diet Plan'),
        React.createElement('button',{className:'btn btn-outline',style:{padding:'6px 14px',fontSize:12,display:'flex',alignItems:'center',gap:4},onClick:()=>{setDietPlan(null);st.set('nt_dietplan','null')}},'âœï¸ Edit Plan')
      ),

      /* Date range bar */
      React.createElement('div',{style:{marginBottom:16}},
        React.createElement('div',{style:{height:4,background:'var(--card-border)',borderRadius:2,marginBottom:4}},
          React.createElement('div',{style:{height:4,background:'var(--primary)',borderRadius:2,width:pct+'%',transition:'width 0.3s'}})
        ),
        React.createElement('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12,color:'var(--muted)'}},'Start '+startDate.toLocaleDateString('en-NZ',{day:'numeric',month:'short'}),'Ends '+endDate.toLocaleDateString('en-NZ',{day:'numeric',month:'short'}))
      ),

      /* Sub-tabs */
      React.createElement('div',{style:{display:'flex',gap:8,marginBottom:16,overflowX:'auto'}},
        planSubTabs.map(t=>{
          const labels={'plan':'ðŸ± Diet Plan','grocery':'ðŸ›’ Grocery List','supplements':'ðŸ’Š Supplements','lifestyle':'ðŸƒ Lifestyle'};
          return React.createElement('button',{key:t,className:'btn',style:{padding:'8px 14px',fontSize:13,background:dietPlanTab===t?'var(--primary)':'var(--card)',color:dietPlanTab===t?'#fff':'var(--text)',border:dietPlanTab===t?'2px solid var(--primary)':'1px solid var(--card-border)',whiteSpace:'nowrap',borderRadius:20},onClick:()=>{haptic('light');playSound('tap');setDietPlanTab(t)}},labels[t])
        })
      ),

      /* Diet Plan sub-tab */
      dietPlanTab==='plan'&&React.createElement(React.Fragment,null,
        /* Daily Target card */
        React.createElement('div',{className:'card',style:{marginBottom:16}},
          React.createElement('h3',{style:{fontSize:15,fontWeight:600,marginBottom:10}},'Daily Target'),
          React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}},
            [{l:'Calories',v:tgt.calories,u:''},{l:'Protein',v:tgt.protein,u:'g'},{l:'Carbs',v:tgt.carbs,u:'g'},{l:'Fat',v:tgt.fat,u:'g'}].map(x=>
              React.createElement('div',{key:x.l,style:{textAlign:'center',padding:8,background:'rgba(16,185,129,0.08)',borderRadius:8}},
                React.createElement('div',{style:{fontSize:16,fontWeight:700,color:'var(--primary)'}},x.v+x.u),
                React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l)
              )
            )
          ),
          dietPlan.dailyTip&&React.createElement('p',{style:{fontSize:13,color:'var(--muted)',lineHeight:1.5,marginTop:10}},dietPlan.dailyTip)
        ),
        /* Meal slots */
        (dietPlan.meals||[]).map((meal,mi)=>React.createElement('div',{key:mi,style:{marginBottom:16}},
          React.createElement('h4',{style:{fontSize:15,fontWeight:600,color:'var(--primary)',marginBottom:8}},meal.slot,' (',meal.timeRange,')'),
          (meal.options||[]).map((opt,oi)=>{
            const mealKey=mi+'-'+oi;
            const isExpanded=expandedMealOption===mealKey;
            return React.createElement('div',{key:oi,className:'card',style:{marginBottom:8,cursor:'pointer',transition:'all 0.2s'},onClick:()=>setExpandedMealOption(isExpanded?null:mealKey)},
              React.createElement('div',{style:{display:'flex',alignItems:'center',gap:10}},
                React.createElement('span',{style:{fontSize:24,flexShrink:0}},opt.emoji||'ðŸ½ï¸'),
                React.createElement('div',{style:{flex:1}},
                  React.createElement('div',{style:{fontSize:11,fontWeight:600,color:'var(--muted)',textTransform:'uppercase',letterSpacing:0.5,marginBottom:2}},'OPTION '+(oi+1)),
                  React.createElement('div',{style:{fontWeight:600,fontSize:15,marginBottom:2}},opt.name),
                  React.createElement('div',{style:{fontSize:12,color:'var(--muted)'}},opt.description)
                ),
                React.createElement('span',{style:{fontSize:18,color:'var(--muted)',flexShrink:0}},isExpanded?'â–²':'>')
              ),
              isExpanded&&React.createElement('div',{style:{marginTop:12,paddingTop:12,borderTop:'1px solid var(--card-border)'}},
                React.createElement('h5',{style:{fontSize:13,fontWeight:600,marginBottom:8}},'Ingredients'),
                React.createElement('div',{style:{display:'flex',flexWrap:'wrap',gap:6,marginBottom:12}},
                  (opt.ingredients||[]).map((ing,ii)=>React.createElement('span',{key:ii,style:{padding:'4px 10px',background:'rgba(255,255,255,0.05)',borderRadius:12,fontSize:12,color:'var(--muted)',border:'1px solid var(--card-border)'}},ing))
                ),
                React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:4}},
                  [{l:'Calories',v:Math.round(opt.calories||0),u:''},{l:'Protein',v:Math.round(opt.protein||0),u:'g'},{l:'Carbs',v:Math.round(opt.carbs||0),u:'g'},{l:'Fat',v:Math.round(opt.fat||0),u:'g'}].map(x=>
                    React.createElement('div',{key:x.l,style:{textAlign:'center',padding:6,background:'rgba(16,185,129,0.06)',borderRadius:6}},
                      React.createElement('div',{style:{fontSize:14,fontWeight:700}},x.v+x.u),
                      React.createElement('div',{style:{fontSize:9,color:'var(--muted)'}},x.l)
                    )
                  )
                )
              )
            );
          })
        ))
      ),

      /* Grocery List sub-tab */
      dietPlanTab==='grocery'&&React.createElement(React.Fragment,null,
        Object.entries(dietPlan.groceryList||{}).map(([cat,items])=>React.createElement('div',{key:cat,className:'card',style:{marginBottom:12}},
          React.createElement('h4',{style:{fontSize:14,fontWeight:600,marginBottom:8,color:'var(--primary)'}},cat),
          (items||[]).map((item,i)=>{
            const key=cat+'-'+i;
            return React.createElement('div',{key:i,style:{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderTop:i>0?'1px solid var(--card-border)':'none',cursor:'pointer'},onClick:()=>{haptic('light');setGroceryChecked(prev=>({...prev,[key]:!prev[key]}))}},
              React.createElement('div',{style:{width:20,height:20,borderRadius:6,border:groceryChecked[key]?'none':'2px solid var(--card-border)',background:groceryChecked[key]?'var(--primary)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}},groceryChecked[key]&&React.createElement('span',{style:{color:'#fff',fontSize:12}},'âœ“')),
              React.createElement('span',{style:{fontSize:14,textDecoration:groceryChecked[key]?'line-through':'none',color:groceryChecked[key]?'var(--muted)':'var(--text)'}},item)
            );
          })
        ))
      ),

      /* Supplements sub-tab */
      dietPlanTab==='supplements'&&React.createElement(React.Fragment,null,
        (dietPlan.supplements&&dietPlan.supplements.length>0)?
          React.createElement(React.Fragment,null,
            React.createElement('div',{className:'card',style:{marginBottom:16,background:'rgba(139,92,246,0.06)',border:'1px solid rgba(139,92,246,0.15)'}},
              React.createElement('p',{style:{fontSize:13,color:'var(--muted)',lineHeight:1.5}},'ðŸ’Š Supplement recommendations based on your ',profile?.goal?.replace('_',' '),' goal and dietary needs. Always consult a healthcare professional before starting any new supplements.')
            ),
            (dietPlan.supplements||[]).map((sup,i)=>React.createElement('div',{key:i,className:'card',style:{marginBottom:10}},
              React.createElement('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:8}},
                React.createElement('span',{style:{fontSize:24}},sup.emoji||'ðŸ’Š'),
                React.createElement('div',{style:{flex:1}},
                  React.createElement('div',{style:{fontWeight:600,fontSize:15}},sup.name),
                  React.createElement('div',{style:{fontSize:12,color:'var(--primary)'}},sup.dosage)
                )
              ),
              React.createElement('div',{style:{display:'flex',gap:8,marginBottom:6}},
                React.createElement('span',{style:{padding:'3px 8px',background:'rgba(59,130,246,0.1)',borderRadius:8,fontSize:11,color:'#3B82F6'}},'â° ',sup.timing)
              ),
              React.createElement('p',{style:{fontSize:13,color:'var(--muted)',lineHeight:1.4}},sup.benefit)
            ))
          ):
          React.createElement('div',{className:'card',style:{textAlign:'center',padding:32}},
            React.createElement('div',{style:{fontSize:48,marginBottom:12}},'ðŸ’Š'),
            React.createElement('p',{style:{color:'var(--muted)'}},'No supplement recommendations in this plan. Edit your plan to regenerate.')
          )
      ),

      /* Lifestyle sub-tab */
      dietPlanTab==='lifestyle'&&React.createElement(React.Fragment,null,
        dietPlan.lifestyle?React.createElement(React.Fragment,null,
          React.createElement('div',{className:'card',style:{marginBottom:16}},
            React.createElement('h3',{style:{fontSize:16,fontWeight:700,marginBottom:8}},'Goal'),
            React.createElement('p',{style:{fontSize:14,lineHeight:1.6,color:'var(--text)'}},dietPlan.lifestyle.goal)
          ),
          React.createElement('div',{className:'card'},
            React.createElement('h3',{style:{fontSize:16,fontWeight:700,marginBottom:12}},'Overall'),
            (dietPlan.lifestyle.overall||[]).map((tip,i)=>React.createElement('div',{key:i,style:{padding:'10px 0',borderTop:i>0?'1px solid var(--card-border)':'none'}},
              React.createElement('p',{style:{fontSize:14,lineHeight:1.6,color:'var(--text)'}},'â€¢ ',tip)
            ))
          )
        ):
        /* Fallback to old tips */
        React.createElement('div',{className:'card'},
          React.createElement('h3',{style:{fontSize:16,fontWeight:600,marginBottom:12}},'Lifestyle & Nutrition Tips'),
          (dietPlan.tips||[]).map((tip,i)=>React.createElement('div',{key:i,style:{display:'flex',gap:10,padding:'10px 0',borderTop:i>0?'1px solid var(--card-border)':'none'}},
            React.createElement('span',{style:{fontSize:18,flexShrink:0}},'ðŸ’¡'),
            React.createElement('p',{style:{fontSize:14,lineHeight:1.5,color:'var(--text)'}},tip)
          ))
        )
      )
    );
  }

  /* Food Preference Picker (no plan yet) */
  return React.createElement('div',{className:'page-scroll'},
    React.createElement('h2',{style:{fontSize:22,fontWeight:700,marginBottom:8}},'Start Creating Diet Plan!'),
    React.createElement('p',{style:{color:'var(--muted)',fontSize:13,marginBottom:20}},'Items you already own makes meal preparation more convenient and cost-effective for you.'),

    /* Food categories */
    Object.entries(FOOD_CATEGORIES).filter(([cat])=>cat!=='Supplements'||profile?.openToSupplements).map(([cat,foods])=>{
      const catEmojis={'Protein':'ðŸ—','Grains':'ðŸŒ¾','Legumes':'ðŸ«˜','Vegetables':'ðŸ¥¦','Fruits':'ðŸŽ','Dairy':'ðŸ§€','Nuts & Dry Fruits':'ðŸ¥œ','Breads':'ðŸž','Supplements':'ðŸ’Š'};
      return React.createElement('div',{key:cat,style:{marginBottom:20}},
      React.createElement('h4',{style:{fontSize:15,fontWeight:600,marginBottom:10}},(catEmojis[cat]||'')+' '+cat),
      React.createElement('div',{style:{display:'flex',flexWrap:'wrap',gap:8}},
        foods.map(food=>React.createElement('button',{key:food,style:{padding:'8px 14px',borderRadius:20,border:selectedFoods.includes(food)?'2px solid var(--primary)':'2px solid var(--card-border)',background:selectedFoods.includes(food)?'rgba(16,185,129,0.1)':'var(--card)',color:'var(--text)',fontSize:13,cursor:'pointer',fontFamily:'inherit',transition:'all 0.2s'},onClick:()=>toggleFood(food)},food))
      )
    )}),

    /* Selected count */
    React.createElement('div',{style:{position:'sticky',bottom:80,padding:'16px 16px',margin:'0 -16px',background:'var(--bg)'}},
      React.createElement('button',{className:'btn btn-primary',style:{opacity:selectedFoods.length>=5?1:0.4},onClick:()=>{if(selectedFoods.length>=5)generateDietPlan()}},
        'Start Creating Diet Plan'+(selectedFoods.length>0?' ('+selectedFoods.length+' selected)':'')
      ),
      selectedFoods.length>0&&selectedFoods.length<5&&React.createElement('p',{style:{fontSize:12,color:'var(--muted)',textAlign:'center',marginTop:6}},'Select at least '+(5-selectedFoods.length)+' more')
    )
  );
};

/* ==================== MODALS ==================== */
const renderModals=()=>{
  if(!modal) return null;

  /* Confirm meal modal */
  if(modal==='confirm'&&pending){
    const ns=calculateNutriScore(pending,profile);
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null);setPending(null);setFoodPhoto(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation(),style:{maxHeight:'95vh'}},
        /* Photo header */
        foodPhoto&&React.createElement('div',{style:{margin:'-24px -24px 16px',height:200,background:`url(${foodPhoto}) center/cover`,borderRadius:'24px 24px 0 0',position:'relative'}},
          React.createElement('div',{style:{position:'absolute',inset:0,background:'linear-gradient(transparent 40%,var(--card))',borderRadius:'24px 24px 0 0'}})
        ),

        /* Meal slot selector */
        React.createElement('div',{style:{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}},
          ['Breakfast','Lunch','Afternoon Snack','Dinner','Evening Snack'].map(s=>
            React.createElement('button',{key:s,className:'btn',style:{padding:'6px 12px',fontSize:12,background:pendingMealSlot===s?'var(--primary)':'var(--card)',color:pendingMealSlot===s?'#fff':'var(--text)',border:'1px solid var(--card-border)',transition:'all 0.2s'},onClick:()=>{haptic('light');playSound('tap');setPendingMealSlot(s)}},s)
          )
        ),

        /* Items list */
        React.createElement('div',{style:{marginBottom:16}},
          (pending.items||[]).map((item,idx)=>
            React.createElement('div',{key:idx,style:{display:'flex',alignItems:'center',gap:10,padding:'10px 0',borderBottom:'1px solid var(--card-border)'}},
              React.createElement('span',{style:{fontSize:20}},item.emoji||'ðŸ½ï¸'),
              React.createElement('div',{style:{flex:1,minWidth:0}},
                React.createElement('div',{style:{fontWeight:500,fontSize:14}},item.name),
                React.createElement('div',{style:{fontSize:12,color:'var(--muted)'}},item.quantity,' Â· ',Math.round(item.calories||0),' cal')
              ),
              editingItem===idx?
                React.createElement('div',{style:{display:'flex',gap:4}},
                  React.createElement('input',{value:editItemText,onChange:e=>setEditItemText(e.target.value),placeholder:'Replace with...',style:{width:120,padding:6,fontSize:12}}),
                  React.createElement('button',{className:'btn',style:{padding:'4px 8px',fontSize:11,background:'var(--primary)',color:'#fff'},onClick:()=>aiCleanupItem(editItemText)},'Go'),
                  editItemSuggestion&&React.createElement('button',{className:'btn',style:{padding:'4px 8px',fontSize:11,background:'#22C55E',color:'#fff'},onClick:()=>replaceIngredient(idx,editItemSuggestion)},'âœ“'),
                  React.createElement('button',{className:'btn',style:{padding:'4px 8px',fontSize:11},onClick:()=>{setEditingItem(null);setEditItemText('');setEditItemSuggestion(null)}},'âœ•')
                ):
                React.createElement('div',{style:{display:'flex',gap:6}},
                  React.createElement('button',{style:{background:'none',border:'none',color:'var(--muted)',fontSize:16,cursor:'pointer'},onClick:()=>setEditingItem(idx)},'âœï¸'),
                  React.createElement('button',{style:{background:'none',border:'none',color:'var(--muted)',fontSize:16,cursor:'pointer'},onClick:()=>removeIngredient(idx)},'âœ•')
                )
            )
          ),
          editItemLoading&&React.createElement('div',{style:{textAlign:'center',padding:8,color:'var(--muted)',fontSize:13}},'AI processing...'),

          /* Add item */
          addingItem?
            React.createElement('div',{style:{display:'flex',gap:8,marginTop:8}},
              React.createElement('input',{value:addItemText,onChange:e=>setAddItemText(e.target.value),placeholder:'Type food item...',style:{flex:1,padding:8,fontSize:13}}),
              React.createElement('button',{className:'btn',style:{padding:'6px 12px',fontSize:12,background:'var(--primary)',color:'#fff'},onClick:()=>aiCleanupItem(addItemText,true)},'Add'),
              addItemSuggestion&&React.createElement('button',{className:'btn',style:{padding:'6px 12px',fontSize:12,background:'#22C55E',color:'#fff'},onClick:()=>appendIngredient(addItemSuggestion)},'âœ“'),
              React.createElement('button',{style:{background:'none',border:'none',color:'var(--muted)',cursor:'pointer'},onClick:()=>{setAddingItem(false);setAddItemText('');setAddItemSuggestion(null)}},'âœ•')
            ):
            React.createElement('button',{style:{background:'none',border:'none',color:'var(--primary)',fontSize:13,cursor:'pointer',marginTop:8,padding:0},onClick:()=>setAddingItem(true)},'+  Add item')
        ),

        /* Allergen warnings */
        pending.allergenWarnings?.length>0&&React.createElement('div',{style:{background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:12,padding:12,marginBottom:12}},
          React.createElement('p',{style:{fontSize:13,fontWeight:600,color:'#EF4444'}},'âš ï¸ Allergen Warning'),
          React.createElement('p',{style:{fontSize:12,color:'var(--muted)'}},pending.allergenWarnings.join(', '))
        ),

        /* Macro summary */
        React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:4,marginBottom:12}},
          [{l:'Calories',v:Math.round(pending.calories||0),u:''},{l:'Protein',v:Math.round(pending.protein||0),u:'g'},{l:'Carbs',v:Math.round(pending.carbs||0),u:'g'},{l:'Fat',v:Math.round(pending.fat||0),u:'g'}].map(x=>
            React.createElement('div',{key:x.l,style:{textAlign:'center',padding:8,background:'rgba(255,255,255,0.05)',borderRadius:8}},
              React.createElement('div',{style:{fontSize:18,fontWeight:700}},x.v+x.u),
              React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l)
            )
          )
        ),

        /* Micro row */
        React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:4,marginBottom:16}},
          [{l:'Fiber',v:r2(pending.fiber||0),u:'g'},{l:'Potassium',v:Math.round(pending.potassium||0),u:'mg'},{l:'Calcium',v:Math.round(pending.calcium||0),u:'mg'},{l:'Magnesium',v:Math.round(pending.magnesium||0),u:'mg'}].map(x=>
            React.createElement('div',{key:x.l,style:{textAlign:'center'}},
              React.createElement('div',{style:{fontSize:14,fontWeight:600}},x.v+x.u),
              React.createElement('div',{style:{fontSize:9,color:'var(--muted)'}},x.l)
            )
          )
        ),

        /* NutriScore */
        React.createElement('div',{className:'card',style:{marginBottom:16,background:'rgba(255,255,255,0.03)'}},
          React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:6,marginBottom:8}},
            ['A','B','C','D','E'].map(g=>React.createElement('div',{key:g,className:`nutriscore-pill${ns.grade===g?' active':''}`,style:{background:NUTRISCORE_COLORS[g]}},g))
          ),
          React.createElement('p',{style:{fontSize:13,color:'var(--muted)',textAlign:'center'}},ns.reason),
          expandNutriScore&&React.createElement('p',{style:{fontSize:12,color:'var(--muted)',textAlign:'center',marginTop:8}},'Score: ',ns.score,'/100. Based on protein density, fiber, micronutrients, sugar, sodium, and your ',profile?.goal?.replace('_',' '),' goal.'),
          React.createElement('button',{onClick:()=>{haptic('light');setExpandNutriScore(!expandNutriScore)},style:{background:'none',border:'none',color:'#3B82F6',fontSize:12,cursor:'pointer',marginTop:4,width:'100%',textAlign:'center'}},expandNutriScore?'Less â–²':'Read More â–¼')
        ),

        /* Action buttons */
        React.createElement('div',{style:{display:'flex',gap:12}},
          React.createElement('button',{className:'btn btn-outline',onClick:()=>{setModal(null);setPending(null);setFoodPhoto(null)},style:{flex:1}},'Cancel'),
          foodPhoto&&React.createElement('button',{className:'btn',style:{background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.3)',color:'#3B82F6',padding:'10px 14px'},onClick:()=>{haptic('medium');playSound('pop');shareMealImage(pending,foodPhoto)}},'ðŸ“¤ Share'),
          React.createElement('button',{className:'btn btn-primary',onClick:()=>addMeal(pending,foodPhoto),style:{flex:2}},'Add Meal')
        )
      )
    );
  }

  /* Weight modal */
  if(modal==='weight'){
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        React.createElement('h3',{style:{fontSize:18,fontWeight:600,marginBottom:16}},'Log Weight'),
        React.createElement('input',{type:'number',value:newWt,onChange:e=>setNewWt(e.target.value),placeholder:profile?.unitSystem==='imperial'?'Weight (lbs)':'Weight (kg)',style:{marginBottom:12}}),
        weights.length>1&&React.createElement('div',{style:{marginBottom:16}},
          React.createElement('h4',{style:{fontSize:14,fontWeight:600,marginBottom:8,color:'var(--weight-color)'}},'Trend'),
          React.createElement(Sparkline,{data:weights.slice(-30).map(w=>w.weight),color:'var(--weight-color)',width:280,height:60})
        ),
        React.createElement('div',{style:{display:'flex',gap:12}},
          React.createElement('button',{className:'btn btn-outline',onClick:()=>setModal(null),style:{flex:1}},'Cancel'),
          React.createElement('button',{className:'btn btn-primary',onClick:addWeight,style:{flex:2}},'Save')
        )
      )
    );
  }

  /* Add food modal */
  if(modal==='addFood'){
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        React.createElement('h3',{style:{fontSize:18,fontWeight:600,marginBottom:20}},'Add Food'),
        React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:12}},
          React.createElement('button',{className:'btn',style:{padding:16,background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.3)',color:'#3B82F6',fontSize:15,display:'flex',alignItems:'center',gap:10},onClick:()=>{setModal(null);photoRef.current?.click()}},'ðŸ“·',' Take Photo'),
          React.createElement('button',{className:'btn',style:{padding:16,background:'rgba(139,92,246,0.1)',border:'1px solid rgba(139,92,246,0.3)',color:'#A78BFA',fontSize:15,display:'flex',alignItems:'center',gap:10},onClick:()=>{setModal(null);galleryRef.current?.click()}},'ðŸ–¼ï¸',' Choose from Gallery'),
          React.createElement('button',{className:'btn',style:{padding:16,background:'rgba(16,185,129,0.1)',border:'1px solid rgba(16,185,129,0.3)',color:'#10b981',fontSize:15,display:'flex',alignItems:'center',gap:10},onClick:()=>{setModal(null);startBarcode()}},'ðŸ“Š',' Scan Barcode'),
          React.createElement('button',{className:'btn',style:{padding:16,background:'rgba(245,158,11,0.1)',border:'1px solid rgba(245,158,11,0.3)',color:'#F59E0B',fontSize:15,display:'flex',alignItems:'center',gap:10},onClick:()=>{setModal(null);startVoice()}},'ðŸŽ¤',' Speak Meal'),
          React.createElement('button',{className:'btn',style:{padding:16,background:'rgba(255,255,255,0.05)',border:'1px solid var(--card-border)',color:'var(--text)',fontSize:15,display:'flex',alignItems:'center',gap:10},onClick:()=>setModal('manual')},'âœï¸',' Manual Entry')
        )
      )
    );
  }

  /* Manual entry */
  if(modal==='manual'){
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        React.createElement('h3',{style:{fontSize:18,fontWeight:600,marginBottom:16}},'Manual Entry'),
        ['name','calories','protein','carbs','fat'].map(f=>
          React.createElement('input',{key:f,type:f==='name'?'text':'number',value:manualEntry[f],onChange:e=>setManualEntry({...manualEntry,[f]:e.target.value}),placeholder:f.charAt(0).toUpperCase()+f.slice(1)+(f!=='name'?(f==='calories'?' (cal)':' (g)'):''),style:{marginBottom:10}})
        ),
        React.createElement('div',{style:{display:'flex',gap:12,marginTop:8}},
          React.createElement('button',{className:'btn btn-outline',onClick:()=>setModal(null),style:{flex:1}},'Cancel'),
          React.createElement('button',{className:'btn btn-primary',onClick:()=>{
            if(!manualEntry.name)return;
            const item={name:manualEntry.name,emoji:'âœï¸',quantity:'1 serving',calories:parseFloat(manualEntry.calories)||0,protein:parseFloat(manualEntry.protein)||0,carbs:parseFloat(manualEntry.carbs)||0,fat:parseFloat(manualEntry.fat)||0,fiber:0,sugar:0,sodium:0,potassium:0,calcium:0,magnesium:0};
            const totals={...item};delete totals.name;delete totals.emoji;delete totals.quantity;
            setPending({...totals,items:[item],mealSlot:getMealSlot(),time:getT(),date:getD(),allergenWarnings:[]});
            setPendingMealSlot(getMealSlot());setModal('confirm');setManualEntry({name:'',calories:'',protein:'',carbs:'',fat:''});
          },style:{flex:2}},'Review')
        )
      )
    );
  }

  /* Barcode modal */
  if(modal==='barcode'){
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');stopBarcode();setModal(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        React.createElement('h3',{style:{fontSize:18,fontWeight:600,marginBottom:16}},'Scan Barcode'),
        barcodeScanning&&React.createElement('video',{ref:barcodeVideoRef,style:{width:'100%',borderRadius:12,marginBottom:12},playsInline:true,autoPlay:true}),
        barcodeError&&React.createElement('p',{style:{color:'#EF4444',fontSize:13,marginBottom:12}},barcodeError),
        React.createElement('div',{style:{marginBottom:12}},
          React.createElement('input',{placeholder:'Or enter barcode manually',onKeyDown:e=>{if(e.key==='Enter'&&e.target.value)lookupBarcode(e.target.value)},style:{marginBottom:8}}),
          React.createElement('p',{style:{fontSize:11,color:'var(--muted)'}},'Press Enter to search')
        ),
        React.createElement('button',{className:'btn btn-outline',onClick:()=>{stopBarcode();setModal(null)},style:{width:'100%'}},'Cancel')
      )
    );
  }

  /* Calendar modal */
  if(modal==='calendar'){
    const y=calMonth.getFullYear(), m=calMonth.getMonth();
    const firstDay=new Date(y,m,1).getDay();
    const daysInMonth=new Date(y,m+1,0).getDate();
    const dayNames=['S','M','T','W','T','F','S'];
    const allDates=hist.map(h=>h.date);
    const cells=[];
    for(let i=0;i<firstDay;i++)cells.push(null);
    for(let d=1;d<=daysInMonth;d++)cells.push(d);

    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null);setCalDay(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}},
          React.createElement('button',{className:'btn btn-outline',style:{padding:'6px 12px'},onClick:()=>{haptic('light');playSound('tap');setCalMonth(new Date(y,m-1))}},'<'),
          React.createElement('h3',{style:{fontSize:16,fontWeight:600}},calMonth.toLocaleDateString('en-NZ',{month:'long',year:'numeric'})),
          React.createElement('button',{className:'btn btn-outline',style:{padding:'6px 12px'},onClick:()=>{haptic('light');playSound('tap');setCalMonth(new Date(y,m+1))}},'>')
        ),
        React.createElement('div',{className:'calendar-grid'},
          dayNames.map(dn=>React.createElement('div',{key:dn,style:{fontSize:11,fontWeight:600,color:'var(--muted)',padding:4}},dn)),
          cells.map((day,i)=>{
            if(!day) return React.createElement('div',{key:'e'+i});
            const dateStr=new Date(y,m,day).toLocaleDateString('en-NZ');
            const hasMeals=allDates.includes(dateStr)||(dateStr===getD()&&meals.length>0);
            const isToday=dateStr===getD();
            return React.createElement('div',{key:i,className:`calendar-day${hasMeals?' has-meals':''}${isToday?' today':''}`,onClick:()=>{
              if(hasMeals){haptic('light');playSound('tap');setCalDay(dateStr);setSelDate(dateStr)}
            }},day);
          })
        ),
        calDay&&React.createElement('div',{style:{marginTop:16,borderTop:'1px solid var(--card-border)',paddingTop:12}},
          React.createElement('h4',{style:{fontSize:14,fontWeight:600,marginBottom:8}},calDay===getD()?'Today':calDay),
          (calDay===getD()?meals:(hist.find(h=>h.date===calDay)||{}).meals||[]).map((m,i)=>
            React.createElement('div',{key:i,style:{display:'flex',alignItems:'center',gap:10,padding:'10px 0',borderBottom:'1px solid var(--card-border)',cursor:'pointer',transition:'transform 0.15s,opacity 0.15s'},onClick:()=>{haptic('light');setModal({type:'mealDetail',meal:m,date:calDay})}},
              m.photo?React.createElement('img',{src:m.photo,style:{width:40,height:40,borderRadius:10,objectFit:'cover'}}):React.createElement('span',{style:{fontSize:20}},m.items?.[0]?.emoji||'ðŸ½ï¸'),
              React.createElement('div',{style:{flex:1}},
                React.createElement('div',{style:{fontSize:13,fontWeight:500}},m.items?.map(i=>i.name).join(', ')||'Meal'),
                React.createElement('div',{style:{fontSize:11,color:'var(--muted)'}},m.mealSlot,' Â· ',Math.round(m.calories||0),' cal')
              ),
              m.nutriScore&&React.createElement('span',{style:{padding:'2px 6px',borderRadius:4,fontSize:10,fontWeight:700,color:'#fff',background:NUTRISCORE_COLORS[m.nutriScore]}},m.nutriScore),
              React.createElement('span',{style:{fontSize:16,color:'var(--muted)',marginLeft:4}},'â€º')
            )
          )
        ),
        React.createElement('button',{className:'btn btn-outline',onClick:()=>{setModal(null);setCalDay(null)},style:{width:'100%',marginTop:16}},'Close')
      )
    );
  }

  /* Meal detail modal */
  if(modal?.type==='mealDetail'){
    const m=modal.meal;
    const ns=m.nutriScore?{grade:m.nutriScore,score:m.nutriScoreVal,reason:m.nutriScoreReason}:calculateNutriScore(m,profile);
    return React.createElement('div',{className:'modal-overlay',onClick:()=>{haptic('light');setModal(null)}},
      React.createElement('div',{className:'modal',onClick:e=>e.stopPropagation()},
        m.photo&&React.createElement('div',{style:{margin:'-24px -24px 16px',height:180,background:`url(${m.photo}) center/cover`,borderRadius:'24px 24px 0 0',position:'relative'}},
          React.createElement('div',{style:{position:'absolute',inset:0,background:'linear-gradient(transparent 40%,var(--card))',borderRadius:'24px 24px 0 0'}})
        ),
        React.createElement('div',{style:{fontSize:13,color:'var(--muted)',marginBottom:4}},m.mealSlot,' Â· ',m.time),
        React.createElement('h3',{style:{fontSize:18,fontWeight:600,marginBottom:12}},m.items?.map(i=>i.name).join(', ')||'Meal'),
        (m.items||[]).map((item,idx)=>
          React.createElement('div',{key:idx,style:{display:'flex',alignItems:'center',gap:8,padding:'6px 0'}},
            React.createElement('span',{style:{fontSize:16}},item.emoji||'ðŸ½ï¸'),
            React.createElement('span',{style:{flex:1,fontSize:13}},item.name),
            React.createElement('span',{style:{fontSize:12,color:'var(--muted)'}},item.quantity),
            React.createElement('span',{style:{fontSize:12,fontWeight:600}},Math.round(item.calories||0),' cal')
          )
        ),
        React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:4,margin:'12px 0',padding:12,background:'rgba(255,255,255,0.05)',borderRadius:12}},
          [{l:'Cal',v:Math.round(m.calories||0)},{l:'Pro',v:Math.round(m.protein||0)+'g'},{l:'Carbs',v:Math.round(m.carbs||0)+'g'},{l:'Fat',v:Math.round(m.fat||0)+'g'}].map(x=>
            React.createElement('div',{key:x.l,style:{textAlign:'center'}},React.createElement('div',{style:{fontWeight:700}},x.v),React.createElement('div',{style:{fontSize:10,color:'var(--muted)'}},x.l))
          )
        ),
        React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:6,margin:'12px 0'}},
          ['A','B','C','D','E'].map(g=>React.createElement('div',{key:g,className:`nutriscore-pill${ns.grade===g?' active':''}`,style:{background:NUTRISCORE_COLORS[g]}},g))
        ),
        React.createElement('p',{style:{fontSize:12,color:'var(--muted)',textAlign:'center',marginBottom:16}},ns.reason),
        React.createElement('div',{style:{display:'flex',gap:12}},
          React.createElement('button',{className:'btn',style:{flex:1,background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',color:'#EF4444'},onClick:()=>{deleteMeal(m.id,modal.date);setModal(null)}},'Delete'),
          m.photo&&React.createElement('button',{className:'btn',style:{flex:1,background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.3)',color:'#3B82F6'},onClick:()=>{haptic('medium');playSound('pop');shareMealImage(m,m.photo)}},'ðŸ“¤ Share'),
          React.createElement('button',{className:'btn btn-outline',onClick:()=>setModal(null),style:{flex:1}},'Close')
        )
      )
    );
  }

  return null;
};

/* ==================== VOICE OVERLAY ==================== */
const renderVoiceOverlay=()=>{
  if(!voiceRecording&&!voiceProcessing) return null;
  return React.createElement('div',{style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.9)',zIndex:150,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24}},
    voiceProcessing?
      React.createElement(React.Fragment,null,
        React.createElement('div',{style:{fontSize:48,marginBottom:16}},'ðŸ”„'),
        React.createElement('p',{style:{fontSize:16,fontWeight:600}},'Processing...'),
      ):
      React.createElement(React.Fragment,null,
        React.createElement('div',{className:'voice-pulse',style:{width:80,height:80,borderRadius:'50%',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:32,marginBottom:24}},'ðŸŽ¤'),
        React.createElement('p',{style:{fontSize:16,fontWeight:600,marginBottom:8}},'Listening...'),
        voiceTranscript&&React.createElement('p',{style:{fontSize:14,color:'var(--muted)',marginBottom:16,textAlign:'center',maxWidth:300}},'"',voiceTranscript,'"'),
        voiceFallback&&React.createElement('textarea',{value:voiceFallbackText,onChange:e=>setVoiceFallbackText(e.target.value),placeholder:'Type what you ate...',rows:3,style:{width:'100%',maxWidth:300,marginBottom:16,padding:12,borderRadius:12,background:'var(--card)',border:'1px solid var(--card-border)',color:'var(--text)',fontSize:14,resize:'none'}}),
        React.createElement('div',{style:{display:'flex',gap:12}},
          React.createElement('button',{className:'btn btn-outline',onClick:()=>{stopVoice();setVoiceFallbackText('')}},'Cancel'),
          React.createElement('button',{className:'btn btn-primary',style:{minWidth:100},onClick:handleVoiceDone},'Done')
        )
      )
  );
};

/* ==================== RENDER ==================== */
const currentTab=()=>{
  if(tab==='home') return renderHome();
  if(tab==='nutribites') return renderAIChat();
  if(tab==='diet') return renderDietPlan();
  if(tab==='you') return renderYou();
  return null;
};

return React.createElement(React.Fragment,null,
  /* Hidden file inputs */
  React.createElement('input',{ref:photoRef,type:'file',accept:'image/*',capture:'environment',style:{display:'none'},onChange:handlePhoto}),
  React.createElement('input',{ref:galleryRef,type:'file',accept:'image/*',style:{display:'none'},onChange:handlePhoto}),

  /* Loading overlay */
  loading&&React.createElement('div',{style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:200,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}},
    React.createElement('div',{style:{width:48,height:48,border:'3px solid var(--card-border)',borderTop:'3px solid var(--primary)',borderRadius:'50%',animation:'spin 1s linear infinite'}}),
    React.createElement('p',{style:{marginTop:16,color:'var(--muted)'}},'Analyzing...')
  ),

  /* Main content */
  React.createElement('div',{key:tab,className:'page-enter'},currentTab()),

  /* FAB cluster */
  fabOpen&&React.createElement('div',{style:{position:'fixed',inset:0,zIndex:49},onClick:()=>{haptic('light');setFabOpen(false)}}),
  React.createElement('div',{className:'fab-cluster'},
    React.createElement('div',{style:{position:'relative'}},React.createElement('span',{className:'fab-label',style:{opacity:fabOpen?1:0,transition:'opacity 0.2s'}},'Camera'),React.createElement('button',{className:`fab fab-option${fabOpen?' visible':''}`,onClick:()=>{haptic('medium');playSound('tap');setFabOpen(false);photoRef.current?.click()}},'ðŸ“·')),
    React.createElement('div',{style:{position:'relative'}},React.createElement('span',{className:'fab-label',style:{opacity:fabOpen?1:0,transition:'opacity 0.2s'}},'Gallery'),React.createElement('button',{className:`fab fab-option${fabOpen?' visible':''}`,style:{transitionDelay:fabOpen?'0.05s':'0s'},onClick:()=>{haptic('medium');playSound('tap');setFabOpen(false);galleryRef.current?.click()}},'ðŸ–¼ï¸')),
    React.createElement('div',{style:{position:'relative'}},React.createElement('span',{className:'fab-label',style:{opacity:fabOpen?1:0,transition:'opacity 0.2s'}},'Voice'),React.createElement('button',{className:`fab fab-option${fabOpen?' visible':''}`,style:{transitionDelay:fabOpen?'0.1s':'0s'},onClick:()=>{haptic('medium');playSound('tap');setFabOpen(false);startVoice()}},'ðŸŽ¤')),
    React.createElement('div',{style:{position:'relative'}},React.createElement('span',{className:'fab-label',style:{opacity:fabOpen?1:0,transition:'opacity 0.2s'}},'Manual'),React.createElement('button',{className:`fab fab-option${fabOpen?' visible':''}`,style:{transitionDelay:fabOpen?'0.15s':'0s'},onClick:()=>{haptic('medium');playSound('tap');setFabOpen(false);setModal('manual')}},'âœï¸')),
    React.createElement('button',{className:`fab fab-main${fabOpen?' open':''}`,onClick:()=>{haptic('medium');playSound(fabOpen?'tap':'pop');setFabOpen(!fabOpen)}},'+')
  ),

  /* Tab bar */
  React.createElement('div',{className:'tab-bar'},
    [{id:'home',icon:'ðŸ ',label:'Home'},{id:'diet',icon:'ðŸ“…',label:'Diet Plan'},{id:'club',icon:'ðŸ‘¥',label:'Club'},{id:'nutribites',icon:'ðŸ¤–',label:'MacAI'},{id:'you',icon:'ðŸ‘¤',label:'You'}].map(t=>
      React.createElement('button',{key:t.id,className:`tab-item${tab===t.id?' active':''}`,onClick:()=>{
        if(t.id==='club'){showToast('Coming Soon!','ðŸš§');return}
        haptic('light');playSound('tap');setTab(t.id);
      }},
        React.createElement('span',{style:{fontSize:20}},t.icon),
        React.createElement('span',null,t.label)
      )
    )
  ),

  /* Modals */
  renderModals(),

  /* Voice overlay */
  renderVoiceOverlay(),

  /* Toast */
  toast&&React.createElement('div',{className:'toast'},
    React.createElement('span',null,toast.icon),
    React.createElement('span',null,toast.msg)
  )
);
}

/* ==================== MOUNT ==================== */
ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>
</body>
</html>
