<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Macrely">
<meta name="theme-color" content="#0F172A">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>html,body{background:#0F172A}</style>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<title>Macrely</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f0f23;--card:rgba(255,255,255,0.05);--card-border:rgba(255,255,255,0.1);--primary:#10b981;--secondary:#8b5cf6;--accent:#f59e0b;--danger:#ef4444;--text:#fff;--muted:rgba(255,255,255,0.6);--body-bg:linear-gradient(135deg,#0f0f23 0%,#1a1a3e 50%,#0f0f23 100%);--header-bg:linear-gradient(180deg,rgba(15,15,35,0.95),transparent);--nav-bg:rgba(15,15,35,0.95);--modal-bg:linear-gradient(180deg,#1a1a3e,#0f0f23);--input-bg:rgba(255,255,255,0.05);--input-border:rgba(255,255,255,0.1);--subtle:rgba(255,255,255,0.1);--subtle-bg:rgba(255,255,255,0.05);--toggle-off:rgba(255,255,255,0.2);--ring-bg:rgba(255,255,255,0.1)}
:root.light{--bg:#f8f9fa;--card:#ffffff;--card-border:rgba(0,0,0,0.08);--text:#1a1a2e;--muted:rgba(0,0,0,0.5);--body-bg:#f8f9fa;--header-bg:linear-gradient(180deg,rgba(248,249,250,0.95),transparent);--nav-bg:rgba(255,255,255,0.95);--modal-bg:#ffffff;--input-bg:rgba(0,0,0,0.03);--input-border:rgba(0,0,0,0.1);--subtle:rgba(0,0,0,0.08);--subtle-bg:rgba(0,0,0,0.03);--toggle-off:rgba(0,0,0,0.15);--ring-bg:rgba(0,0,0,0.08)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--body-bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.glass{background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--card-border);border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:transform 0.2s ease,box-shadow 0.2s ease}
.glass:hover{box-shadow:0 4px 16px rgba(0,0,0,0.08)}
.btn{padding:12px 24px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:all 0.3s}
.btn-primary{background:linear-gradient(135deg,var(--primary),#059669);color:#fff}
.btn-secondary{background:var(--card);border:1px solid var(--card-border);color:var(--text)}
.progress-ring{transform:rotate(-90deg)}
.progress-ring circle{transition:stroke-dashoffset 0.5s ease}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(16,185,129,0.3)}50%{box-shadow:0 0 40px rgba(16,185,129,0.6)}}
.animate-pulse{animation:pulse 2s infinite}
.animate-float{animation:float 3s ease-in-out infinite}
.animate-glow{animation:glow 2s ease-in-out infinite}
.gradient-text{background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.xp-bar{height:8px;background:var(--subtle);border-radius:4px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));border-radius:4px;transition:width 0.5s ease}
.badge{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.3s}
.badge.locked{filter:grayscale(1);opacity:0.3}
.badge.unlocked{animation:pulse 2s infinite}
@keyframes navDotIn{0%{width:0;opacity:0}100%{width:20px;opacity:1}}
.nav-item:active{transform:scale(0.9)!important}
@keyframes tabFadeIn{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
@keyframes mealSlideIn{0%{opacity:0;transform:translateX(-20px)}100%{opacity:1;transform:translateX(0)}}
@keyframes ringFill{0%{stroke-dashoffset:var(--ring-full)}100%{stroke-dashoffset:var(--ring-target)}}
@keyframes confettiPop{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-120px) scale(0);opacity:0}}
@keyframes fireFlicker{0%,100%{transform:scale(1) rotate(-3deg)}25%{transform:scale(1.1) rotate(3deg)}50%{transform:scale(0.95) rotate(-2deg)}75%{transform:scale(1.05) rotate(2deg)}}
@keyframes modalSlideUp{0%{transform:translateY(100%);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes questPop{0%{opacity:0;transform:scale(0.8)}100%{opacity:1;transform:scale(1)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.tab-content{animation:tabFadeIn 0.3s ease-out}
.meal-card{animation:mealSlideIn 0.35s ease-out both}
.modal{animation:modalSlideUp 0.3s ease-out}
.quest-card{animation:questPop 0.3s ease-out both}
.btn:active{transform:scale(0.95)!important}
.btn-primary:active{filter:brightness(0.9)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;color:var(--muted);transition:all 0.3s}
.nav-item.active{color:var(--primary)}
.nav-item.active::before{content:'';position:absolute;top:-2px;width:20px;height:4px;background:var(--primary);border-radius:2px}
.quest-card{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:16px;margin-bottom:12px}
.quest-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.meal-card{padding:16px;border-radius:16px;margin-bottom:12px;background:linear-gradient(135deg,var(--subtle),var(--subtle-bg));border:1px solid var(--subtle)}
input,select{background:var(--input-bg);border:1px solid var(--input-border);color:var(--text);padding:14px 16px;border-radius:12px;width:100%;font-size:16px;outline:none;transition:border-color 0.3s}
input:focus,select:focus{border-color:var(--primary)}
input::placeholder{color:var(--muted)}
select option{background:var(--card);color:var(--text)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);display:flex;align-items:flex-end;justify-content:center;z-index:100}
.modal{background:var(--modal-bg);border-radius:24px 24px 0 0;width:100%;max-width:500px;padding:24px;max-height:90vh;overflow-y:auto}
.modal-center{align-items:center;padding:20px}
.modal-center .modal{border-radius:24px;max-height:80vh}
.section-collapse{overflow:hidden;transition:max-height 0.3s ease,opacity 0.3s ease}
.section-collapse.collapsed{max-height:0!important;opacity:0;pointer-events:none}
.section-collapse.expanded{max-height:1000px;opacity:1}
.section-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 0;-webkit-tap-highlight-color:transparent}
.chevron{transition:transform 0.3s ease;display:inline-block;font-size:14px;color:var(--muted)}
.chevron.collapsed{transform:rotate(-90deg)}
@keyframes toastSlideIn{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes toastSlideOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-100%)}}
.badge-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:300;background:linear-gradient(135deg,#1a1a3e,#2a2a5e);border:1px solid rgba(139,92,246,0.4);border-radius:16px;padding:16px 24px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,0.4);animation:toastSlideIn 0.4s ease-out;min-width:280px;max-width:90vw}
.badge-toast.dismissing{animation:toastSlideOut 0.4s ease-in forwards}
@keyframes voicePulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(16,185,129,0.4)}50%{transform:scale(1.1);box-shadow:0 0 0 20px rgba(16,185,129,0)}}
.voice-pulse{animation:voicePulse 1.5s ease-in-out infinite}
</style>
</head>
<body>
<div id="splash-screen" style="position:fixed;inset:0;z-index:9999;background:radial-gradient(circle at 50% 40%,#1E293B 0%,#0F172A 70%);display:flex;align-items:center;justify-content:center;transition:opacity 0.6s ease">
  <div style="position:absolute;inset:0;background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.03) 1px,transparent 0);background-size:24px 24px;opacity:0" id="splashGrid"></div>
  <div style="position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;background:radial-gradient(circle,rgba(20,184,166,0.15) 0%,transparent 70%);border-radius:50%;filter:blur(20px);opacity:0" id="splashGlow"></div>
  <div id="splashContainer" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
    <div id="splashMMark" style="display:flex;flex-direction:column;align-items:center">
      <svg id="splashTopChev" width="100" height="50" viewBox="0 0 120 60" style="opacity:0;transform:translate(-150px,-120px) rotate(-45deg) scale(0.6);filter:blur(8px)"><path d="M10 5 L60 50 L110 5 L95 5 L60 35 L25 5 Z" fill="#F8FAFC"/></svg>
      <svg id="splashBotChev" width="100" height="50" viewBox="0 0 120 60" style="opacity:0;margin-top:-12px;transform:translate(150px,120px) rotate(45deg) scale(0.6);filter:blur(8px)"><path d="M10 5 L60 50 L110 5 L95 5 L60 35 L25 5 Z" fill="#F8FAFC"/></svg>
    </div>
    <div id="splashFullLogo" style="position:absolute;display:flex;flex-direction:column;align-items:center;opacity:0;transform:scale(0.8)">
      <svg width="70" viewBox="0 0 100 140" fill="none"><path d="M15 95 Q5 100 8 110 Q10 120 20 125 L25 130 Q30 135 35 130 L40 120" stroke="#F8FAFC" stroke-width="2" fill="none"/><path d="M75 50 Q85 48 82 55 Q80 62 75 65" stroke="#F8FAFC" stroke-width="2" fill="none"/><path d="M78 60 Q88 58 85 65 Q83 72 78 75" stroke="#F8FAFC" stroke-width="2" fill="none"/><path d="M80 72 Q90 70 87 77 Q85 84 80 87" stroke="#F8FAFC" stroke-width="2" fill="none"/><path d="M78 85 Q88 83 85 90 Q83 97 78 100" stroke="#F8FAFC" stroke-width="2" fill="none"/><rect x="20" y="20" width="55" height="100" rx="8" fill="#14B8A6" stroke="#0D9488" stroke-width="2"/><rect x="25" y="30" width="45" height="75" rx="3" fill="#F8FAFC"/><circle cx="47" cy="25" r="2" fill="#0D9488"/><circle cx="47" cy="112" r="4" stroke="#0D9488" stroke-width="1.5" fill="none"/><ellipse cx="47" cy="65" rx="15" ry="8" fill="#F5E6D3" stroke="#D4B896" stroke-width="1"/><circle cx="42" cy="62" r="4" fill="#E57373"/><circle cx="52" cy="63" r="3" fill="#81C784"/><ellipse cx="47" cy="68" rx="5" ry="2" fill="#FFB74D"/><path d="M40 52 Q38 48 40 44" stroke="#94A3B8" stroke-width="1" fill="none"/><path d="M47 50 Q45 46 47 42" stroke="#94A3B8" stroke-width="1" fill="none"/><path d="M54 52 Q52 48 54 44" stroke="#94A3B8" stroke-width="1" fill="none"/></svg>
      <div id="splashWordmark" style="font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;font-size:32px;font-weight:600;color:#14B8A6;letter-spacing:2px;margin-top:12px;opacity:0;transform:translateY(20px)">Macrely</div>
    </div>
    <div id="splashScan" style="position:absolute;top:38%;left:0;right:0;height:80px;background:linear-gradient(90deg,transparent 0%,rgba(20,184,166,0.4) 50%,transparent 100%);filter:blur(4px);opacity:0;transform:translateX(-100%)"></div>
  </div>
</div>
<script>
(function(){
  if(sessionStorage.getItem('macrely_splash_seen')){document.getElementById('splash-screen').style.display='none';return}
  sessionStorage.setItem('macrely_splash_seen','1');
  var frame=0,fps=60,total=144;
  var topC=document.getElementById('splashTopChev'),botC=document.getElementById('splashBotChev'),mm=document.getElementById('splashMMark'),fl=document.getElementById('splashFullLogo'),wm=document.getElementById('splashWordmark'),sl=document.getElementById('splashScan'),gw=document.getElementById('splashGlow'),gr=document.getElementById('splashGrid'),cn=document.getElementById('splashContainer');
  var eOC=function(t){return 1-Math.pow(1-t,3)},eOB=function(t){var c1=1.70158,c3=c1+1;return 1+c3*Math.pow(t-1,3)+c1*Math.pow(t-1,2)},eIOC=function(t){return t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2};
  var interp=function(v,a,b,c,d,fn){var r=Math.max(0,Math.min(1,(v-a)/(b-a)));return c+(fn||function(t){return t})(r)*(d-c)};
  var lt=0,ft=1000/fps,acc=0,started=false;
  function tick(now){
    if(!started){lt=now;started=true}
    acc+=now-lt;lt=now;
    while(acc>=ft){frame++;acc-=ft}
    if(frame>=total+17){
      var sp=document.getElementById('splash-screen');
      sp.style.opacity='0';
      setTimeout(function(){sp.style.display='none'},300);
      return;
    }
    gr.style.opacity=interp(frame,0,17,0,0.5,eOC);
    var tp=interp(frame,17,48,0,1,eOC);
    topC.style.opacity=interp(frame,17,27,0,1,eOC);
    topC.style.transform='translate('+interp(tp,0,1,-150,0,eOC)+'px,'+interp(tp,0,1,-120,0,eOB)+'px) rotate('+interp(tp,0,1,-45,0,eOC)+'deg) scale('+interp(tp,0,1,0.6,1,eOB)+')';
    topC.style.filter='blur('+interp(tp,0,1,8,0)+'px)';
    var bp=interp(frame,23,53,0,1,eOC);
    botC.style.opacity=interp(frame,23,33,0,1,eOC);
    botC.style.transform='translate('+interp(bp,0,1,150,0,eOC)+'px,'+interp(bp,0,1,120,0,eOB)+'px) rotate('+interp(bp,0,1,45,0,eOC)+'deg) scale('+interp(bp,0,1,0.6,1,eOB)+')';
    botC.style.filter='blur('+interp(bp,0,1,8,0)+'px)';
    var gi=interp(frame,48,58,0,1)*(1-interp(frame,67,86,0,1));
    gw.style.opacity=gi;
    mm.style.filter='drop-shadow(0 0 '+gi*25+'px rgba(20,184,166,'+gi*0.5+'))';
    mm.style.opacity=interp(frame,72,91,1,0,eOC);
    mm.style.transform='scale('+interp(frame,72,91,1,0.5,eOC)+')';
    fl.style.opacity=interp(frame,82,106,0,1,eOC);
    fl.style.transform='scale('+interp(frame,82,106,0.8,1,eOB)+')';
    if(frame>=96&&frame<=110){var sp2=interp(frame,96,110,0,1,eIOC);sl.style.opacity=1;sl.style.transform='translateX('+(sp2*200-100)+'%)'}else{sl.style.opacity=0}
    var wo=interp(frame,106,125,0,1,eOC);
    wm.style.opacity=wo;wm.style.transform='translateY('+interp(frame,106,125,20,0,eOC)+'px)';
    wm.style.textShadow='0 0 20px rgba(20,184,166,'+wo*0.3+')';
    if(frame>=125){cn.style.transform='scale('+(1+Math.sin((frame-125)/fps*Math.PI*0.8)*0.01)+')'}
    requestAnimationFrame(tick);
  }
  setTimeout(function(){requestAnimationFrame(tick)},300);
})();
</script>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback}=React;

// Firebase Configuration - Replace with your own config from console.firebase.google.com
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBaa73Chxi_2Roc0ZthqJXjssP7CoQrdt0",
  authDomain: "mealrank-bb9dc.firebaseapp.com",
  databaseURL: "https://mealrank-bb9dc-default-rtdb.firebaseio.com",
  projectId: "mealrank-bb9dc",
  storageBucket: "mealrank-bb9dc.firebasestorage.app",
  messagingSenderId: "204976013092",
  appId: "1:204976013092:web:fb2cefc72b4c7f02defdb1"
};

// Initialize Firebase (only if config is set)
let firebaseApp = null;
let db = null;
const initFirebase = (config) => {
  if (!config || config.apiKey === "YOUR_API_KEY") return false;
  try {
    if (!firebaseApp) {
      firebaseApp = firebase.initializeApp(config);
      db = firebase.database();
    }
    return true;
  } catch (e) {
    console.error('Firebase init error:', e);
    return false;
  }
};

// Generate unique 6-digit partner code
const genPartnerCode = () => {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
};

// Generate unique user ID for Firebase
const genUserId = () => 'u_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);

const APP_VERSION='1.6.0';
const PATCH_NOTES=[
  {version:'1.6.0',date:'31 Jan 2026',title:'Voice-to-Meal & API Usage Dashboard',items:[
    'Speak Meal â€” describe what you ate by voice and AI parses it into individual items with USDA macros',
    'Long-press the + button to start voice input, or tap Speak Meal in the Add Food menu',
    'Clarification cards â€” if AI is unsure about a quantity, answer inline or dismiss to keep defaults',
    'Text fallback â€” if your browser doesn\'t support speech recognition, type what you ate instead',
    'API Usage Dashboard in Settings â€” see which users are making the most API calls across all users',
    'Today / Yesterday / This Week toggle to view usage over different periods',
    'Every Gemini API call (photo, edit, voice) now logged to Firebase for usage tracking'
  ]},
  {version:'1.5.0',date:'31 Jan 2026',title:'Sugar Tracking, Gut Health & Smart Queuing',items:[
    'Sugar now tracked by default in the macros row on home screen',
    'Gut health score (1-10) shown per food item when using photo analysis',
    'Add Item button in confirm screen â€” add extra foods to a meal after scanning',
    'AI food replacement now returns real nutritional values instead of zeros',
    'Display Preferences in Settings â€” toggle sugar, gut health, and hide any metric',
    'Rate limit protection â€” photos auto-queue and retry when API is busy',
    'What\'s New popup on startup â€” see latest updates (toggle in Settings > Logs)',
    'Check for Updates button in Settings to get the latest version instantly'
  ]},
  {version:'1.4.0',date:'30 Jan 2026',title:'Customisable Tracking, Barcode Scanner & More',items:[
    'Tap the main progress ring to track any macro â€” calories, protein, iron, calcium, and more',
    'Barcode scanner â€” scan packaged food using your camera or enter a barcode manually',
    'Expanded nutrients â€” iron, calcium, vitamins A/C/D, potassium, cholesterol, saturated fat now tracked',
    'Long-press macros row to pick your top 3 displayed macros',
    'Hydration and gamification off by default â€” opt in during onboarding or in Settings',
    'Weekly stats log â€” auto-saves your weekly averages, viewable in Settings',
    'Friends limit raised from 6 to 10',
    'Partner tab removed â€” goals and meal ideas moved to Friends tab',
    'Improved AI portion size estimation from photos',
    'All section headers now show text before emoji'
  ]},
  {version:'1.3.0',date:'30 Jan 2026',title:'Ingredient Editing & Smart Photo Times',items:[
    'Tap any ingredient in the confirm screen to edit, replace, or remove it',
    'AI-powered ingredient replacement â€” type messy text and get cleaned-up macros',
    'Photos now use the time they were taken for meal categorisation, not upload time',
    'Great for batch-logging: upload all your day\'s photos at once and they\'ll sort into the right meals',
    'Confirm button simplified to "Add Meal"',
    'Patch notes on startup so you never miss updates'
  ]},
];
const ACT={sedentary:1.2,light:1.375,moderate:1.55,active:1.725,very_active:1.9};
const EMPTY={calories:0,protein:0,carbs:0,fat:0,fiber:0,sugar:0,sodium:0,saturatedFat:0,cholesterol:0,potassium:0,vitaminA:0,vitaminC:0,vitaminD:0,iron:0,calcium:0};
const MACRO_INFO={calories:{name:'Calories',color:'#10b981',emoji:'ðŸ”¥',unit:'cal'},protein:{name:'Protein',color:'#f43f5e',emoji:'ðŸ’ª',unit:'g'},carbs:{name:'Carbs',color:'#f59e0b',emoji:'ðŸŒ¾',unit:'g'},fat:{name:'Fat',color:'#3b82f6',emoji:'ðŸ«’',unit:'g'},fiber:{name:'Fiber',color:'#22c55e',emoji:'ðŸ¥¦',unit:'g'},sugar:{name:'Sugar',color:'#f97316',emoji:'ðŸ¬',unit:'g'},sodium:{name:'Sodium',color:'#ef4444',emoji:'ðŸ§‚',unit:'mg'},saturatedFat:{name:'Sat Fat',color:'#e11d48',emoji:'ðŸ¥“',unit:'g'},cholesterol:{name:'Cholesterol',color:'#be185d',emoji:'ðŸ«€',unit:'mg'},potassium:{name:'Potassium',color:'#7c3aed',emoji:'ðŸŒ',unit:'mg'},vitaminA:{name:'Vit A',color:'#ea580c',emoji:'ðŸ¥•',unit:'mcg'},vitaminC:{name:'Vit C',color:'#16a34a',emoji:'ðŸŠ',unit:'mg'},vitaminD:{name:'Vit D',color:'#0891b2',emoji:'â˜€ï¸',unit:'mcg'},iron:{name:'Iron',color:'#dc2626',emoji:'ðŸ©¸',unit:'mg'},calcium:{name:'Calcium',color:'#2563eb',emoji:'ðŸ¦´',unit:'mg'}};
const MACRO_TARGETS={protein:0,carbs:0,fat:0,fiber:25,sugar:50,sodium:2300,saturatedFat:20,cholesterol:300,potassium:3500,vitaminA:900,vitaminC:90,vitaminD:20,iron:18,calcium:1000};
const DEFAULT_SECTIONS={quests:true,water:true,meals:true,macros:true,analytics:false};
const r2=n=>Math.round((n||0)*100)/100;
const calcT=p=>{const bmr=p.gender==='male'?10*p.weight+6.25*p.height-5*p.age+5:10*p.weight+6.25*p.height-5*p.age-161;let t=bmr*ACT[p.activity];if(p.goal==='lose')t-=500;if(p.goal==='gain')t+=500;return{calories:Math.round(t),protein:Math.round(p.weight*2.2),carbs:Math.round((t*0.45)/4),fat:Math.round((t*0.25)/9),fiber:p.gender==='male'?38:25,sugar:50,sodium:2300}};
const getM=()=>{const h=new Date().getHours();return h>=5&&h<11?'Breakfast':h>=11&&h<16?'Lunch':h>=16&&h<22?'Dinner':'Snack'};
const getT=()=>new Date().toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});
const getD=(d=new Date())=>d.toLocaleDateString('en-NZ');
const st={get:k=>{try{return localStorage.getItem(k)}catch{return null}},set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}};

// XP System
const XP_ACTIONS={logMeal:25,hitCalories:50,hitProtein:30,drinkWater:5,streak7:100,streak30:500,firstMeal:50};
const LEVELS=[0,100,250,500,1000,2000,3500,5500,8000,12000,17000,25000,35000,50000,70000,100000];
const getLevel=xp=>{for(let i=LEVELS.length-1;i>=0;i--)if(xp>=LEVELS[i])return{level:i+1,current:xp-LEVELS[i],next:LEVELS[i+1]?LEVELS[i+1]-LEVELS[i]:LEVELS[i]};return{level:1,current:0,next:100}};

// Badges
const BADGES=[
  {id:'first',icon:'ðŸŒŸ',name:'First Step',desc:'Log your first meal',check:d=>d.totalMeals>=1},
  {id:'week',icon:'ðŸ”¥',name:'On Fire',desc:'7 day streak',check:d=>d.streak>=7},
  {id:'month',icon:'ðŸ’Ž',name:'Diamond',desc:'30 day streak',check:d=>d.streak>=30},
  {id:'hydrated',icon:'ðŸ’§',name:'Hydrated',desc:'Hit water goal 10 times',check:d=>d.waterGoals>=10},
  {id:'protein',icon:'ðŸ’ª',name:'Protein Pro',desc:'Hit protein goal 20 times',check:d=>d.proteinGoals>=20},
  {id:'century',icon:'ðŸ†',name:'Century',desc:'Log 100 meals',check:d=>d.totalMeals>=100},
  {id:'master',icon:'ðŸ‘‘',name:'Master',desc:'Reach level 10',check:d=>d.level>=10},
  {id:'perfect',icon:'â­',name:'Perfect Day',desc:'Hit all macros in one day',check:d=>d.perfectDays>=1},
];

const ProgressRing=({pct,size=100,stroke=10,color='#10b981',children})=>{
  const r=(size-stroke)/2,c=2*Math.PI*r;
  const target=c-Math.min(pct||0,100)/100*c;
  return<div style={{position:'relative',width:size,height:size}}>
    <svg width={size} height={size} className="progress-ring">
      <defs><linearGradient id={`grad-${color}`} x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor={color}/><stop offset="100%" stopColor={color==='#10b981'?'#8b5cf6':color}/>
      </linearGradient></defs>
      <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="var(--subtle)" strokeWidth={stroke}/>
      <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={`url(#grad-${color})`} strokeWidth={stroke}
        strokeDasharray={c} strokeDashoffset={target} strokeLinecap="round"
        style={{'--ring-full':c,'--ring-target':target,animation:'ringFill 1s ease-out',strokeDashoffset:target}}/>
    </svg>
    <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>{children}</div>
  </div>
};

function App(){
const[users,setUsers]=useState({});
const[cur,setCur]=useState(null);
const[view,setView]=useState('loading');
const[tab,setTab]=useState('home');
const[api,setApi]=useState('');
const[modal,setModal]=useState(null);
const[pending,setPending]=useState(null);
const[setup,setSetup]=useState({gender:'male',weight:'',height:'',age:'',activity:'moderate',goal:'maintain',weightUnit:'kg',heightUnit:'cm',heightFt:'',heightIn:'',hydrationOn:false,gamificationOn:false});
const[manual,setManual]=useState({...EMPTY});
const[loading,setLoading]=useState(false);
const[selDate,setSelDate]=useState(getD());
const[selMeal,setSelMeal]=useState(null);
const[newWt,setNewWt]=useState('');
const[newUser,setNewUser]=useState('');
const[editProfile,setEditProfile]=useState(null);
const[foodPhoto,setFoodPhoto]=useState(null);
const[xpAnim,setXpAnim]=useState(null);
const[lightMode,setLightMode]=useState(false);
const[editingItem,setEditingItem]=useState(null);
const[editItemText,setEditItemText]=useState('');
const[editItemSuggestion,setEditItemSuggestion]=useState(null);
const[editItemLoading,setEditItemLoading]=useState(false);
const[addingItem,setAddingItem]=useState(false);
const[addItemText,setAddItemText]=useState('');
const[addItemSuggestion,setAddItemSuggestion]=useState(null);
const[photoQueue,setPhotoQueue]=useState([]);
const[queueProcessing,setQueueProcessing]=useState(false);
const[rateLimitMsg,setRateLimitMsg]=useState(null);
const[voiceRecording,setVoiceRecording]=useState(false);
const[voiceTranscript,setVoiceTranscript]=useState('');
const[voiceProcessing,setVoiceProcessing]=useState(false);
const[voiceFallback,setVoiceFallback]=useState(false);
const[voiceFallbackText,setVoiceFallbackText]=useState('');
const[apiUsageData,setApiUsageData]=useState({});
const[apiUsageDate,setApiUsageDate]=useState('today');
const[apiUsageFriendCodes,setApiUsageFriendCodes]=useState({});
const[updateAvailable,setUpdateAvailable]=useState(null);
const[showPatchNotes,setShowPatchNotes]=useState(false);
const lastSeenVersion=st.get('nt_last_version')||'';
const hasNewPatch=lastSeenVersion!==APP_VERSION;
const[mealReminder,setMealReminder]=useState(null);
const[showReminder,setShowReminder]=useState(true);
// Partner feature states
const[firebaseConfig,setFirebaseConfig]=useState(null);
const[firebaseConnected,setFirebaseConnected]=useState(false);
const[partnerData,setPartnerData]=useState(null);
const[partnerCode,setPartnerCode]=useState('');
const[linkCode,setLinkCode]=useState('');
const[linkError,setLinkError]=useState('');
const[nudges,setNudges]=useState([]);
const[sharedGoals,setSharedGoals]=useState([]);
const[mealIdeas,setMealIdeas]=useState([]);
const[nudgeMessage,setNudgeMessage]=useState('');
const[showNudgeBanner,setShowNudgeBanner]=useState(true);
const[newGoal,setNewGoal]=useState({title:'',type:'both_hit',target:7});
const[newMealIdea,setNewMealIdea]=useState({name:'',photo:null});
const[celebrateGoal,setCelebrateGoal]=useState(null);
// Friends system states
const[friends,setFriends]=useState([]);
const[friendsData,setFriendsData]=useState({});
const[activityFeed,setActivityFeed]=useState([]);
const[groupChallenges,setGroupChallenges]=useState([]);
const[leaderboardPeriod,setLeaderboardPeriod]=useState('daily');
const[friendTab,setFriendTab]=useState('leaderboard');
const[addFriendCode,setAddFriendCode]=useState('');
const[addFriendError,setAddFriendError]=useState('');
const[newChallenge,setNewChallenge]=useState({title:'',type:'log_daily',target:7,days:7});
const[friendsNotify,setFriendsNotify]=useState(false);
const[homeSections,setHomeSections]=useState(null);
const[badgeToast,setBadgeToast]=useState(null);
const[nudgeFriendId,setNudgeFriendId]=useState(null);
const[nudgeFriendName,setNudgeFriendName]=useState('');
const[nudgeFriendMsg,setNudgeFriendMsg]=useState('');
const[barcodeScanning,setBarcodeScanning]=useState(false);
const[barcodeError,setBarcodeError]=useState('');
const barcodeVideoRef=useRef(null);
const barcodeStreamRef=useRef(null);
const firebaseListeners=useRef([]);
const voiceTranscriptRef=useRef('');

useEffect(()=>{
  const u=JSON.parse(st.get('nt_users')||'{}'),c=st.get('nt_cur'),a=st.get('nt_api')||'',lm=st.get('nt_light')==='true';
  const fbConfig=JSON.parse(st.get('nt_firebase')||'null');
  setUsers(u);setApi(a);setLightMode(lm);setFirebaseConfig(fbConfig||FIREBASE_CONFIG);
  if(lm)document.documentElement.classList.add('light');
  // Auto-connect with built-in config, or saved config
  if(initFirebase(fbConfig||FIREBASE_CONFIG)){setFirebaseConnected(true)}
  // Show splash then transition
  setTimeout(()=>{
    if(c&&u[c]&&u[c].profile){setCur(c);reset(u,c);setView('app');checkMealReminder(u,c)}else setView('select');
    playClick();
  },1500);
},[]);

// Auto-check for app updates on load
useEffect(()=>{
  const checkUpdate=async()=>{
    try{
      const res=await fetch(window.location.origin+'/index.html?_cb='+Date.now(),{cache:'no-store'});
      const text=await res.text();
      const match=text.match(/APP_VERSION='([^']+)'/);
      if(match&&match[1]!==APP_VERSION)setUpdateAvailable(match[1]);
    }catch(e){}
  };
  setTimeout(checkUpdate,3000);
},[]);

// Setup Firebase listeners when user changes or connection established
useEffect(()=>{
  if(!firebaseConnected||!cur||!users[cur])return;
  const ud=users[cur];

  // Ensure user has Firebase ID and partner code
  if(!ud.oddd){
    const newU={...users};
    newU[cur]={...ud,oddd:genUserId(),partnerCode:genPartnerCode()};
    save(newU);
    return;
  }

  setPartnerCode(ud.partnerCode||'');

  // Sync user data to Firebase
  syncToFirebase(ud);

  // Setup listeners
  setupFirebaseListeners(ud);
  setupFriendsListeners(ud);

  return ()=>{
    firebaseListeners.current.forEach(unsub=>unsub());
    firebaseListeners.current=[];
  };
},[firebaseConnected,cur,users[cur]?.oddd]);

const syncToFirebase=useCallback((ud)=>{
  if(!db||!ud?.oddd)return;
  const todayLog=ud.log||[];
  const todayCals=todayLog.reduce((a,m)=>a+(m.calories||0),0);
  const todayPro=todayLog.reduce((a,m)=>a+(m.protein||0),0);
  db.ref(`users/${ud.oddd}`).update({
    profile:{name:cur,partnerCode:ud.partnerCode,linkedTo:ud.linkedTo||null,profilePic:ud.profilePic||null},
    today:{calories:Math.round(todayCals),protein:Math.round(todayPro),mealsLogged:todayLog.length,lastActive:Date.now(),streak:ud.streak||0}
  });
},[cur]);

const setupFirebaseListeners=useCallback((ud)=>{
  if(!db||!ud?.oddd)return;

  // Listen to friendGroup goals
  const goalsRef=db.ref(`users/${ud.oddd}/friendGroup/goals`);
  goalsRef.on('value',snap=>{
    const data=snap.val()||{};
    setSharedGoals(Object.entries(data).map(([k,v])=>({id:k,...v})));
  });
  firebaseListeners.current.push(()=>goalsRef.off());

  // Listen to friendGroup meal ideas
  const mealsRef=db.ref(`users/${ud.oddd}/friendGroup/mealIdeas`);
  mealsRef.on('value',snap=>{
    const data=snap.val()||{};
    setMealIdeas(Object.entries(data).map(([k,v])=>({id:k,...v})));
  });
  firebaseListeners.current.push(()=>mealsRef.off());
},[]);

const addSharedGoal=async()=>{
  if(!db||!newGoal.title)return;
  const ud=users[cur];
  if(!ud?.oddd)return;

  const goalData={
    ...newGoal,
    createdBy:ud.oddd,
    createdByName:cur,
    current:0,
    progress:{[ud.oddd]:0},
    createdAt:Date.now(),
    expiresAt:Date.now()+7*24*60*60*1000 // 1 week
  };

  await db.ref(`users/${ud.oddd}/friendGroup/goals`).push(goalData);
  setNewGoal({title:'',type:'both_hit',target:7});
  setModal(null);
};

const updateGoalProgress=async(goalId,amount)=>{
  const ud=users[cur];
  if(!ud?.oddd)return;
  const goalRef=db.ref(`users/${ud.oddd}/friendGroup/goals/${goalId}`);
  const snap=await goalRef.once('value');
  const goal=snap.val();
  if(!goal)return;

  const newProgress={...goal.progress,[ud.oddd]:(goal.progress[ud.oddd]||0)+amount};
  const newCurrent=Object.values(newProgress).reduce((a,b)=>a+b,0);

  await goalRef.update({progress:newProgress,current:newCurrent});

  // Check if goal completed
  if(newCurrent>=goal.target&&goal.current<goal.target){
    setCelebrateGoal(goal.title);
    setTimeout(()=>setCelebrateGoal(null),3000);
  }
};

const deleteGoal=async(goalId)=>{
  const ud=users[cur];
  if(!ud?.oddd)return;
  await db.ref(`users/${ud.oddd}/friendGroup/goals/${goalId}`).remove();
};

const suggestMeal=async()=>{
  if(!db||!newMealIdea.name)return;
  const ud=users[cur];
  if(!ud?.oddd)return;

  const ideaData={
    from:ud.oddd,
    fromName:cur,
    name:newMealIdea.name,
    photo:newMealIdea.photo||null,
    votes:{},
    createdAt:Date.now()
  };

  await db.ref(`users/${ud.oddd}/friendGroup/mealIdeas`).push(ideaData);
  setNewMealIdea({name:'',photo:null});
  setModal(null);
};

const voteMealIdea=async(ideaId,vote)=>{
  const ud=users[cur];
  if(!ud?.oddd)return;
  await db.ref(`users/${ud.oddd}/friendGroup/mealIdeas/${ideaId}/votes/${ud.oddd}`).set(vote);
};

const deleteMealIdea=async(ideaId)=>{
  const ud=users[cur];
  if(!ud?.oddd)return;
  await db.ref(`users/${ud.oddd}/friendGroup/mealIdeas/${ideaId}`).remove();
};

const saveFirebaseConfig=(config)=>{
  st.set('nt_firebase',JSON.stringify(config));
  setFirebaseConfig(config);
  if(initFirebase(config)){
    setFirebaseConnected(true);
    // Generate partner code for current user if needed
    if(cur&&users[cur]&&!users[cur].oddd){
      const newU={...users};
      newU[cur]={...users[cur],oddd:genUserId(),partnerCode:genPartnerCode()};
      save(newU);
    }
  }
};

// === Friends System ===
const addFriend=async()=>{
  if(!db||!addFriendCode||addFriendCode.length!==6)return setAddFriendError('Enter a 6-character code');
  setAddFriendError('');
  const ud=users[cur];
  if(!ud?.oddd)return setAddFriendError('Firebase not ready');
  if(friends.length>=10)return setAddFriendError('Max 10 friends');
  const snap=await db.ref('users').orderByChild('profile/partnerCode').equalTo(addFriendCode.toUpperCase()).once('value');
  const found=snap.val();
  if(!found)return setAddFriendError('User not found');
  const friendId=Object.keys(found)[0];
  if(friendId===ud.oddd)return setAddFriendError('Cannot add yourself');
  if(friends.some(f=>f.userId===friendId))return setAddFriendError('Already friends');
  const friendProfile=found[friendId].profile||{};
  const friendData={userId:friendId,name:friendProfile.name||'Friend',code:addFriendCode.toUpperCase(),addedAt:Date.now()};
  await db.ref(`users/${ud.oddd}/friends/${friendId}`).set(friendData);
  // Add reverse friendship
  await db.ref(`users/${friendId}/friends/${ud.oddd}`).set({userId:ud.oddd,name:cur,code:ud.partnerCode,addedAt:Date.now()});
  setAddFriendCode('');
  setAddFriendError('');
  // Post activity
  postActivity('friend_added',`became friends with ${friendProfile.name||'someone'}`);
};

const removeFriend=async(friendId)=>{
  if(!db)return;
  const ud=users[cur];
  if(!ud?.oddd)return;
  await db.ref(`users/${ud.oddd}/friends/${friendId}`).remove();
  await db.ref(`users/${friendId}/friends/${ud.oddd}`).remove();
  setFriendsData(prev=>{const n={...prev};delete n[friendId];return n});
};

const postActivity=async(type,message,photo=null)=>{
  if(!db)return;
  const ud=users[cur];
  if(!ud?.oddd)return;
  const event={type,userId:ud.oddd,userName:cur,message,timestamp:Date.now()};
  if(photo)event.photo=photo;
  await db.ref(`activity/${ud.oddd}`).push(event);
  // Trim to last 50 events
  const snap=await db.ref(`activity/${ud.oddd}`).orderByChild('timestamp').limitToLast(50).once('value');
  const all=snap.val()||{};
  const keys=Object.keys(all);
  if(keys.length>50){
    const toRemove=keys.slice(0,keys.length-50);
    const updates={};
    toRemove.forEach(k=>updates[k]=null);
    await db.ref(`activity/${ud.oddd}`).update(updates);
  }
};

const createChallenge=async()=>{
  if(!db||!newChallenge.title)return;
  const ud=users[cur];
  if(!ud?.oddd)return;
  const participants={[ud.oddd]:0};
  friends.forEach(f=>participants[f.userId]=0);
  const challengeData={
    title:newChallenge.title,
    type:newChallenge.type,
    target:newChallenge.target,
    createdBy:ud.oddd,
    createdByName:cur,
    participants,
    startDate:Date.now(),
    endDate:Date.now()+newChallenge.days*24*60*60*1000,
    completed:false
  };
  await db.ref('groupChallenges').push(challengeData);
  setNewChallenge({title:'',type:'log_daily',target:7,days:7});
  setModal(null);
  postActivity('challenge_created',`created challenge: ${newChallenge.title}`);
};

const updateChallengeProgress=async(challengeId,amount)=>{
  if(!db)return;
  const ud=users[cur];
  if(!ud?.oddd)return;
  const ref=db.ref(`groupChallenges/${challengeId}`);
  const snap=await ref.once('value');
  const ch=snap.val();
  if(!ch||ch.completed)return;
  const newVal=(ch.participants[ud.oddd]||0)+amount;
  await ref.child(`participants/${ud.oddd}`).set(newVal);
  const total=Object.values({...ch.participants,[ud.oddd]:newVal}).reduce((a,b)=>a+b,0);
  if(ch.type!=='total_meals'&&newVal>=ch.target){
    postActivity('challenge_progress',`completed their part of "${ch.title}"!`);
  }
  if((ch.type==='total_meals'&&total>=ch.target)||(ch.type!=='total_meals'&&Object.values({...ch.participants,[ud.oddd]:newVal}).every(v=>v>=ch.target))){
    await ref.child('completed').set(true);
    setCelebrateGoal(`Challenge Complete: ${ch.title}`);
    showConfetti();
    setTimeout(()=>setCelebrateGoal(null),3000);
  }
};

const setupFriendsListeners=useCallback((ud)=>{
  if(!db||!ud?.oddd)return;
  // Listen to friends list
  const friendsRef=db.ref(`users/${ud.oddd}/friends`);
  friendsRef.on('value',snap=>{
    const data=snap.val()||{};
    const friendList=Object.values(data);
    setFriends(friendList);
    // Setup listeners for each friend's data
    friendList.forEach(f=>{
      const fRef=db.ref(`users/${f.userId}/today`);
      fRef.on('value',fSnap=>{
        const fData=fSnap.val();
        if(fData)setFriendsData(prev=>({...prev,[f.userId]:fData}));
      });
      firebaseListeners.current.push(()=>fRef.off());
    });
    // Listen to friends' activity
    const allActivity=[];
    friendList.forEach(f=>{
      const actRef=db.ref(`activity/${f.userId}`).orderByChild('timestamp').limitToLast(20);
      actRef.on('value',aSnap=>{
        const events=aSnap.val()||{};
        const eventList=Object.values(events);
        setActivityFeed(prev=>{
          const filtered=prev.filter(e=>e.userId!==f.userId);
          const merged=[...filtered,...eventList].sort((a,b)=>b.timestamp-a.timestamp).slice(0,50);
          if(merged.length>prev.length)setFriendsNotify(true);
          return merged;
        });
      });
      firebaseListeners.current.push(()=>actRef.off());
    });
  });
  firebaseListeners.current.push(()=>friendsRef.off());

  // Listen to group challenges involving this user
  const challengeRef=db.ref('groupChallenges').orderByChild(`participants/${ud.oddd}`);
  challengeRef.on('value',snap=>{
    const data=snap.val()||{};
    const challengeList=Object.entries(data).filter(([k,v])=>v.participants&&v.participants.hasOwnProperty(ud.oddd)).map(([k,v])=>({id:k,...v}));
    setGroupChallenges(challengeList.filter(c=>!c.completed||Date.now()-c.endDate<24*60*60*1000));
  });
  firebaseListeners.current.push(()=>challengeRef.off());
},[]);

const getLeaderboard=()=>{
  const ud=users[cur];
  if(!ud?.oddd)return[];
  const entries=[{id:ud.oddd,name:cur,calories:tot.calories,protein:tot.protein,meals:log.length,streak:streak,isMe:true}];
  friends.forEach(f=>{
    const d=friendsData[f.userId]||{};
    entries.push({id:f.userId,name:f.name,calories:d.calories||0,protein:d.protein||0,meals:d.mealsLogged||0,streak:d.streak||0,isMe:false});
  });
  return entries.sort((a,b)=>b.calories-a.calories);
};

const getTimeAgo=(ts)=>{
  const diff=Date.now()-ts;
  if(diff<60000)return'just now';
  if(diff<3600000)return Math.floor(diff/60000)+'m ago';
  if(diff<86400000)return Math.floor(diff/3600000)+'h ago';
  return Math.floor(diff/86400000)+'d ago';
};

const checkMealReminder=(u,name)=>{
  const d=u[name];if(!d||d.remindersOff)return;
  const mealTimes=d.mealTimes||{};
  const now=new Date();const currentMins=now.getHours()*60+now.getMinutes();
  const todayLog=d.log||[];
  const categories=['Breakfast','Lunch','Dinner','Snack'];
  for(const cat of categories){
    const times=mealTimes[cat]||[];if(times.length<2)continue;
    // Calculate average time
    const mins=times.map(t=>{const[h,m]=t.split(':').map(Number);return h*60+m});
    const avgMins=Math.round(mins.reduce((a,b)=>a+b,0)/mins.length);
    // Check if within 30 mins of typical time
    if(Math.abs(currentMins-avgMins)<=30){
      // Check if not logged today
      if(!todayLog.some(m=>m.category===cat)){
        const avgH=Math.floor(avgMins/60),avgM=avgMins%60;
        setMealReminder({category:cat,time:`${avgH}:${avgM.toString().padStart(2,'0')}`});
        return;
      }
    }
  }
};

const getWeekId=(dateStr)=>{const d=new Date(dateStr.split('/').reverse().join('-'));const jan1=new Date(d.getFullYear(),0,1);const days=Math.floor((d-jan1)/86400000);return d.getFullYear()+'W'+String(Math.ceil((days+jan1.getDay()+1)/7)).padStart(2,'0')};
const saveWeeklyStats=(d)=>{if(!d.hist||!d.hist.length)return;const thisWeek=getWeekId(getD());const lastLog=d.hist[d.hist.length-1];const lastWeek=getWeekId(lastLog.date);if(lastWeek===thisWeek)return;const weekHist=(d.hist||[]).filter(h=>getWeekId(h.date)===lastWeek);if(!weekHist.length)return;const days=weekHist.length;const totals={...EMPTY};weekHist.forEach(h=>(h.meals||[]).forEach(m=>Object.keys(EMPTY).forEach(k=>totals[k]+=(m[k]||0))));const avgs={};Object.keys(EMPTY).forEach(k=>avgs[k]=Math.round(totals[k]/days));const avgWater=Math.round(weekHist.reduce((a,h)=>a+(h.water||0),0)/days);const weekStart=weekHist[0].date;const weekEnd=weekHist[weekHist.length-1].date;d.weeklyLogs=[...(d.weeklyLogs||[]),{weekId:lastWeek,start:weekStart,end:weekEnd,days,avgs,avgWater,totalMeals:weekHist.reduce((a,h)=>a+(h.meals||[]).length,0)}].slice(-52)};
const reset=(u,c)=>{const d=u[c];if(!d)return;const today=getD();if(d.last&&d.last!==today){if(d.log&&d.log.length){d.hist=[...(d.hist||[]),{date:d.last,meals:d.log,water:d.water||0}].slice(-90);d.streak=(d.streak||0)+1;if(d.streak===7)addXp(u,c,XP_ACTIONS.streak7);if(d.streak===30)addXp(u,c,XP_ACTIONS.streak30)}else d.streak=0;saveWeeklyStats(d);d.log=[];d.water=0}d.last=today;u[c]=d;setUsers(u);st.set('nt_users',JSON.stringify(u))};
const save=d=>{setUsers(d);st.set('nt_users',JSON.stringify(d))};
const addXp=(u,name,amt)=>{if(u[name]?.gamificationOn!==true)return;const d=u[name];d.xp=(d.xp||0)+amt;setXpAnim({amt,key:Date.now()});setTimeout(()=>setXpAnim(null),2000)};
const toggleSection=(key)=>{const ns={...sections,[key]:!sections[key]};setHomeSections(ns);const u={...users};u[cur]={...ud,homeSections:ns};save(u)};
const checkBadges=()=>{if(!gamificationOn)return;const newBadge=BADGES.find(b=>b.check(stats)&&!seenBadges.includes(b.id));if(newBadge){setBadgeToast(newBadge);const u={...users};u[cur]={...ud,seenBadges:[...seenBadges,newBadge.id]};save(u);setTimeout(()=>setBadgeToast(null),4000)}};
const sendFriendNudge=async(friendId,message)=>{if(!db)return;const ud2=users[cur];if(!ud2?.oddd)return;await db.ref(`activity/${friendId}/nudges`).push({from:ud2.oddd,fromName:cur,message:message||'Log your meals!',timestamp:Date.now(),seen:false});setModal(null);setNudgeFriendMsg('')};
const pick=n=>{setCur(n);st.set('nt_cur',n);if(users[n]&&users[n].profile){reset(users,n);setView('app')}else setView('setup')};
const addUser=()=>{if(!newUser.trim())return;pick(newUser.trim());setNewUser('')};
const delUser=n=>{const u={...users};delete u[n];save(u);if(cur===n){st.set('nt_cur','');setCur(null);setView('select')}};
const toKg=w=>setup.weightUnit==='lbs'?r2(w/2.205):w;
const toCm=()=>setup.heightUnit==='ft'?(+setup.heightFt*30.48)+(+setup.heightIn*2.54):+setup.height;
const done=()=>{const wKg=toKg(+setup.weight),hCm=toCm();const prof={...setup,weight:wKg,height:hCm};const t=calcT(prof);save({...users,[cur]:{profile:prof,targets:t,log:[],hist:[],last:getD(),streak:0,water:0,waterGoal:2000,primary:'calories',weights:[{date:getD(),weight:wKg}],xp:0,totalMeals:0,waterGoals:0,proteinGoals:0,perfectDays:0,gamificationOn:setup.gamificationOn,hydrationOn:setup.hydrationOn}});setView('app')};

const ud=users[cur]||{},log=ud.log||[],tgt=ud.targets||EMPTY,hist=ud.hist||[],streak=ud.streak||0,profile=ud.profile||{},water=ud.water||0,waterGoal=ud.waterGoal||2000,weights=ud.weights||[];
const gamificationOn=ud.gamificationOn===true;
const hydrationOn=ud.hydrationOn===true;
const dp=ud.displayPrefs||{showSugar:true,showGutHealth:true,hiddenMacros:[]};
const selectedMacros=(()=>{let sm=ud.selectedMacros||['protein','carbs','fat','sugar'];if(sm.length===3&&sm[0]==='protein'&&sm[1]==='carbs'&&sm[2]==='fat')sm=[...sm,'sugar'];if(!dp.showSugar)sm=sm.filter(k=>k!=='sugar');return sm})();
const sections=homeSections||(ud.homeSections)||{...DEFAULT_SECTIONS};
const seenBadges=ud.seenBadges||[];
const xp=ud.xp||0,lvl=getLevel(xp);
const stats={...ud,level:lvl.level,totalMeals:ud.totalMeals||0,waterGoals:ud.waterGoals||0,proteinGoals:ud.proteinGoals||0,perfectDays:ud.perfectDays||0,streak};
const getLogs=date=>date===getD()?log:(hist.find(h=>h.date===date)||{}).meals||[];
const logs=getLogs(selDate);
const tot=logs.reduce((a,e)=>{Object.keys(EMPTY).forEach(k=>a[k]+=(e[k]||0));return a},{...EMPTY});

const compress=(file,maxW=800)=>new Promise(res=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(w>maxW){h=(h*maxW)/w;w=maxW}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',0.7))};img.src=e.target.result};rd.readAsDataURL(file)});

const compressForStorage=(base64,maxW=400)=>new Promise(res=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(w>maxW){h=(h*maxW)/w;w=maxW}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',0.5))};img.src=base64});

const getStorageUsage=()=>{let total=0;for(let k in localStorage){if(localStorage.hasOwnProperty(k))total+=localStorage[k].length*2}return total};
const STORAGE_LIMIT=4*1024*1024; // 4MB safe limit

const generateShareImage=(photoBase64,macros,items,category,time)=>new Promise((res,rej)=>{
  const W=1080,H=1350;
  const cv=document.createElement('canvas');cv.width=W;cv.height=H;
  const ctx=cv.getContext('2d');
  const img=new Image();
  img.onload=()=>{
    // Draw food photo scaled to fill width, cropped at bottom
    const imgAspect=img.width/img.height,canvasAspect=W/(H*0.65);
    let sx=0,sy=0,sw=img.width,sh=img.height;
    if(imgAspect>canvasAspect){sw=img.height*canvasAspect;sx=(img.width-sw)/2}
    else{sh=img.width/canvasAspect;sy=(img.height-sh)/2}
    ctx.drawImage(img,sx,sy,sw,sh,0,0,W,H*0.65);

    // Dark gradient overlay
    const grad=ctx.createLinearGradient(0,H*0.65,0,H);
    grad.addColorStop(0,'rgba(15,15,35,0)');
    grad.addColorStop(0.3,'rgba(15,15,35,0.9)');
    grad.addColorStop(1,'rgba(15,15,35,1)');
    ctx.fillStyle=grad;ctx.fillRect(0,H*0.65,W,H*0.35);

    // Meal type and time
    const icons={Breakfast:'ðŸŒ…',Lunch:'â˜€ï¸',Dinner:'ðŸŒ™',Snack:'ðŸ¿'};
    ctx.font='bold 42px -apple-system,BlinkMacSystemFont,sans-serif';
    ctx.fillStyle='#fff';
    ctx.textAlign='center';
    ctx.fillText(`${icons[category]||'ðŸ½ï¸'} ${category} at ${time}`,W/2,H*0.73);

    // Macro boxes - 4 in a row
    const macroData=[
      {icon:'ðŸ”¥',label:'Calories',value:Math.round(macros.calories||0),unit:''},
      {icon:'ðŸ’ª',label:'Protein',value:Math.round(macros.protein||0),unit:'g'},
      {icon:'ðŸŒ¾',label:'Carbs',value:Math.round(macros.carbs||0),unit:'g'},
      {icon:'ðŸ«’',label:'Fat',value:Math.round(macros.fat||0),unit:'g'}
    ];
    const boxW=220,boxH=100,boxY=H*0.77,gap=24;
    const startX=(W-(boxW*4+gap*3))/2;

    macroData.forEach((m,i)=>{
      const x=startX+i*(boxW+gap);
      // Box background
      ctx.fillStyle='rgba(255,255,255,0.1)';
      ctx.beginPath();
      ctx.roundRect(x,boxY,boxW,boxH,16);
      ctx.fill();
      // Icon
      ctx.font='28px sans-serif';
      ctx.textAlign='center';
      ctx.fillText(m.icon,x+boxW/2,boxY+35);
      // Value
      ctx.font='bold 32px -apple-system,sans-serif';
      ctx.fillStyle='#10b981';
      ctx.fillText(`${m.value}${m.unit}`,x+boxW/2,boxY+70);
      // Label
      ctx.font='16px -apple-system,sans-serif';
      ctx.fillStyle='rgba(255,255,255,0.6)';
      ctx.fillText(m.label,x+boxW/2,boxY+92);
    });

    // Food items
    const itemNames=(items||[]).map(i=>i.name).join(', ');
    if(itemNames){
      ctx.font='28px -apple-system,sans-serif';
      ctx.fillStyle='#fff';
      ctx.textAlign='center';
      const maxW=W-80;
      let displayText=itemNames;
      if(ctx.measureText(displayText).width>maxW){
        while(ctx.measureText(displayText+'...').width>maxW&&displayText.length>0)displayText=displayText.slice(0,-1);
        displayText+='...';
      }
      ctx.fillText(displayText,W/2,H*0.9);
    }

    // Macrely branding
    ctx.font='bold 24px -apple-system,sans-serif';
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.textAlign='center';
    ctx.fillText('Tracked with Macrely ðŸ…',W/2,H-40);

    res(cv.toDataURL('image/jpeg',0.9));
  };
  img.onerror=()=>rej(new Error('Failed to load image'));
  img.src=photoBase64;
});

const shareMeal=async(photo,macros,items,category,time)=>{
  if(!photo)return alert('No photo to share');
  try{
    const shareImg=await generateShareImage(photo,macros,items,category,time);
    const blob=await(await fetch(shareImg)).blob();
    const file=new File([blob],'nutritrack-meal.jpg',{type:'image/jpeg'});
    if(navigator.canShare&&navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'My meal',text:`${category} - ${Math.round(macros.calories)} calories`});
    }else{
      const a=document.createElement('a');a.href=shareImg;a.download='nutritrack-meal.jpg';a.click();
    }
  }catch(e){if(e.name!=='AbortError')alert('Share failed: '+e.message)}
};

const is429=(err)=>err&&(String(err.message||err).includes('429')||String(err.message||err).toLowerCase().includes('resource exhausted')||String(err.message||err).toLowerCase().includes('rate limit'));
const showRateLimit=()=>{setRateLimitMsg('Too many requests this minute. Your photo has been queued and will be processed automatically when the limit resets.');setTimeout(()=>setRateLimitMsg(null),8000)};

const processQueue=async(queue)=>{
  if(queue.length===0)return;
  setQueueProcessing(true);
  for(let qi=0;qi<queue.length;qi++){
    const qItem=queue[qi];
    let success=false;
    for(let attempt=0;attempt<2&&!success;attempt++){
      try{
        await new Promise(r=>setTimeout(r,65000));
        const b64=qItem.imgData.split(',')[1];
        const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'Expert nutritionist: analyze this food photo carefully. Estimate the actual visible portion size as accurately as possible â€” use visual cues like plate size, utensil scale, and food depth to judge grams. Do NOT default to generic serving sizes; estimate what is actually shown. Use USDA nutritional data. Return accurate real-world nutritional values â€” do NOT return zeros.'+(dp.showGutHealth?'For each item include "gutHealth" (1-10 score, 10=excellent for gut) and "gutTip" (short tip about gut impact).':'')+' Return ONLY JSON: {"items":[{"name":"food","quantity":"150g","calories":250,"protein":20,"carbs":30,"fat":10,"fiber":3,"sugar":5,"sodium":400,"saturatedFat":3,"cholesterol":25,"potassium":200,"vitaminA":50,"vitaminC":10,"vitaminD":0,"iron":2,"calcium":40'+(dp.showGutHealth?',"gutHealth":7,"gutTip":"High in fiber"':'')+'}],"totals":{same fields}}'},{inlineData:{mimeType:'image/jpeg',data:b64}}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});
        const d=await res.json();
        if(d.error&&is429(d.error)){continue}
        if(d.error){continue}
        const txt=(d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts&&d.candidates[0].content.parts[0].text)||'';
        const s=txt.indexOf('{'),en=txt.lastIndexOf('}');
        if(s===-1)continue;
        const j=JSON.parse(txt.substring(s,en+1));
        if(!j.totals&&j.items){j.totals={};Object.keys(EMPTY).forEach(k=>j.totals[k]=j.items.reduce((a,i)=>a+(i[k]||0),0))}
        setFoodPhoto(qItem.imgData);
        setPending({...j.totals,items:j.items||[],category:qItem.category,time:qItem.time,date:qItem.date});
        setModal('confirm');
        success=true;
      }catch(e){if(!is429(e))break}
    }
    setPhotoQueue(prev=>prev.filter((_,i)=>i>0));
  }
  setQueueProcessing(false);
};

const photo=async e=>{const file=e.target.files&&e.target.files[0];if(!file)return;if(!api){alert('Set API key in Settings');return}setModal(null);setLoading(true);try{const usage=JSON.parse(st.get('nt_api_usage')||'{}');usage[getD()]=(usage[getD()]||0)+1;st.set('nt_api_usage',JSON.stringify(usage));const imgData=await compress(file);setFoodPhoto(imgData);const b64=imgData.split(',')[1];const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'Expert nutritionist: analyze this food photo carefully. Estimate the actual visible portion size as accurately as possible â€” use visual cues like plate size, utensil scale, and food depth to judge grams. Do NOT default to generic serving sizes; estimate what is actually shown. Use USDA nutritional data. Return accurate real-world nutritional values â€” do NOT return zeros.'+(dp.showGutHealth?'For each item include "gutHealth" (1-10 score, 10=excellent for gut) and "gutTip" (short tip about gut impact).':'')+' Return ONLY JSON: {"items":[{"name":"food","quantity":"150g","calories":250,"protein":20,"carbs":30,"fat":10,"fiber":3,"sugar":5,"sodium":400,"saturatedFat":3,"cholesterol":25,"potassium":200,"vitaminA":50,"vitaminC":10,"vitaminD":0,"iron":2,"calcium":40'+(dp.showGutHealth?',"gutHealth":7,"gutTip":"High in fiber"':'')+'}],"totals":{same fields}}'},{inlineData:{mimeType:'image/jpeg',data:b64}}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});const d=await res.json();if(d.error){if(is429(d.error)){const photoDate=file.lastModified?new Date(file.lastModified):new Date();const ph=photoDate.getHours();const pCat=ph>=5&&ph<11?'Breakfast':ph>=11&&ph<16?'Lunch':ph>=16&&ph<22?'Dinner':'Snack';const pTime=photoDate.toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});const qItem={imgData,category:pCat,time:pTime,date:getD(photoDate),addedAt:Date.now()};setPhotoQueue(prev=>{const nq=[...prev,qItem];if(!queueProcessing)processQueue(nq);return nq});showRateLimit();setLoading(false);return}alert('Error: '+d.error.message);setLoading(false);return}const txt=(d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts&&d.candidates[0].content.parts[0].text)||'';const s=txt.indexOf('{'),en=txt.lastIndexOf('}');if(s===-1){alert('No response');setLoading(false);return}const j=JSON.parse(txt.substring(s,en+1));if(!j.totals&&j.items){j.totals={};Object.keys(EMPTY).forEach(k=>j.totals[k]=j.items.reduce((a,i)=>a+(i[k]||0),0))}const photoDate=file.lastModified?new Date(file.lastModified):new Date();const ph=photoDate.getHours();const pCat=ph>=5&&ph<11?'Breakfast':ph>=11&&ph<16?'Lunch':ph>=16&&ph<22?'Dinner':'Snack';const pTime=photoDate.toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});setPending({...j.totals,items:j.items||[],category:pCat,time:pTime,date:getD(photoDate)});setModal('confirm');logApiUsage()}catch(err){if(is429(err)){const imgData=await compress(file);const photoDate=file.lastModified?new Date(file.lastModified):new Date();const ph=photoDate.getHours();const pCat=ph>=5&&ph<11?'Breakfast':ph>=11&&ph<16?'Lunch':ph>=16&&ph<22?'Dinner':'Snack';const pTime=photoDate.toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});const qItem={imgData,category:pCat,time:pTime,date:getD(photoDate),addedAt:Date.now()};setPhotoQueue(prev=>{const nq=[...prev,qItem];if(!queueProcessing)processQueue(nq);return nq});showRateLimit()}else{alert('Error: '+err.message)}}setLoading(false)};

const recalcPending=(items)=>{const totals={};Object.keys(EMPTY).forEach(k=>totals[k]=items.reduce((a,i)=>a+(i[k]||0),0));setPending(p=>({...totals,items,category:p.category,time:p.time,date:p.date}))};

const removeIngredient=(idx)=>{const items=[...(pending.items||[])];items.splice(idx,1);recalcPending(items);setEditingItem(null)};

const replaceIngredient=(idx,item)=>{const items=[...(pending.items||[])];items[idx]=item;recalcPending(items);setEditingItem(null);setEditItemText('');setEditItemSuggestion(null)};
const appendIngredient=(item)=>{const items=[...(pending.items||[]),item];recalcPending(items);setAddingItem(false);setAddItemText('');setAddItemSuggestion(null)};

const logApiUsage=()=>{if(db&&ud.oddd){const dateKey=getD().replace(/\//g,'-');db.ref(`apiUsage/${dateKey}/${cur}`).transaction(v=>(v||0)+1)}};

const aiCleanupItem=async(text,addMode=false)=>{if(!api){alert('Set API key in Settings');return}setEditItemLoading(true);setEditItemSuggestion(null);try{const gutPrompt=dp.showGutHealth?', "gutHealth": <1-10 score for gut health>, "gutTip": "<short gut health tip>"':'';const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`You are an expert nutritionist with USDA data knowledge. The user typed: '${text}'. Clean up their input: fix spelling, expand abbreviations (tbsp = tablespoon, etc), identify the brand if mentioned. Return accurate real-world nutritional values based on USDA data â€” do NOT return zeros. Look up the actual calories, protein, carbs, fat, and all micronutrients for this food item and quantity. Return ONLY JSON: {"name":"cleaned food name with brand","quantity":"estimated amount","calories":<real number>,"protein":<real number>,"carbs":<real number>,"fat":<real number>,"fiber":<real number>,"sugar":<real number>,"sodium":<real number>,"saturatedFat":<real number>,"cholesterol":<real number>,"potassium":<real number>,"vitaminA":<real number>,"vitaminC":<real number>,"vitaminD":<real number>,"iron":<real number>,"calcium":<real number>${gutPrompt}}`}]}],generationConfig:{temperature:0.3,maxOutputTokens:1024}})});const d=await res.json();if(d.error){if(is429(d.error)){showRateLimit()}else{alert('Error: '+d.error.message)}setEditItemLoading(false);return}const txt=(d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts&&d.candidates[0].content.parts[0].text)||'';const s=txt.indexOf('{'),en=txt.lastIndexOf('}');if(s!==-1){const parsed=JSON.parse(txt.substring(s,en+1));if(addMode){setAddItemSuggestion(parsed)}else{setEditItemSuggestion(parsed)}logApiUsage()}else{alert('Could not parse AI response')}}catch(err){if(is429(err)){showRateLimit()}else{alert('Error: '+err.message)}}setEditItemLoading(false)};

const processVoiceMeal=async(transcript)=>{if(!api){alert('Set API key in Settings');return}setVoiceProcessing(true);try{const gutPrompt=dp.showGutHealth?', "gutHealth": <1-10>, "gutTip": "<tip>"':'';const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`You are an expert nutritionist. The user described what they ate via voice:\n"${transcript}"\n\nParse this into individual food items. For each item, estimate a reasonable quantity based on common serving sizes. Return accurate USDA nutritional values. Do NOT return zeros.\n\nONLY include a "clarify" field if the quantity is truly impossible to estimate (e.g. unknown brand of protein powder where macros vary wildly). Do NOT ask about obvious things like "a bowl of yoghurt" â€” just estimate 1 cup/200g.\n\nReturn ONLY JSON:\n{"items":[{"name":"...","quantity":"...","calories":N,"protein":N,"carbs":N,"fat":N,"fiber":N,"sugar":N,"sodium":N,"saturatedFat":N,"cholesterol":N,"potassium":N,"vitaminA":N,"vitaminC":N,"vitaminD":N,"iron":N,"calcium":N${gutPrompt},"clarify":null}],"totals":{same fields without clarify}}`}]}],generationConfig:{temperature:0.3,maxOutputTokens:2048}})});const d=await res.json();if(d.error){if(is429(d.error)){showRateLimit()}else{alert('Error: '+d.error.message)}setVoiceProcessing(false);setVoiceRecording(false);setVoiceTranscript('');return}const txt=(d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts&&d.candidates[0].content.parts[0].text)||'';const s=txt.indexOf('{'),en=txt.lastIndexOf('}');if(s===-1){alert('Could not parse response');setVoiceProcessing(false);setVoiceRecording(false);setVoiceTranscript('');return}const j=JSON.parse(txt.substring(s,en+1));if(!j.totals&&j.items){j.totals={};Object.keys(EMPTY).forEach(k=>j.totals[k]=j.items.reduce((a,i)=>a+(i[k]||0),0))}setPending({...j.totals,items:j.items||[],category:getM(),time:getT(),date:getD()});setVoiceRecording(false);setVoiceProcessing(false);setVoiceTranscript('');setModal('confirm');logApiUsage();const usage=JSON.parse(st.get('nt_api_usage')||'{}');usage[getD()]=(usage[getD()]||0)+1;st.set('nt_api_usage',JSON.stringify(usage))}catch(err){setVoiceRecording(false);setVoiceProcessing(false);setVoiceTranscript('');if(is429(err)){showRateLimit()}else{alert('Error: '+err.message)}}};

const startVoiceRecording=()=>{const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SpeechRecognition){setVoiceFallback(true);setVoiceRecording(true);return}const recognition=new SpeechRecognition();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-NZ';let finalTranscript='';recognition.onresult=(e)=>{let interim='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal){finalTranscript+=e.results[i][0].transcript}else{interim+=e.results[i][0].transcript}}const t=finalTranscript||interim;setVoiceTranscript(t);voiceTranscriptRef.current=t};recognition.onerror=(e)=>{if(e.error==='not-allowed'){alert('Microphone access denied');setVoiceRecording(false);setVoiceTranscript('')}};recognition.onend=()=>{};window._speechRecognition=recognition;recognition.start();setVoiceRecording(true);setVoiceTranscript('');voiceTranscriptRef.current='';setVoiceFallback(false)};

const stopVoiceRecording=()=>{if(window._speechRecognition){try{window._speechRecognition.stop()}catch(e){}}setVoiceRecording(false)};

const handleVoiceDone=()=>{if(window._speechRecognition){try{window._speechRecognition.stop()}catch(e){}}window._speechRecognition=null;var text=voiceFallback?voiceFallbackText:voiceTranscriptRef.current;if(text&&text.trim()){processVoiceMeal(text.trim())}else{setVoiceRecording(false)}};

const loadApiUsage=(dateKey)=>{if(!db)return;db.ref(`apiUsage/${dateKey}`).once('value',snap=>{const data=snap.val()||{};setApiUsageData(data);Object.keys(data).forEach(username=>{db.ref('users').orderByChild('profile/name').equalTo(username).once('value',usnap=>{const udata=usnap.val()||{};Object.values(udata).forEach(u=>{if(u.profile&&u.profile.partnerCode){setApiUsageFriendCodes(prev=>({...prev,[username]:u.profile.partnerCode}))}})})})})};

const add=async(e,photo=null)=>{
  const u={...users};const d={...u[cur]};
  const mealDate=e.date||getD();delete e.date;
  const meal={...e,id:Date.now()};
  // Store compressed photo if available and storage permits
  if(photo&&getStorageUsage()<STORAGE_LIMIT){
    try{meal.photo=await compressForStorage(photo)}catch{}
  }
  if(mealDate!==getD()){
    // Photo from a past date â€” add to history
    d.hist=[...(d.hist||[])];
    const hi=d.hist.findIndex(h=>h.date===mealDate);
    if(hi>=0){d.hist[hi]={...d.hist[hi],meals:[...d.hist[hi].meals,meal]}}
    else{d.hist.push({date:mealDate,meals:[meal],water:0})}
  }else{
    d.log=[...log,meal];
  }
  d.totalMeals=(d.totalMeals||0)+1;
  d.xp=(d.xp||0)+XP_ACTIONS.logMeal;
  if(d.totalMeals===1)d.xp+=XP_ACTIONS.firstMeal;
  // Track meal times for smart reminders
  if(!d.mealTimes)d.mealTimes={Breakfast:[],Lunch:[],Dinner:[],Snack:[]};
  const cat=e.category||'Snack';
  const timeStr=e.time||getT();
  d.mealTimes[cat]=[...(d.mealTimes[cat]||[]).slice(-6),timeStr];
  // Check if hitting goals (only for today's meals)
  if(mealDate===getD()){
    const newTot=d.log.reduce((a,m)=>{Object.keys(EMPTY).forEach(k=>a[k]+=(m[k]||0));return a},{...EMPTY});
    if(newTot.calories>=tgt.calories*0.9&&newTot.calories<=tgt.calories*1.1){if(d.gamificationOn===true){d.xp+=XP_ACTIONS.hitCalories;showConfetti()}}
    if(newTot.protein>=tgt.protein){d.proteinGoals=(d.proteinGoals||0)+1;if(d.gamificationOn===true){d.xp+=XP_ACTIONS.hitProtein;showConfetti()}}
  }
  u[cur]=d;save(u);setModal(null);setPending(null);setManual({...EMPTY});setFoodPhoto(null);
  if(d.gamificationOn===true){setXpAnim({amt:XP_ACTIONS.logMeal,key:Date.now()});setTimeout(()=>setXpAnim(null),2000)}
  setTimeout(()=>checkBadges(),500);
  // Sync to Firebase for partner features
  if(firebaseConnected){
    syncToFirebase(d);
    postActivity('meal_logged',`logged ${cat}: ${r2(e.calories||0)} cal, ${r2(e.protein||0)}g protein`,meal.photo||null);
    if(newTot.calories>=tgt.calories*0.9&&newTot.calories<=tgt.calories*1.1)postActivity('target_hit','hit their daily calorie target!');
    if(newTot.protein>=tgt.protein)postActivity('target_hit','hit their protein target!');
  }
};
const del=id=>{const u={...users};u[cur]={...ud,log:log.filter(m=>m.id!==id)};save(u);setSelMeal(null);if(firebaseConnected)syncToFirebase(u[cur])};
const addW=ml=>{if(ud.hydrationOn!==true)return;const u={...users},d={...u[cur]};d.water=(d.water||0)+ml;d.xp=(d.xp||0)+XP_ACTIONS.drinkWater;if(d.water>=waterGoal)d.waterGoals=(d.waterGoals||0)+1;u[cur]=d;save(u);if(firebaseConnected)syncToFirebase(d)};
const setGoal=g=>{const np={...profile,goal:g};save({...users,[cur]:{...ud,profile:np,targets:calcT(np)}})};
const toggleLight=()=>{const newVal=!lightMode;setLightMode(newVal);st.set('nt_light',newVal?'true':'false');if(newVal)document.documentElement.classList.add('light');else document.documentElement.classList.remove('light')};
const sw=()=>{st.set('nt_cur','');setCur(null);setView('select')};

// Barcode scanning
const stopBarcodeScanner=()=>{
  if(barcodeStreamRef.current){barcodeStreamRef.current.getTracks().forEach(t=>t.stop());barcodeStreamRef.current=null}
  setBarcodeScanning(false);
};

const lookupBarcode=async(code)=>{
  stopBarcodeScanner();
  setLoading(true);setBarcodeError('');
  try{
    // Try Open Food Facts first
    const offRes=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const off=await offRes.json();
    if(off.status===1&&off.product){
      const p=off.product;
      const n=p.nutriments||{};
      const serving=p.serving_quantity||100;
      const name=p.product_name||p.brands||'Unknown Product';
      const brand=p.brands||'';
      const qty=p.serving_size||p.quantity||'1 serving';
      const item={
        name:brand?`${name} (${brand})`:name,
        quantity:qty,
        calories:Math.round(n['energy-kcal_serving']||n['energy-kcal_100g']||0),
        protein:r2(n.proteins_serving||n.proteins_100g||0),
        carbs:r2(n.carbohydrates_serving||n.carbohydrates_100g||0),
        fat:r2(n.fat_serving||n.fat_100g||0),
        fiber:r2(n.fiber_serving||n.fiber_100g||0),
        sugar:r2(n.sugars_serving||n.sugars_100g||0),
        sodium:Math.round((n.sodium_serving||n.sodium_100g||0)*1000),
        saturatedFat:r2(n['saturated-fat_serving']||n['saturated-fat_100g']||0),
        cholesterol:r2((n.cholesterol_serving||n.cholesterol_100g||0)*1000),
        potassium:Math.round(n.potassium_serving||n.potassium_100g||0),
        vitaminA:r2(n['vitamin-a_serving']||n['vitamin-a_100g']||0),
        vitaminC:r2(n['vitamin-c_serving']||n['vitamin-c_100g']||0),
        vitaminD:r2(n['vitamin-d_serving']||n['vitamin-d_100g']||0),
        iron:r2(n.iron_serving||n.iron_100g||0),
        calcium:r2(n.calcium_serving||n.calcium_100g||0)
      };
      const totals={...item};delete totals.name;delete totals.quantity;
      setPending({...totals,items:[item],category:getM(),time:getT(),date:getD()});
      setModal('confirm');setLoading(false);return;
    }
    // Fallback: USDA FoodData Central (no key needed for basic search)
    const usdaRes=await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${code}&pageSize=1&api_key=DEMO_KEY`);
    const usda=await usdaRes.json();
    if(usda.foods&&usda.foods.length>0){
      const f=usda.foods[0];
      const getNut=(id)=>{const n=f.foodNutrients?.find(x=>x.nutrientId===id);return n?n.value:0};
      const item={
        name:f.description||'Unknown',
        quantity:f.servingSize?`${f.servingSize}${f.servingSizeUnit||'g'}`:'100g',
        calories:Math.round(getNut(1008)),
        protein:r2(getNut(1003)),
        carbs:r2(getNut(1005)),
        fat:r2(getNut(1004)),
        fiber:r2(getNut(1079)),
        sugar:r2(getNut(2000)),
        sodium:Math.round(getNut(1093)),
        saturatedFat:r2(getNut(1258)),
        cholesterol:r2(getNut(1253)),
        potassium:Math.round(getNut(1092)),
        vitaminA:r2(getNut(1106)),
        vitaminC:r2(getNut(1162)),
        vitaminD:r2(getNut(1114)),
        iron:r2(getNut(1089)),
        calcium:r2(getNut(1087))
      };
      const totals={...item};delete totals.name;delete totals.quantity;
      setPending({...totals,items:[item],category:getM(),time:getT(),date:getD()});
      setModal('confirm');setLoading(false);return;
    }
    setBarcodeError('Product not found. Try manual entry.');setModal('barcode');
  }catch(err){setBarcodeError('Lookup failed: '+err.message);setModal('barcode')}
  setLoading(false);
};

const startBarcodeScanner=async()=>{
  setBarcodeError('');setModal('barcode');setBarcodeScanning(true);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    barcodeStreamRef.current=stream;
    // Wait for video element to mount
    setTimeout(()=>{
      const video=barcodeVideoRef.current;
      if(!video){stopBarcodeScanner();return}
      video.srcObject=stream;video.play();
      // Use BarcodeDetector API if available
      if('BarcodeDetector' in window){
        const detector=new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39']});
        const scan=async()=>{
          if(!barcodeStreamRef.current)return;
          try{
            const barcodes=await detector.detect(video);
            if(barcodes.length>0){lookupBarcode(barcodes[0].rawValue);return}
          }catch{}
          if(barcodeStreamRef.current)requestAnimationFrame(scan);
        };
        video.onplaying=()=>requestAnimationFrame(scan);
      }else{
        // Fallback: manual entry of barcode number
        setBarcodeError('Camera barcode detection not supported on this browser. Enter the barcode number manually below.');
      }
    },300);
  }catch(err){
    setBarcodeScanning(false);
    setBarcodeError('Camera access denied. Enter the barcode number manually below.');
  }
};

const week=(()=>{const days=['S','M','T','W','T','F','S'],sp=selDate.split('/'),base=new Date(sp[2],sp[1]-1,sp[0]);return[-3,-2,-1,0,1,2,3].map(i=>{const d=new Date(base);d.setDate(d.getDate()+i);return{day:days[d.getDay()],date:d.getDate(),full:getD(d),isSel:i===0,isToday:getD(d)===getD()}})})();

// Daily Quests - full pool
const ALL_QUESTS={
  log3:{id:'log3',icon:'ðŸ½ï¸',title:'Log 3 meals',progress:Math.min(log.length,3),goal:3,xp:30,color:'#10b981'},
  protein:{id:'protein',icon:'ðŸ’ª',title:`Hit ${tgt.protein}g protein`,progress:Math.min(tot.protein,tgt.protein),goal:tgt.protein,xp:25,color:'#f43f5e'},
  water:{id:'water',icon:'ðŸ’§',title:'Drink 2L water',progress:Math.min(water,2000),goal:2000,xp:20,color:'#3b82f6'},
  calories:{id:'calories',icon:'ðŸ”¥',title:`Stay under ${tgt.calories} cal`,progress:Math.min(tot.calories,tgt.calories),goal:tgt.calories,xp:35,color:'#f59e0b'},
  allmeals:{id:'allmeals',icon:'ðŸ“‹',title:'Log breakfast, lunch & dinner',progress:['Breakfast','Lunch','Dinner'].filter(c=>log.some(m=>m.category===c)).length,goal:3,xp:40,color:'#8b5cf6'},
  fiber:{id:'fiber',icon:'ðŸ¥¦',title:`Hit ${tgt.fiber}g fiber`,progress:Math.min(tot.fiber,tgt.fiber),goal:tgt.fiber,xp:20,color:'#22c55e'},
  sodium:{id:'sodium',icon:'ðŸ§‚',title:`Keep sodium under ${tgt.sodium}mg`,progress:Math.min(tot.sodium,tgt.sodium),goal:tgt.sodium,xp:20,color:'#ef4444'},
  photo:{id:'photo',icon:'ðŸ“¸',title:'Log a meal with photo',progress:Math.min(log.filter(m=>m.photo).length,1),goal:1,xp:15,color:'#06b6d4'},
};
const selectedQuestIds=ud.selectedQuests||['log3','protein','water'];
const quests=selectedQuestIds.map(id=>ALL_QUESTS[id]).filter(Boolean);

const calPct=(tot.calories/tgt.calories)*100,proPct=(tot.protein/tgt.protein)*100,carbPct=(tot.carbs/tgt.carbs)*100,fatPct=(tot.fat/tgt.fat)*100;
const primaryKey=ud.primary||'calories';
const primaryInfo=MACRO_INFO[primaryKey]||MACRO_INFO.calories;
const primaryVal=tot[primaryKey]||0;
const primaryTarget=tgt[primaryKey]||MACRO_TARGETS[primaryKey]||1;
const primaryPct=(primaryVal/primaryTarget)*100;
const primaryUnit=primaryInfo.unit;
const userList=Object.keys(users);

// Confetti burst
const[confetti,setConfetti]=useState(null);
const showConfetti=()=>{
  const particles=Array.from({length:20},(_,i)=>({id:i,x:Math.random()*100,color:['#10b981','#8b5cf6','#f59e0b','#ef4444','#3b82f6','#ec4899'][Math.floor(Math.random()*6)],delay:Math.random()*0.3,size:Math.random()*8+4,drift:(Math.random()-0.5)*60}));
  setConfetti(particles);
  setTimeout(()=>setConfetti(null),2000);
};

// Haptic feedback helper
const haptic=(style='light')=>{try{navigator.vibrate&&navigator.vibrate(style==='heavy'?20:10)}catch{}};
// Click sound helper
const playClick=()=>{try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=1800;o.type='sine';g.gain.value=0.08;o.start();g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.06);o.stop(ctx.currentTime+0.06)}catch{}};
const tapFeedback=()=>{haptic();playClick()};

if(view==='loading')return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--body-bg)',flexDirection:'column'}}>
  <div style={{animation:'splashIn 0.8s ease-out',textAlign:'center'}}>
    <div style={{fontSize:80,marginBottom:16,animation:'splashBounce 0.6s ease-out 0.3s both'}}>ðŸ…</div>
    <h1 style={{fontSize:36,fontWeight:800,opacity:0,animation:'splashFade 0.5s ease-out 0.5s forwards'}} className="gradient-text">Macrely</h1>
    <p style={{color:'var(--muted)',fontSize:14,opacity:0,animation:'splashFade 0.5s ease-out 0.8s forwards'}}>Track, compete, dominate</p>
  </div>
  <style>{`
    @keyframes splashIn{0%{opacity:0;transform:scale(0.8)}100%{opacity:1;transform:scale(1)}}
    @keyframes splashBounce{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    @keyframes splashFade{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
  `}</style>
</div>;

if(view==='select')return<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24,textAlign:'center'}}>
  <div style={{fontSize:64,marginBottom:16}} className="animate-float">ðŸ…</div>
  <h1 style={{fontSize:32,fontWeight:800,marginBottom:8}} className="gradient-text">Macrely</h1>
  <p style={{color:'var(--muted)',marginBottom:32}}>Track, compete, dominate</p>
  <div style={{width:'100%',maxWidth:320}}>
    {userList.map(n=><div key={n} style={{display:'flex',gap:8,marginBottom:12}}>
      <button onClick={()=>pick(n)} className="glass" style={{flex:1,padding:16,display:'flex',alignItems:'center',gap:12,border:'none',cursor:'pointer'}}>
        <div style={{width:48,height:48,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}}>
          {users[n]?.profilePic?<img src={users[n].profilePic} style={{width:'100%',height:'100%',borderRadius:'50%',objectFit:'cover'}}/>:'ðŸ‘¤'}
        </div>
        <div style={{textAlign:'left'}}>
          <p style={{fontWeight:600,fontSize:16}}>{n}</p>
          <p style={{fontSize:12,color:'var(--muted)'}}>Level {getLevel(users[n]?.xp||0).level}</p>
        </div>
      </button>
      <button onClick={()=>{if(confirm('Delete '+n+'?'))delUser(n)}} className="glass" style={{padding:'0 16px',color:'var(--danger)',cursor:'pointer',border:'none'}}>Ã—</button>
    </div>)}
    <div style={{display:'flex',gap:8,marginTop:24}}>
      <input value={newUser} onChange={e=>setNewUser(e.target.value)} placeholder="Enter your name" style={{flex:1}}/>
      <button onClick={addUser} className="btn btn-primary">Start</button>
    </div>
  </div>
</div>;

if(view==='setup')return<div style={{minHeight:'100vh',padding:24}}>
  <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:24}}>
    <div style={{width:56,height:56,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28}}>ðŸ‘¤</div>
    <div><h1 style={{fontSize:24,fontWeight:700}}>Hi {cur}!</h1><p style={{color:'var(--muted)'}}>Let's set up your profile</p></div>
  </div>
  <div className="glass" style={{padding:24}}>
    <div style={{marginBottom:20}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Gender</label>
      <div style={{display:'flex',gap:8}}>{['male','female'].map(g=><button key={g} onClick={()=>setSetup({...setup,gender:g})} className="btn" style={{flex:1,background:setup.gender===g?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',textTransform:'capitalize'}}>{g==='male'?'â™‚ï¸':'â™€ï¸'} {g}</button>)}</div>
    </div>
    <div style={{marginBottom:20}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Weight</label>
      <div style={{display:'flex',gap:8}}>
        <input type="number" placeholder={setup.weightUnit==='kg'?'70':'154'} value={setup.weight} onChange={e=>setSetup({...setup,weight:e.target.value})} style={{flex:1}}/>
        <button onClick={()=>setSetup({...setup,weightUnit:setup.weightUnit==='kg'?'lbs':'kg',weight:''})} className="btn btn-secondary">{setup.weightUnit}</button>
      </div>
    </div>
    <div style={{marginBottom:20}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Height</label>
      {setup.heightUnit==='cm'?<div style={{display:'flex',gap:8}}>
        <input type="number" placeholder="170" value={setup.height} onChange={e=>setSetup({...setup,height:e.target.value})} style={{flex:1}}/>
        <button onClick={()=>setSetup({...setup,heightUnit:'ft'})} className="btn btn-secondary">cm</button>
      </div>:<div style={{display:'flex',gap:8}}>
        <input type="number" placeholder="ft" value={setup.heightFt} onChange={e=>setSetup({...setup,heightFt:e.target.value})} style={{flex:1}}/>
        <input type="number" placeholder="in" value={setup.heightIn} onChange={e=>setSetup({...setup,heightIn:e.target.value})} style={{flex:1}}/>
        <button onClick={()=>setSetup({...setup,heightUnit:'cm'})} className="btn btn-secondary">ft</button>
      </div>}
    </div>
    <div style={{marginBottom:20}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Age</label>
      <input type="number" placeholder="25" value={setup.age} onChange={e=>setSetup({...setup,age:e.target.value})}/>
    </div>
    <div style={{marginBottom:20}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Activity Level</label>
      <select value={setup.activity} onChange={e=>setSetup({...setup,activity:e.target.value})}>
        <option value="sedentary">Sedentary (desk job)</option>
        <option value="light">Light (1-2 days/week)</option>
        <option value="moderate">Moderate (3-5 days/week)</option>
        <option value="active">Active (6-7 days/week)</option>
        <option value="very_active">Very Active (2x/day)</option>
      </select>
    </div>
    <div style={{marginBottom:24}}>
      <label style={{fontSize:14,color:'var(--muted)',marginBottom:8,display:'block'}}>Goal</label>
      <select value={setup.goal} onChange={e=>setSetup({...setup,goal:e.target.value})}>
        <option value="lose">ðŸ”¥ Lose Weight</option>
        <option value="maintain">âš–ï¸ Maintain</option>
        <option value="gain">ðŸ’ª Build Muscle</option>
      </select>
    </div>
    <div style={{marginBottom:20}}>
      <label style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'var(--subtle-bg)',borderRadius:12,cursor:'pointer',marginBottom:8}}>
        <input type="checkbox" checked={setup.hydrationOn} onChange={e=>setSetup({...setup,hydrationOn:e.target.checked})} style={{width:20,height:20,accentColor:'var(--primary)'}}/>
        <div><p style={{fontWeight:600}}>Track water intake ðŸ’§</p><p style={{fontSize:12,color:'var(--muted)'}}>Log daily hydration goals</p></div>
      </label>
      <label style={{display:'flex',alignItems:'center',gap:10,padding:12,background:'var(--subtle-bg)',borderRadius:12,cursor:'pointer'}}>
        <input type="checkbox" checked={setup.gamificationOn} onChange={e=>setSetup({...setup,gamificationOn:e.target.checked})} style={{width:20,height:20,accentColor:'var(--primary)'}}/>
        <div><p style={{fontWeight:600}}>Enable gamification ðŸŽ®</p><p style={{fontSize:12,color:'var(--muted)'}}>Quests, XP, levels, and badges</p></div>
      </label>
    </div>
    <button onClick={done} disabled={!setup.weight||(!setup.height&&!setup.heightFt)||!setup.age} className="btn btn-primary" style={{width:'100%',padding:16,fontSize:16,opacity:(!setup.weight||(!setup.height&&!setup.heightFt)||!setup.age)?0.5:1}}>
      Start Journey ðŸš€
    </button>
  </div>
</div>;

return<div style={{paddingBottom:80,minHeight:'100vh'}}>
  {/* XP Animation */}
  {gamificationOn&&xpAnim&&<div key={xpAnim.key} style={{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',zIndex:200,fontSize:32,fontWeight:800,color:'var(--primary)',animation:'floatUp 2s forwards',pointerEvents:'none'}}>+{xpAnim.amt} XP<style>{`@keyframes floatUp{0%{opacity:1;transform:translate(-50%,-50%)}100%{opacity:0;transform:translate(-50%,-150%)}}`}</style></div>}

  {/* Confetti */}
  {gamificationOn&&confetti&&<div style={{position:'fixed',inset:0,pointerEvents:'none',zIndex:250,overflow:'hidden'}}>
    {confetti.map(p=><div key={p.id} style={{position:'absolute',left:`${p.x}%`,top:'50%',width:p.size,height:p.size,borderRadius:p.size>8?'50%':'2px',background:p.color,animation:`confettiPop 1.5s ease-out ${p.delay}s both`,transform:`translateX(${p.drift}px)`}}/>)}
  </div>}

  {/* Header */}
  <div style={{padding:'16px 20px',background:'var(--header-bg)'}}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
      <div style={{display:'flex',alignItems:'center',gap:12}}>
        <div onClick={()=>document.getElementById('avatarPic').click()} style={{width:44,height:44,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,cursor:'pointer',position:'relative'}} className="animate-glow">
          {ud.profilePic?<img src={ud.profilePic} style={{width:'100%',height:'100%',borderRadius:'50%',objectFit:'cover'}}/>:'ðŸ‘¤'}
          <div style={{position:'absolute',bottom:-2,right:-2,width:16,height:16,borderRadius:'50%',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:8,border:'2px solid var(--bg)'}}>ðŸ“·</div>
        </div>
        <input id="avatarPic" type="file" accept="image/*" onChange={async e=>{const f=e.target.files?.[0];if(!f)return;const img=await compress(f,150);const u={...users};u[cur]={...ud,profilePic:img};save(u);if(firebaseConnected&&ud.oddd)db.ref(`users/${ud.oddd}/profile/profilePic`).set(img)}} style={{display:'none'}}/>
        <div>
          <p style={{fontWeight:700,fontSize:16}}>{cur}</p>
          {gamificationOn&&<p style={{fontSize:12,color:'var(--muted)'}}>Level {lvl.level}</p>}
        </div>
      </div>
      <div style={{display:'flex',alignItems:'center',gap:8,padding:'8px 16px',borderRadius:20,background:'linear-gradient(135deg,rgba(245,158,11,0.2),rgba(239,68,68,0.2))',border:'1px solid rgba(245,158,11,0.3)'}}>
        <span style={{fontSize:20,display:'inline-block',animation:streak>=3?'fireFlicker 0.5s ease-in-out infinite':'none'}}>ðŸ”¥</span>
        <span style={{fontWeight:700,color:'var(--accent)'}}>{streak}</span>
      </div>
    </div>
    {/* XP Bar */}
    {gamificationOn&&<div style={{marginBottom:8}}>
      <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
        <span style={{color:'var(--muted)'}}>Level {lvl.level}</span>
        <span style={{color:'var(--secondary)'}}>{lvl.current}/{lvl.next} XP</span>
      </div>
      <div className="xp-bar"><div className="xp-fill" style={{width:`${(lvl.current/lvl.next)*100}%`}}/></div>
    </div>}
    {/* Week Selector */}
    <div style={{display:'flex',justifyContent:'space-between',marginTop:16}}>
      {week.map((d,i)=><button key={i} onClick={()=>setSelDate(d.full)} style={{background:'none',border:'none',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',gap:4}}>
        <span style={{fontSize:12,color:'var(--muted)'}}>{d.day}</span>
        <div style={{width:36,height:36,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:d.isSel?700:400,background:d.isSel?'linear-gradient(135deg,var(--primary),var(--secondary))':'transparent',border:d.isToday&&!d.isSel?'2px solid var(--primary)':'none',color:d.isSel?'#fff':'var(--text)'}}>{d.date}</div>
      </button>)}
    </div>
  </div>

  <div style={{padding:'0 20px'}}>
    {/* Meal Reminder Banner */}
    {mealReminder&&showReminder&&tab==='home'&&<div style={{background:'linear-gradient(135deg,rgba(245,158,11,0.2),rgba(239,68,68,0.2))',border:'1px solid rgba(245,158,11,0.3)',borderRadius:16,padding:16,marginBottom:16,display:'flex',alignItems:'center',gap:12}}>
      <span style={{fontSize:32}}>{mealReminder.category==='Breakfast'?'ðŸŒ…':mealReminder.category==='Lunch'?'â˜€ï¸':mealReminder.category==='Dinner'?'ðŸŒ™':'ðŸ¿'}</span>
      <div style={{flex:1}}>
        <p style={{fontWeight:600,marginBottom:4}}>Time for {mealReminder.category}!</p>
        <p style={{fontSize:13,color:'var(--muted)'}}>Around your usual ~{mealReminder.time} time</p>
      </div>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setModal('add')} style={{background:'linear-gradient(135deg,var(--primary),var(--secondary))',border:'none',borderRadius:12,padding:'8px 12px',color:'#fff',fontSize:18,cursor:'pointer'}}>ðŸ“¸</button>
        <button onClick={()=>setShowReminder(false)} style={{background:'var(--subtle)',border:'none',borderRadius:12,padding:'8px 12px',color:'var(--muted)',cursor:'pointer'}}>âœ•</button>
      </div>
    </div>}

    {tab==='home'&&<div className="tab-content">
      {/* Patch Notes Banner */}
      {hasNewPatch&&<div onClick={()=>setShowPatchNotes(true)} style={{background:'linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.15))',border:'1px solid rgba(99,102,241,0.25)',borderRadius:14,padding:'10px 14px',marginBottom:12,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontSize:16}}>âœ¨</span>
          <span style={{fontSize:13,fontWeight:600}}>New updates available</span>
          <span style={{fontSize:11,color:'var(--muted)'}}>v{APP_VERSION}</span>
        </div>
        <span style={{fontSize:12,color:'var(--muted)'}}>Tap to see â†’</span>
      </div>}
      {/* Customize Button */}
      <div style={{display:'flex',justifyContent:'flex-end',marginBottom:8}}>
        <button onClick={()=>setModal('customizeHome')} style={{background:'var(--subtle)',border:'1px solid var(--card-border)',borderRadius:10,padding:'6px 12px',cursor:'pointer',color:'var(--muted)',fontSize:13,display:'flex',alignItems:'center',gap:6}}>
          <span style={{fontSize:16}}>â˜°</span> Customize
        </button>
      </div>

      {/* Main Progress - Always visible */}
      <div className="glass" style={{padding:24,marginBottom:16,cursor:'pointer'}} onClick={()=>setModal('pickPrimary')}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:24}}>
          <ProgressRing pct={primaryPct} size={140} stroke={12} color={primaryPct>100?'#ef4444':primaryInfo.color}>
            <span style={{fontSize:28,fontWeight:800}}>{r2(Math.max(0,primaryTarget-primaryVal))}</span>
            <span style={{fontSize:11,color:'var(--muted)'}}>{primaryUnit} left</span>
          </ProgressRing>
          <div style={{display:'flex',flexDirection:'column',gap:12}}>
            <div>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
                <span style={{fontSize:14}}>{primaryInfo.emoji}</span>
                <span style={{fontSize:13,color:'var(--muted)'}}>{primaryInfo.name}</span>
              </div>
              <p style={{fontSize:22,fontWeight:800}}>{r2(primaryVal)}<span style={{fontSize:13,fontWeight:400,color:'var(--muted)'}}> {primaryUnit}</span></p>
            </div>
            <div style={{height:1,background:'var(--card-border)'}}/>
            <div>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
                <span style={{fontSize:14}}>ðŸŽ¯</span>
                <span style={{fontSize:13,color:'var(--muted)'}}>Goal</span>
              </div>
              <p style={{fontSize:22,fontWeight:800}}>{primaryTarget}<span style={{fontSize:13,fontWeight:400,color:'var(--muted)'}}> {primaryUnit}</span></p>
            </div>
          </div>
        </div>
        <div style={{marginTop:20}}>
          <div style={{height:8,background:'var(--subtle)',borderRadius:4,overflow:'hidden'}}>
            <div style={{height:'100%',width:`${Math.min(100,primaryPct)}%`,background:primaryPct>100?'linear-gradient(90deg,var(--danger),#f97316)':`linear-gradient(90deg,${primaryInfo.color},var(--secondary))`,borderRadius:4,transition:'width 0.5s ease'}}/>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginTop:6}}>
            <span style={{fontSize:11,color:'var(--muted)'}}>{Math.round(primaryPct)}% of daily goal</span>
            <span style={{fontSize:11,color:primaryPct>100?'var(--danger)':primaryInfo.color}}>{primaryPct>100?'Over by '+r2(primaryVal-primaryTarget)+' '+primaryUnit:r2(primaryTarget-primaryVal)+' '+primaryUnit+' left'}</span>
          </div>
        </div>
        <p style={{textAlign:'center',fontSize:11,color:'var(--muted)',marginTop:8}}>Tap to change tracked macro</p>
      </div>

      {/* Macros Row - Collapsible */}
      <div className="section-header" onClick={()=>toggleSection('macros')}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontWeight:700,fontSize:15}}>Macros</span>
          <span style={{fontSize:16}}>ðŸ’ª</span>
        </div>
        <span className={`chevron ${sections.macros?'':'collapsed'}`}>â–¼</span>
      </div>
      <div className={`section-collapse ${sections.macros?'expanded':'collapsed'}`}>
        <div className="glass" style={{padding:16,marginBottom:16}}>
          <div style={{display:'flex',justifyContent:'space-around',alignItems:'center'}} onContextMenu={e=>{e.preventDefault();setModal('selectMacros')}}>
            {selectedMacros.map(key=>{const info=MACRO_INFO[key];const c=tot[key]||0;const t=tgt[key]||MACRO_TARGETS[key]||100;const l=info.name;const col=info.color;const ic=info.emoji;return[l,c,t,col,ic]}).map(([l,c,t,col,ic])=>{
              const pct=Math.min(100,(c/t)*100);
              return<div key={l} style={{textAlign:'center',flex:1}}>
                <ProgressRing pct={pct} size={52} stroke={5} color={col}>
                  <span style={{fontSize:12}}>{ic}</span>
                </ProgressRing>
                <p style={{fontWeight:700,fontSize:15,marginTop:6}}>{r2(c)}g</p>
                <p style={{fontSize:11,color:'var(--muted)'}}>{l}</p>
                <p style={{fontSize:10,color:col}}>{r2(Math.max(0,t-c))}g left</p>
              </div>})}
          </div>
        </div>
      </div>

      {/* Daily Quests - Collapsible */}
      {gamificationOn&&<React.Fragment>
      <div className="section-header" onClick={()=>toggleSection('quests')}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontWeight:700,fontSize:15}}>Daily Quests</span>
          <span style={{fontSize:16}}>âš”ï¸</span>
        </div>
        <span className={`chevron ${sections.quests?'':'collapsed'}`}>â–¼</span>
      </div>
      <div className={`section-collapse ${sections.quests?'expanded':'collapsed'}`}>
        {quests.map((q,qi)=><div key={q.id} className="quest-card" style={{animationDelay:`${qi*0.1}s`}}>
          <div className="quest-icon" style={{background:`${q.color}20`}}>{q.icon}</div>
          <div style={{flex:1}}>
            <p style={{fontWeight:600,marginBottom:4}}>{q.title}</p>
            <div style={{height:6,background:'var(--subtle)',borderRadius:3}}>
              <div style={{height:'100%',width:`${(q.progress/q.goal)*100}%`,background:q.color,borderRadius:3,transition:'width 0.3s'}}/>
            </div>
          </div>
          <div style={{textAlign:'right'}}>
            <p style={{fontSize:12,color:'var(--secondary)'}}>+{q.xp} XP</p>
            <p style={{fontSize:12,color:'var(--muted)'}}>{q.progress>=q.goal?'âœ“':''}</p>
          </div>
        </div>)}
      </div>
      </React.Fragment>}

      {/* Hydration - Collapsible */}
      {hydrationOn&&<React.Fragment>
      <div className="section-header" onClick={()=>toggleSection('water')} style={{marginTop:4}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontWeight:700,fontSize:15}}>Hydration</span>
          <span style={{fontSize:16}}>ðŸ’§</span>
          <span style={{fontSize:13,color:'var(--muted)'}}>{water}/{waterGoal}ml</span>
        </div>
        <span className={`chevron ${sections.water?'':'collapsed'}`}>â–¼</span>
      </div>
      <div className={`section-collapse ${sections.water?'expanded':'collapsed'}`}>
        <div className="glass" style={{padding:20,marginBottom:16}}>
          <div style={{height:8,background:'var(--subtle)',borderRadius:4,marginBottom:12}}>
            <div style={{height:'100%',width:`${Math.min(100,(water/waterGoal)*100)}%`,background:'linear-gradient(90deg,#3b82f6,#06b6d4)',borderRadius:4}}/>
          </div>
          <div style={{display:'flex',gap:8}}>
            {[150,250,500].map(ml=><button key={ml} onClick={()=>addW(ml)} className="btn btn-secondary" style={{flex:1,padding:10}}>+{ml}ml</button>)}
          </div>
        </div>
      </div>
      </React.Fragment>}

      {/* Meals - Collapsible */}
      <div className="section-header" onClick={()=>toggleSection('meals')}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontWeight:700,fontSize:15}}>Today's Meals</span>
          <span style={{fontSize:16}}>ðŸ½ï¸</span>
          <span style={{fontSize:13,color:'var(--muted)'}}>({logs.length})</span>
        </div>
        <span className={`chevron ${sections.meals?'':'collapsed'}`}>â–¼</span>
      </div>
      <div className={`section-collapse ${sections.meals?'expanded':'collapsed'}`}>
        {logs.length===0?<div className="glass" style={{padding:32,textAlign:'center',marginBottom:16}}><p style={{color:'var(--muted)'}}>No meals logged yet</p><p style={{fontSize:12,color:'var(--muted)',marginTop:4}}>Tap + to add your first meal</p></div>
        :logs.map((m,idx)=><button key={m.id} onClick={()=>{tapFeedback();setSelMeal(m)}} className="meal-card" style={{width:'100%',textAlign:'left',cursor:'pointer',border:'none',animationDelay:`${idx*0.08}s`}}>
          <div style={{display:'flex',gap:12}}>
            {m.photo&&<img src={m.photo} style={{width:56,height:56,borderRadius:12,objectFit:'cover',flexShrink:0}}/>}
            <div style={{flex:1,minWidth:0}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:20}}>{m.category==='Breakfast'?'ðŸŒ…':m.category==='Lunch'?'â˜€ï¸':m.category==='Dinner'?'ðŸŒ™':'ðŸ¿'}</span>
                  <span style={{fontWeight:600}}>{m.category}</span>
                </div>
                <span style={{color:'var(--primary)',fontWeight:700}}>{r2(m.calories)} cal</span>
              </div>
              <p style={{fontSize:13,color:'var(--muted)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{(m.items||[]).map(i=>i.name).join(', ')||'Manual entry'}</p>
            </div>
          </div>
        </button>)}
      </div>

      {/* Analytics - Collapsible (hidden by default) */}
      <div className="section-header" onClick={()=>toggleSection('analytics')} style={{marginTop:4}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontWeight:700,fontSize:15}}>Analytics</span>
          <span style={{fontSize:16}}>ðŸ“Š</span>
        </div>
        <span className={`chevron ${sections.analytics?'':'collapsed'}`}>â–¼</span>
      </div>
      <div className={`section-collapse ${sections.analytics?'expanded':'collapsed'}`}>
        {sections.analytics&&(()=>{
          const last7=hist.slice(-7);
          const avgCal=last7.length?Math.round(last7.reduce((a,d)=>a+d.meals.reduce((s,m)=>s+(m.calories||0),0),0)/last7.length):0;
          const avgPro=last7.length?Math.round(last7.reduce((a,d)=>a+d.meals.reduce((s,m)=>s+(m.protein||0),0),0)/last7.length):0;
          const totalP=tot.protein||1,totalC=tot.carbs||1,totalF=tot.fat||1;
          const macroTotal=totalP+totalC+totalF;
          const pPct=Math.round(totalP/macroTotal*100),cPct=Math.round(totalC/macroTotal*100),fPct=100-pPct-cPct;
          const detailedMacros=[
            ['Fiber',tot.fiber||0,tgt.fiber||25,'#22c55e','g'],
            ['Sugar',tot.sugar||0,tgt.sugar||50,'#f97316','g'],
            ['Sodium',tot.sodium||0,tgt.sodium||2300,'#ef4444','mg'],
            ['Saturated Fat',tot.saturatedFat||0,20,'#e11d48','g'],
            ['Cholesterol',tot.cholesterol||0,300,'#be185d','mg'],
            ['Potassium',tot.potassium||0,3500,'#7c3aed','mg'],
            ['Vitamin A',tot.vitaminA||0,900,'#ea580c','mcg'],
            ['Vitamin C',tot.vitaminC||0,90,'#16a34a','mg'],
            ['Vitamin D',tot.vitaminD||0,20,'#0891b2','mcg'],
            ['Iron',tot.iron||0,18,'#dc2626','mg'],
            ['Calcium',tot.calcium||0,1000,'#2563eb','mg']
          ];
          return<div style={{marginBottom:16}}>
            {/* 7-day calorie trend */}
            <div className="glass" style={{padding:16,marginBottom:12}}>
              <p style={{fontWeight:600,fontSize:13,marginBottom:12}}>7-Day Calorie Trend</p>
              {last7.length>=2?<div style={{display:'flex',alignItems:'flex-end',gap:4,height:80}}>
                {last7.map((d,i)=>{
                  const dayCal=d.meals.reduce((s,m)=>s+(m.calories||0),0);
                  const maxCal=Math.max(...last7.map(dd=>dd.meals.reduce((s,m)=>s+(m.calories||0),0)),1);
                  return<div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}>
                    <span style={{fontSize:9,color:'var(--muted)',marginBottom:2}}>{Math.round(dayCal)}</span>
                    <div style={{width:'100%',background:dayCal>=tgt.calories*0.9&&dayCal<=tgt.calories*1.1?'linear-gradient(180deg,var(--primary),var(--secondary))':'linear-gradient(180deg,var(--accent),#f97316)',borderRadius:4,height:`${Math.max(8,(dayCal/maxCal)*60)}px`}}/>
                    <span style={{fontSize:9,color:'var(--muted)',marginTop:2}}>{d.date?.split('/')[0]||''}</span>
                  </div>})}
              </div>:<p style={{color:'var(--muted)',fontSize:12,textAlign:'center'}}>Need 2+ days of history</p>}
            </div>

            {/* Average daily intake */}
            <div className="glass" style={{padding:16,marginBottom:12}}>
              <p style={{fontWeight:600,fontSize:13,marginBottom:8}}>7-Day Averages</p>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                <div style={{padding:10,background:'var(--subtle-bg)',borderRadius:10,textAlign:'center'}}>
                  <p style={{fontSize:20,fontWeight:700}}>{avgCal}</p>
                  <p style={{fontSize:11,color:'var(--muted)'}}>Avg Calories</p>
                </div>
                <div style={{padding:10,background:'var(--subtle-bg)',borderRadius:10,textAlign:'center'}}>
                  <p style={{fontSize:20,fontWeight:700}}>{avgPro}g</p>
                  <p style={{fontSize:11,color:'var(--muted)'}}>Avg Protein</p>
                </div>
              </div>
            </div>

            {/* Macro split */}
            <div className="glass" style={{padding:16,marginBottom:12}}>
              <p style={{fontWeight:600,fontSize:13,marginBottom:8}}>Today's Macro Split</p>
              <div style={{display:'flex',gap:4,height:24,borderRadius:12,overflow:'hidden',marginBottom:8}}>
                <div style={{width:`${pPct}%`,background:'#f43f5e',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:600,color:'#fff',minWidth:pPct>8?0:0}}>{pPct>8?pPct+'%':''}</div>
                <div style={{width:`${cPct}%`,background:'#f59e0b',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:600,color:'#fff'}}>{cPct>8?cPct+'%':''}</div>
                <div style={{width:`${fPct}%`,background:'#3b82f6',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:600,color:'#fff'}}>{fPct>8?fPct+'%':''}</div>
              </div>
              <div style={{display:'flex',justifyContent:'center',gap:16,fontSize:11}}>
                <span><span style={{color:'#f43f5e'}}>â—</span> Protein {pPct}%</span>
                <span><span style={{color:'#f59e0b'}}>â—</span> Carbs {cPct}%</span>
                <span><span style={{color:'#3b82f6'}}>â—</span> Fat {fPct}%</span>
              </div>
            </div>

            {/* Detailed macros */}
            <div className="glass" style={{padding:16}}>
              <p style={{fontWeight:600,fontSize:13,marginBottom:12}}>Detailed Nutrients</p>
              {detailedMacros.map(([name,val,goal,color,unit])=><div key={name} style={{marginBottom:10}}>
                <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
                  <span>{name}</span>
                  <span style={{color:'var(--muted)'}}>{r2(val)}{unit} / {goal}{unit}</span>
                </div>
                <div style={{height:6,background:'var(--subtle)',borderRadius:3}}>
                  <div style={{height:'100%',width:`${Math.min(100,(val/goal)*100)}%`,background:color,borderRadius:3,transition:'width 0.3s'}}/>
                </div>
              </div>)}
            </div>
          </div>})()}
      </div>
    </div>}

    {tab==='friends'&&<div className="tab-content">
      <h2 style={{fontSize:24,fontWeight:800,marginBottom:8}}>Friends ðŸ‘¥</h2>
      <p style={{color:'var(--muted)',marginBottom:16}}>{friends.length}/10 friends</p>

      {!firebaseConnected?<div className="glass" style={{padding:24,textAlign:'center'}}>
        <span style={{fontSize:48,display:'block',marginBottom:16}}>ðŸ”—</span>
        <h3 style={{fontWeight:700,marginBottom:8}}>Connect to Friend Features</h3>
        <p style={{color:'var(--muted)',marginBottom:16}}>Set up Firebase in Settings to add friends!</p>
        <button onClick={()=>setTab('settings')} className="btn btn-primary" style={{padding:'12px 24px'}}>Go to Settings</button>
      </div>:<div>

      {/* Add Friend */}
      <div className="glass" style={{padding:16,marginBottom:16}}>
        <div style={{display:'flex',gap:8}}>
          <input value={addFriendCode} onChange={e=>setAddFriendCode(e.target.value.toUpperCase())} placeholder="Enter friend code" maxLength={6} style={{flex:1,textAlign:'center',fontSize:16,letterSpacing:3,textTransform:'uppercase'}}/>
          <button onClick={addFriend} disabled={addFriendCode.length!==6||friends.length>=10} className="btn btn-primary" style={{padding:'12px 20px',opacity:(addFriendCode.length!==6||friends.length>=10)?0.5:1}}>Add</button>
        </div>
        {addFriendError&&<p style={{color:'var(--danger)',fontSize:12,marginTop:8}}>{addFriendError}</p>}
        <p style={{fontSize:11,color:'var(--muted)',marginTop:8,textAlign:'center'}}>Your code: <strong style={{letterSpacing:2}}>{partnerCode}</strong></p>
      </div>

      {/* Friends Help Tip */}
      <div onClick={()=>{setTab('settings');const u={...users};u[cur]={...ud,showGuide:true};save(u);setTimeout(()=>{const el=document.getElementById('guide-friends');if(el)el.scrollIntoView({behavior:'smooth',block:'center'})},100)}} style={{background:'var(--subtle-bg)',border:'1px solid var(--card-border)',borderRadius:12,padding:'8px 14px',marginBottom:12,display:'flex',alignItems:'center',gap:8,cursor:'pointer'}}>
        <span style={{fontSize:13,flexShrink:0}}>ðŸ’¡</span>
        <p style={{fontSize:12,color:'var(--muted)',flex:1}}>New here? Learn how Friends works</p>
        <span style={{fontSize:12,color:'var(--muted)'}}>â†’</span>
      </div>

      {/* Sub-tabs */}
      <div style={{display:'flex',gap:8,marginBottom:16,overflowX:'auto',WebkitOverflowScrolling:'touch'}}>
        {[['leaderboard','Board'],['feed','Activity'],['photos','Photos'],['challenges','Challenges'],['goals','Goals'],['mealIdeas','Meals'],['list','Friends']].map(([k,l])=>
          <button key={k} onClick={()=>setFriendTab(k)} className="btn" style={{flex:1,padding:'10px 4px',fontSize:11,background:friendTab===k?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',border:friendTab===k?'none':'1px solid var(--card-border)',color:friendTab===k?'#fff':'var(--text)',whiteSpace:'nowrap'}}>{l}</button>
        )}
      </div>

      {/* Leaderboard */}
      {friendTab==='leaderboard'&&<div>
        <div style={{display:'flex',justifyContent:'center',gap:8,marginBottom:16}}>
          {['daily','weekly'].map(p=><button key={p} onClick={()=>setLeaderboardPeriod(p)} className="btn" style={{padding:'8px 20px',background:leaderboardPeriod===p?'var(--primary)':'var(--card)',border:leaderboardPeriod===p?'none':'1px solid var(--card-border)',textTransform:'capitalize',fontSize:13,color:leaderboardPeriod===p?'#fff':'var(--text)'}}>{p}</button>)}
        </div>
        {(()=>{
          const lb=getLeaderboard();
          if(lb.length<=1)return<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>Add friends to see the leaderboard!</p></div>;
          // Podium for top 3
          const top3=lb.slice(0,3);
          const podiumOrder=top3.length>=3?[top3[1],top3[0],top3[2]]:top3;
          return<div>
            <div style={{display:'flex',justifyContent:'center',alignItems:'flex-end',gap:12,marginBottom:24}}>
              {podiumOrder.map((entry,i)=>{
                const rank=top3.indexOf(entry);
                const heights=[120,150,100];
                const colors=['#C0C0C0','#FFD700','#CD7F32'];
                const medals=['ðŸ¥ˆ','ðŸ¥‡','ðŸ¥‰'];
                const actualI=top3.length>=3?i:[0,1,2][i];
                return<div key={entry.id} style={{textAlign:'center',flex:1}}>
                  <div style={{fontSize:28,marginBottom:4}}>{medals[rank]||''}</div>
                  <div style={{width:48,height:48,borderRadius:'50%',background:entry.isMe?'linear-gradient(135deg,var(--primary),var(--secondary))':'linear-gradient(135deg,var(--secondary),#ec4899)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 8px',fontSize:20,border:rank===0?'3px solid #FFD700':'none'}}>
                    {entry.isMe&&ud.profilePic?<img src={ud.profilePic} style={{width:'100%',height:'100%',borderRadius:'50%',objectFit:'cover'}}/>:entry.name[0]?.toUpperCase()||'?'}
                  </div>
                  <p style={{fontWeight:700,fontSize:13,marginBottom:2}}>{entry.name}{entry.isMe?' (You)':''}</p>
                  <p style={{fontSize:20,fontWeight:800,color:'var(--primary)'}}>{Math.round(entry.calories)}</p>
                  <p style={{fontSize:11,color:'var(--muted)'}}>calories</p>
                  <div style={{height:heights[rank]||80,background:`linear-gradient(180deg,${colors[rank]||'#888'}33,${colors[rank]||'#888'}11)`,borderRadius:'12px 12px 0 0',marginTop:8,display:'flex',alignItems:'center',justifyContent:'center'}}>
                    <span style={{fontSize:24,fontWeight:800,color:colors[rank]||'#888'}}>#{rank+1}</span>
                  </div>
                </div>})}
            </div>
            {/* Full list */}
            {lb.slice(3).map((entry,i)=><div key={entry.id} className="glass" style={{padding:12,marginBottom:8,display:'flex',alignItems:'center',gap:12}}>
              <span style={{fontWeight:700,fontSize:16,width:24,textAlign:'center',color:'var(--muted)'}}>#{i+4}</span>
              <div style={{width:36,height:36,borderRadius:'50%',background:entry.isMe?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--subtle)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}}>{entry.name[0]?.toUpperCase()||'?'}</div>
              <div style={{flex:1}}>
                <p style={{fontWeight:600,fontSize:14}}>{entry.name}{entry.isMe?' (You)':''}</p>
              </div>
              <div style={{textAlign:'right'}}>
                <p style={{fontWeight:700,color:'var(--primary)'}}>{Math.round(entry.calories)}</p>
                <p style={{fontSize:11,color:'var(--muted)'}}>cal</p>
              </div>
            </div>)}
            {/* Stats row */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginTop:16}}>
              {[['ðŸ’ª Protein',lb.sort((a,b)=>b.protein-a.protein)[0]?.name],['ðŸ½ï¸ Meals',lb.sort((a,b)=>b.meals-a.meals)[0]?.name],['ðŸ”¥ Streak',lb.sort((a,b)=>b.streak-a.streak)[0]?.name]].map(([label,winner])=>
                <div key={label} className="glass" style={{padding:12,textAlign:'center'}}>
                  <p style={{fontSize:12,color:'var(--muted)',marginBottom:4}}>{label}</p>
                  <p style={{fontWeight:600,fontSize:13}}>{winner||'-'}</p>
                </div>
              )}
            </div>
          </div>;
        })()}
      </div>}

      {/* Activity Feed */}
      {friendTab==='feed'&&<div>
        {activityFeed.length===0?<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No activity yet</p><p style={{fontSize:12,color:'var(--muted)'}}>Activity from friends will appear here</p></div>
        :activityFeed.slice(0,30).map((event,i)=><div key={i} className="glass" style={{padding:12,marginBottom:8,display:'flex',alignItems:'center',gap:12}}>
          <div style={{width:40,height:40,borderRadius:'50%',background:'linear-gradient(135deg,var(--secondary),#ec4899)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:16,flexShrink:0}}>
            {event.type==='meal_logged'?'ðŸ½ï¸':event.type==='target_hit'?'ðŸŽ¯':event.type==='badge_earned'?'ðŸ…':event.type==='challenge_created'?'ðŸ†':event.type==='challenge_progress'?'ðŸ’ª':event.type==='friend_added'?'ðŸ¤':'ðŸ“¢'}
          </div>
          <div style={{flex:1,minWidth:0}}>
            <p style={{fontSize:13}}><strong>{event.userName}</strong> {event.message}</p>
            <p style={{fontSize:11,color:'var(--muted)'}}>{getTimeAgo(event.timestamp)}</p>
          </div>
          {event.photo&&<img src={event.photo} style={{width:40,height:40,borderRadius:8,objectFit:'cover',flexShrink:0}}/>}
        </div>)}
      </div>}

      {/* Photo Feed */}
      {friendTab==='photos'&&<div>
        {(()=>{
          const photoEvents=activityFeed.filter(e=>e.photo&&e.type==='meal_logged');
          if(photoEvents.length===0)return<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No meal photos yet</p><p style={{fontSize:12,color:'var(--muted)'}}>Friends' meal photos will appear here</p></div>;
          return photoEvents.slice(0,20).map((event,i)=><div key={i} className="glass" style={{padding:0,marginBottom:16,overflow:'hidden',borderRadius:20}}>
            <div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px'}}>
              <div style={{width:36,height:36,borderRadius:'50%',background:'linear-gradient(135deg,var(--secondary),#ec4899)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}}>{event.userName?.[0]?.toUpperCase()||'?'}</div>
              <div style={{flex:1}}>
                <p style={{fontWeight:600,fontSize:14}}>{event.userName}</p>
                <p style={{fontSize:11,color:'var(--muted)'}}>{getTimeAgo(event.timestamp)}</p>
              </div>
            </div>
            <img src={event.photo} style={{width:'100%',maxHeight:300,objectFit:'cover'}}/>
            <div style={{padding:'12px 16px'}}>
              <p style={{fontSize:13,color:'var(--muted)'}}>{event.message}</p>
            </div>
          </div>)})()}
      </div>}

      {/* Group Challenges */}
      {friendTab==='challenges'&&<div>
        <button onClick={()=>setModal('newChallenge')} className="btn btn-primary" style={{width:'100%',padding:14,marginBottom:16}} disabled={friends.length===0}>+ Create Challenge</button>
        {groupChallenges.length===0?<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No active challenges</p><p style={{fontSize:12,color:'var(--muted)'}}>Create one to challenge your friends!</p></div>
        :groupChallenges.map(ch=>{
          const ud2=users[cur];
          const myProgress=ch.participants[ud2?.oddd]||0;
          const totalProgress=Object.values(ch.participants).reduce((a,b)=>a+b,0);
          const participantCount=Object.keys(ch.participants).length;
          const daysLeft=Math.max(0,Math.ceil((ch.endDate-Date.now())/86400000));
          const pct=ch.type==='total_meals'?Math.min(100,(totalProgress/ch.target)*100):Math.min(100,(myProgress/ch.target)*100);
          return<div key={ch.id} className="glass" style={{padding:16,marginBottom:12,border:ch.completed?'2px solid var(--primary)':'none'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
              <span style={{fontWeight:700}}>{ch.title}</span>
              {ch.completed?<span style={{color:'var(--primary)',fontSize:12,fontWeight:600}}>âœ… Complete!</span>
              :<span style={{fontSize:12,color:daysLeft<=1?'var(--danger)':'var(--muted)'}}>{daysLeft}d left</span>}
            </div>
            <div style={{height:10,background:'var(--subtle)',borderRadius:5,overflow:'hidden',marginBottom:8}}>
              <div style={{height:'100%',width:`${pct}%`,background:ch.completed?'var(--primary)':'linear-gradient(90deg,var(--secondary),var(--primary))',borderRadius:5,transition:'width 0.3s'}}/>
            </div>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,color:'var(--muted)',marginBottom:8}}>
              <span>{ch.type==='total_meals'?`Group: ${totalProgress}/${ch.target}`:`You: ${myProgress}/${ch.target}`}</span>
              <span>{participantCount} participants</span>
            </div>
            {/* Participant bars */}
            <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:8}}>
              {Object.entries(ch.participants).map(([uid,prog])=>{
                const fname=uid===ud2?.oddd?'You':friends.find(f=>f.userId===uid)?.name||'Friend';
                return<div key={uid} style={{flex:'1 0 45%',display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontSize:11,minWidth:40}}>{fname}</span>
                  <div style={{flex:1,height:6,background:'var(--subtle)',borderRadius:3}}>
                    <div style={{height:'100%',width:`${Math.min(100,(prog/ch.target)*100)}%`,background:uid===ud2?.oddd?'var(--primary)':'var(--secondary)',borderRadius:3}}/>
                  </div>
                  <span style={{fontSize:10,color:'var(--muted)'}}>{prog}</span>
                </div>})}
            </div>
            {!ch.completed&&<button onClick={()=>updateChallengeProgress(ch.id,1)} className="btn btn-primary" style={{width:'100%',padding:10,fontSize:13}}>+1 Progress</button>}
          </div>})}
      </div>}

      {/* Friends List */}
      {friendTab==='list'&&<div>
        {friends.length===0?<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No friends yet</p><p style={{fontSize:12,color:'var(--muted)'}}>Enter a friend's code above to add them</p></div>
        :friends.map(f=>{
          const fd=friendsData[f.userId]||{};
          const hasLoggedToday=(fd.mealsLogged||0)>0;
          const lastActive=fd.lastActive?getTimeAgo(fd.lastActive):'Unknown';
          return<div key={f.userId} className="glass" style={{padding:16,marginBottom:12}}>
            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
              <div style={{position:'relative'}}>
                <div style={{width:48,height:48,borderRadius:'50%',background:'linear-gradient(135deg,var(--secondary),#ec4899)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}}>
                  {f.name[0]?.toUpperCase()||'?'}
                </div>
                {!hasLoggedToday&&<div style={{position:'absolute',top:-2,right:-2,width:12,height:12,borderRadius:'50%',background:'var(--accent)',border:'2px solid var(--bg)'}} title="Hasn't logged today"/>}
              </div>
              <div style={{flex:1}}>
                <p style={{fontWeight:700}}>{f.name}</p>
                <p style={{fontSize:12,color:'var(--muted)'}}>Active {lastActive}</p>
              </div>
              <div style={{display:'flex',gap:6}}>
                <button onClick={()=>{setModal('nudgeFriend');setNudgeFriendId(f.userId);setNudgeFriendName(f.name)}} style={{background:'linear-gradient(135deg,rgba(139,92,246,0.3),rgba(236,72,153,0.3))',border:'none',borderRadius:8,padding:'6px 10px',color:'var(--text)',cursor:'pointer',fontSize:12}}>ðŸ‘‹ Nudge</button>
                <button onClick={()=>{if(confirm(`Remove ${f.name}?`))removeFriend(f.userId)}} style={{background:'rgba(239,68,68,0.2)',border:'none',borderRadius:8,padding:'6px 10px',color:'var(--danger)',cursor:'pointer',fontSize:12}}>Remove</button>
              </div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8}}>
              <div style={{background:'var(--subtle-bg)',padding:10,borderRadius:10,textAlign:'center'}}>
                <p style={{fontSize:18,fontWeight:700}}>{fd.calories||0}</p>
                <p style={{fontSize:10,color:'var(--muted)'}}>ðŸ”¥ Cal</p>
              </div>
              <div style={{background:'var(--subtle-bg)',padding:10,borderRadius:10,textAlign:'center'}}>
                <p style={{fontSize:18,fontWeight:700}}>{fd.protein||0}g</p>
                <p style={{fontSize:10,color:'var(--muted)'}}>ðŸ’ª Pro</p>
              </div>
              <div style={{background:'var(--subtle-bg)',padding:10,borderRadius:10,textAlign:'center'}}>
                <p style={{fontSize:18,fontWeight:700}}>{fd.streak||0}</p>
                <p style={{fontSize:10,color:'var(--muted)'}}>ðŸ”¥ Streak</p>
              </div>
            </div>
          </div>})}
      </div>}

      {/* Group Goals */}
      {friendTab==='goals'&&<div>
        <button onClick={()=>setModal('addGoal')} className="btn btn-primary" style={{width:'100%',padding:14,marginBottom:16}}>+ Add Group Goal</button>
        {sharedGoals.length===0?<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No shared goals yet</p><p style={{fontSize:12,color:'var(--muted)'}}>Create a goal to track with friends!</p></div>
        :sharedGoals.map(goal=>{
          const pct=Math.min(100,(goal.current/goal.target)*100);
          const myProg=goal.progress?.[users[cur]?.oddd]||0;
          return<div key={goal.id} className="glass" style={{padding:16,marginBottom:12}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontWeight:600}}>{goal.title}</span>
              <span style={{fontSize:12,color:pct>=100?'var(--primary)':'var(--muted)'}}>{goal.current}/{goal.target}</span>
            </div>
            <div style={{height:8,background:'var(--subtle)',borderRadius:4,overflow:'hidden',marginBottom:8}}>
              <div style={{height:'100%',width:`${pct}%`,background:pct>=100?'var(--primary)':'linear-gradient(90deg,var(--secondary),var(--primary))',borderRadius:4,transition:'width 0.3s'}}/>
            </div>
            <div style={{fontSize:12,color:'var(--muted)',marginBottom:8}}>You: {myProg}</div>
            {pct<100&&<div style={{display:'flex',gap:8}}>
              <button onClick={()=>updateGoalProgress(goal.id,1)} className="btn btn-primary" style={{flex:1,padding:8,fontSize:12}}>+1 Progress</button>
              <button onClick={()=>deleteGoal(goal.id)} className="btn btn-secondary" style={{padding:8,fontSize:12}}>ðŸ—‘ï¸</button>
            </div>}
            {pct>=100&&<div style={{textAlign:'center',marginTop:8,color:'var(--primary)',fontWeight:600}}>Goal Complete! âœ¨</div>}
          </div>})}
      </div>}

      {/* Group Meal Ideas */}
      {friendTab==='mealIdeas'&&<div>
        <button onClick={()=>setModal('suggestMeal')} className="btn btn-primary" style={{width:'100%',padding:14,marginBottom:16}}>+ Suggest Meal</button>
        {mealIdeas.length===0?<div className="glass" style={{padding:24,textAlign:'center'}}><p style={{color:'var(--muted)'}}>No meal suggestions yet</p><p style={{fontSize:12,color:'var(--muted)'}}>Suggest a meal idea for the group!</p></div>
        :mealIdeas.sort((a,b)=>Object.keys(b.votes||{}).length-Object.keys(a.votes||{}).length).map((idea,idx)=>{
          const voteCount=Object.values(idea.votes||{}).filter(v=>v).length;
          const myVote=idea.votes?.[users[cur]?.oddd];
          const isWinner=idx===0&&voteCount>=2;
          return<div key={idea.id} className="glass" style={{padding:16,marginBottom:12,border:isWinner?'2px solid var(--primary)':'none'}}>
            <div style={{display:'flex',gap:12}}>
              {idea.photo&&<img src={idea.photo} style={{width:64,height:64,borderRadius:12,objectFit:'cover'}}/>}
              <div style={{flex:1}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <span style={{fontWeight:600}}>{idea.name}</span>
                  {isWinner&&<span style={{background:'var(--primary)',padding:'2px 8px',borderRadius:8,fontSize:11}}>Winner! ðŸ†</span>}
                </div>
                <p style={{fontSize:12,color:'var(--muted)'}}>by {idea.fromName}</p>
                <div style={{display:'flex',gap:8,marginTop:8}}>
                  <button onClick={()=>voteMealIdea(idea.id,true)} style={{background:myVote===true?'var(--primary)':'var(--subtle)',border:'none',borderRadius:8,padding:'6px 12px',cursor:'pointer',color:'var(--text)'}}>ðŸ‘ {voteCount}</button>
                  <button onClick={()=>voteMealIdea(idea.id,false)} style={{background:myVote===false?'var(--danger)':'var(--subtle)',border:'none',borderRadius:8,padding:'6px 12px',cursor:'pointer',color:'var(--text)'}}>ðŸ‘Ž</button>
                  {idea.from===users[cur]?.oddd&&<button onClick={()=>deleteMealIdea(idea.id)} style={{background:'var(--subtle)',border:'none',borderRadius:8,padding:'6px 12px',cursor:'pointer',color:'var(--muted)'}}>ðŸ—‘ï¸</button>}
                </div>
              </div>
            </div>
          </div>})}
      </div>}

      </div>}
    </div>}

    {tab==='badges'&&<div className="tab-content">
      <h2 style={{fontSize:24,fontWeight:800,marginBottom:8}}>Achievements ðŸ†</h2>
      <p style={{color:'var(--muted)',marginBottom:24}}>{BADGES.filter(b=>b.check(stats)).length}/{BADGES.length} unlocked</p>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:16}}>
        {BADGES.map(b=>{const unlocked=b.check(stats);return<div key={b.id} style={{textAlign:'center'}}>
          <div className={`badge ${unlocked?'unlocked':'locked'}`} style={{background:unlocked?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--subtle)',margin:'0 auto 8px'}}>
            {b.icon}
          </div>
          <p style={{fontSize:11,fontWeight:600}}>{b.name}</p>
          <p style={{fontSize:10,color:'var(--muted)'}}>{b.desc}</p>
        </div>})}
      </div>

      {/* Stats */}
      <h3 style={{fontWeight:700,marginTop:32,marginBottom:16}}>Your Stats ðŸ“Š</h3>
      <div className="glass" style={{padding:20}}>
        {[['Total Meals',stats.totalMeals,'ðŸ½ï¸'],['Current Streak',streak,'ðŸ”¥'],['Water Goals Hit',stats.waterGoals,'ðŸ’§'],['Protein Goals Hit',stats.proteinGoals,'ðŸ’ª'],['Total XP',xp,'â­']].map(([l,v,ic])=>
          <div key={l} style={{display:'flex',justifyContent:'space-between',padding:'12px 0',borderBottom:'1px solid var(--subtle)'}}>
            <span style={{color:'var(--muted)'}}>{ic} {l}</span>
            <span style={{fontWeight:700}}>{v}</span>
          </div>
        )}
      </div>

      {/* Weight */}
      <h3 style={{fontWeight:700,marginTop:24,marginBottom:16}}>Weight Progress âš–ï¸</h3>
      <div className="glass" style={{padding:20}}>
        <div style={{display:'flex',gap:8,marginBottom:16}}>
          <input type="number" value={newWt} onChange={e=>setNewWt(e.target.value)} placeholder={profile.weightUnit||'kg'} style={{flex:1}}/>
          <button onClick={()=>{if(!newWt)return;const raw=parseFloat(newWt),w=profile.weightUnit==='lbs'?r2(raw/2.205):raw;save({...users,[cur]:{...ud,weights:[...weights,{date:getD(),weight:w}]}});setNewWt('')}} className="btn btn-primary">Log</button>
        </div>
        {weights.length>=2?<div style={{height:80,display:'flex',alignItems:'flex-end',gap:4}}>
          {weights.slice(-14).map((w,i,arr)=>{const vals=arr.map(x=>x.weight),min=Math.min(...vals)-1,max=Math.max(...vals)+1;
            return<div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}>
              <div style={{width:'100%',background:'linear-gradient(180deg,var(--primary),var(--secondary))',borderRadius:4,height:`${((w.weight-min)/(max-min||1))*100}%`,minHeight:4}}/>
              <span style={{fontSize:9,color:'var(--muted)',marginTop:4}}>{profile.weightUnit==='lbs'?r2(w.weight*2.205):w.weight}</span>
            </div>})}
        </div>:<p style={{color:'var(--muted)',textAlign:'center'}}>Log 2+ weights to see chart</p>}
      </div>
    </div>}


    {tab==='settings'&&<div className="tab-content">
      <h2 style={{fontSize:24,fontWeight:800,marginBottom:24}}>Settings âš™ï¸</h2>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <div onClick={()=>{const u={...users};u[cur]={...ud,showGuide:!ud.showGuide};save(u)}} style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}}>
          <h3 style={{fontWeight:600}}>How to Use Macrely ðŸ“–</h3>
          <span style={{fontSize:18,transition:'transform 0.3s',transform:ud.showGuide?'rotate(180deg)':'rotate(0deg)'}}>â–¼</span>
        </div>
        {ud.showGuide&&<div style={{marginTop:16}}>

          <div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ  Home Tab</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Your daily dashboard. Log meals by tapping the + button â€” type a description or snap a photo for AI recognition. Track your calories, protein, carbs, and fat against your daily targets. Swipe on a meal to edit or delete it.</p>
          </div>

          <div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ“¸ Profile Picture</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Tap your avatar at the top of Settings to upload a photo. Your profile picture shows up on your partner's dashboard and in your friends' leaderboards and activity feeds â€” it helps them recognize you at a glance.</p>
          </div>

          <div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>âš–ï¸ Update Your Weight</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Tap your weight in the Profile card above to update it. Keeping your weight current recalculates your daily calorie and macro targets so they stay accurate as your body changes. Update it weekly for best results.</p>
          </div>

          <div id="guide-friends" style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ‘¥ Friends Tab</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Add up to 10 friends for friendly competition. Send your Friend Code (shown in Settings below) to a friend â€” they enter it in the Friends tab to connect. You'll see leaderboards, an activity feed, group challenges, shared goals, and meal ideas you can vote on together.</p>
          </div>

          <div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ”— Friend Code</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Your 6-digit code is listed in the Friends section below. Share it with anyone you want to connect with â€” they'll enter it in the Friends tab. You need Firebase set up first for codes to work.</p>
          </div>

          <div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ”‘ AI Food Recognition</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Add a free Gemini API key to snap photos of your food and have AI estimate the calories and macros automatically. Get your key from Google AI Studio and paste it in the AI section below.</p>
          </div>

          {gamificationOn&&<div style={{padding:14,background:'var(--subtle-bg)',borderRadius:12,marginBottom:10}}>
            <p style={{fontWeight:700,marginBottom:6}}>ðŸ† Badges & Quests</p>
            <p style={{fontSize:13,color:'var(--muted)',lineHeight:1.5}}>Complete daily quests to earn XP and level up. Check the Badges tab for achievements you can unlock by hitting streaks, logging meals, and reaching goals.</p>
          </div>}

        </div>}
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:16,marginBottom:16}}>
          <div onClick={()=>document.getElementById('avatarPicSettings').click()} style={{width:64,height:64,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,cursor:'pointer',position:'relative',flexShrink:0}}>
            {ud.profilePic?<img src={ud.profilePic} style={{width:'100%',height:'100%',borderRadius:'50%',objectFit:'cover'}}/>:'ðŸ‘¤'}
            <div style={{position:'absolute',bottom:0,right:0,width:20,height:20,borderRadius:'50%',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,border:'2px solid var(--bg)'}}>ðŸ“·</div>
          </div>
          <input id="avatarPicSettings" type="file" accept="image/*" onChange={async e=>{const f=e.target.files?.[0];if(!f)return;const img=await compress(f,150);const u={...users};u[cur]={...ud,profilePic:img};save(u);if(firebaseConnected&&ud.oddd)db.ref(`users/${ud.oddd}/profile/profilePic`).set(img)}} style={{display:'none'}}/>
          <div>
            <h3 style={{fontWeight:600}}>Profile ðŸ‘¤</h3>
            <p style={{fontSize:12,color:'var(--muted)'}}>Tap photo to change</p>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
          {[['Weight',`${profile.weightUnit==='lbs'?r2(profile.weight*2.205):r2(profile.weight)} ${profile.weightUnit||'kg'}`],
            ['Height',profile.heightUnit==='ft'?`${Math.floor(profile.height/30.48)}'${Math.round((profile.height%30.48)/2.54)}"`:`${r2(profile.height)} cm`],
            ['Activity',profile.activity?.replace('_',' ')],
            ['Goal',profile.goal]].map(([l,v])=>
            <div key={l} style={{padding:12,background:'var(--subtle-bg)',borderRadius:12}}>
              <p style={{fontSize:12,color:'var(--muted)'}}>{l}</p>
              <p style={{fontWeight:600,textTransform:'capitalize'}}>{v}</p>
            </div>
          )}
        </div>
        <div style={{display:'flex',gap:8,marginTop:16}}>
          {['lose','maintain','gain'].map(g=><button key={g} onClick={()=>setGoal(g)} className="btn" style={{flex:1,background:profile.goal===g?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',textTransform:'capitalize',padding:10}}>{g}</button>)}
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Appearance ðŸŽ¨</h3>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span>Light Mode</span>
          <button onClick={toggleLight} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:lightMode?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:lightMode?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>App Updates ðŸ”„</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:4}}>Current version: <strong>v{APP_VERSION}</strong></p>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>When new updates are available, a "What's New" popup appears on startup. You can also check manually below.</p>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>{setShowPatchNotes(true)}} className="btn btn-secondary" style={{flex:1,padding:12}}>View Patch Notes</button>
          <button onClick={async()=>{
            try{
              const res=await fetch(window.location.origin+'/index.html?_cb='+Date.now(),{cache:'no-store'});
              const text=await res.text();
              const match=text.match(/APP_VERSION='([^']+)'/);
              if(match&&match[1]!==APP_VERSION){
                if(confirm('New version v'+match[1]+' available! Update now?')){
                  if('caches' in window){const names=await caches.keys();await Promise.all(names.map(n=>caches.delete(n)))}
                  window.location.reload(true);
                }
              }else{
                alert('You\'re on the latest version (v'+APP_VERSION+')');
              }
            }catch(e){alert('Could not check for updates. Check your connection.')}
          }} className="btn btn-primary" style={{flex:1,padding:12}}>Check for Updates</button>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Gamification ðŸŽ®</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Enable daily quests, XP, levels, and badges</p>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span>Gamification</span>
          <button onClick={()=>{const u={...users};u[cur]={...ud,gamificationOn:!gamificationOn};save(u)}} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:gamificationOn?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:gamificationOn?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Hydration ðŸ’§</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Track daily water intake on home screen</p>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span>Hydration Tracking</span>
          <button onClick={()=>{const u={...users};u[cur]={...ud,hydrationOn:!hydrationOn};save(u)}} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:hydrationOn?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:hydrationOn?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Display Preferences ðŸ‘ï¸</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Control what's visible on your dashboard</p>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
          <span>Show Sugar in Macros</span>
          <button onClick={()=>{const u={...users};const ndp={...dp,showSugar:!dp.showSugar};u[cur]={...ud,displayPrefs:ndp};save(u)}} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:dp.showSugar?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:dp.showSugar?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
          <span>Show Gut Health</span>
          <button onClick={()=>{const u={...users};const ndp={...dp,showGutHealth:!dp.showGutHealth};u[cur]={...ud,displayPrefs:ndp};save(u)}} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:dp.showGutHealth?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:dp.showGutHealth?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
        <div style={{borderTop:'1px solid var(--subtle)',paddingTop:12}}>
          <p style={{fontSize:13,fontWeight:600,marginBottom:8}}>Hide Metrics</p>
          <p style={{fontSize:11,color:'var(--muted)',marginBottom:8}}>Uncheck metrics you don't want to see in analytics or meal details</p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            {Object.entries(MACRO_INFO).map(([key,info])=>{const hidden=(dp.hiddenMacros||[]).includes(key);return<button key={key} onClick={()=>{const u={...users};const hm=[...(dp.hiddenMacros||[])];const idx=hm.indexOf(key);if(idx>=0)hm.splice(idx,1);else hm.push(key);const ndp={...dp,hiddenMacros:hm};u[cur]={...ud,displayPrefs:ndp};save(u)}} style={{display:'flex',alignItems:'center',gap:6,padding:'6px 8px',background:hidden?'var(--subtle-bg)':'rgba(16,185,129,0.15)',border:hidden?'1px solid var(--subtle)':'1px solid rgba(16,185,129,0.3)',borderRadius:8,cursor:'pointer',color:'var(--text)',fontSize:12}}>
              <span>{hidden?'â—‹':'âœ“'}</span>
              <span>{info.emoji} {info.name}</span>
            </button>})}
          </div>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Meal Reminders â°</h3>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
          <span>Show reminders</span>
          <button onClick={()=>{const u={...users};u[cur]={...ud,remindersOff:!ud.remindersOff};save(u)}} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:!ud.remindersOff?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:!ud.remindersOff?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Learned meal times (log more meals to improve):</p>
        {['Breakfast','Lunch','Dinner','Snack'].map(cat=>{
          const times=(ud.mealTimes||{})[cat]||[];
          if(times.length<2)return<div key={cat} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}><span style={{color:'var(--muted)'}}>{cat}</span><span style={{color:'var(--muted)',fontSize:12}}>Not enough data</span></div>;
          const mins=times.map(t=>{const[h,m]=t.split(':').map(Number);return h*60+m});
          const avgMins=Math.round(mins.reduce((a,b)=>a+b,0)/mins.length);
          const avgH=Math.floor(avgMins/60),avgM=avgMins%60;
          const ampm=avgH>=12?'PM':'AM';const h12=avgH%12||12;
          return<div key={cat} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}><span>{cat}</span><span style={{color:'var(--primary)'}}>~{h12}:{avgM.toString().padStart(2,'0')} {ampm}</span></div>;
        })}
        <button onClick={()=>{const u={...users};u[cur]={...ud,mealTimes:{}};save(u);alert('Meal times reset!')}} className="btn btn-secondary" style={{width:'100%',marginTop:16,padding:12}}>Reset Learned Times</button>
      </div>

      {gamificationOn&&<div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Daily Quests âš”ï¸</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Pick 3 quests for your home screen</p>
        {Object.values(ALL_QUESTS).map(q=>{
          const selected=selectedQuestIds.includes(q.id);
          return<button key={q.id} onClick={()=>{
            let newSel=[...selectedQuestIds];
            if(selected){
              if(newSel.length<=1)return;
              newSel=newSel.filter(id=>id!==q.id);
            }else{
              if(newSel.length>=3)newSel.shift();
              newSel.push(q.id);
            }
            const u={...users};u[cur]={...ud,selectedQuests:newSel};save(u);
          }} style={{display:'flex',alignItems:'center',gap:12,width:'100%',padding:12,marginBottom:8,background:selected?'rgba(16,185,129,0.15)':'var(--subtle-bg)',border:selected?'1px solid rgba(16,185,129,0.4)':'1px solid var(--subtle-bg)',borderRadius:12,cursor:'pointer',textAlign:'left',color:'var(--text)'}}>
            <span style={{fontSize:20,width:32,textAlign:'center'}}>{q.icon}</span>
            <div style={{flex:1}}>
              <p style={{fontWeight:600,fontSize:14}}>{q.title}</p>
              <p style={{fontSize:11,color:'var(--muted)'}}>+{q.xp} XP</p>
            </div>
            <span style={{fontSize:18,color:selected?'var(--primary)':'var(--muted)'}}>{selected?'âœ“':'â—‹'}</span>
          </button>})}
      </div>}

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Friends ðŸ‘¥</h3>
        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}>
          <span style={{color:'var(--muted)'}}>Friends</span>
          <span style={{fontWeight:600}}>{friends.length}/10</span>
        </div>
        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}>
          <span style={{color:'var(--muted)'}}>Your Friend Code</span>
          <span style={{fontWeight:600,letterSpacing:2}}>{partnerCode||'N/A'}</span>
        </div>
        <div style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}>
          <span style={{color:'var(--muted)'}}>Active Challenges</span>
          <span style={{fontWeight:600}}>{groupChallenges.filter(c=>!c.completed).length}</span>
        </div>
        <button onClick={()=>{setActivityFeed([]);alert('Activity feed cleared!')}} className="btn btn-secondary" style={{width:'100%',marginTop:12,padding:12}}>Clear Activity Feed</button>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>AI Food Recognition ðŸ”‘</h3>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:12}}>Gemini API key for photo analysis</p>
        <input type="password" value={api} onChange={e=>setApi(e.target.value)} placeholder="Enter API key"/>
        <button onClick={()=>{st.set('nt_api',api);alert('Saved!')}} className="btn btn-primary" style={{width:'100%',marginTop:12}}>Save Key</button>
        <div style={{borderTop:'1px solid var(--subtle)',marginTop:16,paddingTop:12}}>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,color:'var(--muted)',marginBottom:8}}>
            <span>API calls today: {JSON.parse(st.get('nt_api_usage')||'{}')[getD()]||0}</span>
            <span>Total: {Object.values(JSON.parse(st.get('nt_api_usage')||'{}')).reduce((a,b)=>a+b,0)}</span>
          </div>
          <button onClick={async()=>{
            const usage=JSON.parse(st.get('nt_api_usage')||'{}');
            const totalCalls=Object.values(usage).reduce((a,b)=>a+b,0);
            const todayCalls=usage[getD()]||0;
            const cv=document.createElement('canvas');cv.width=800;cv.height=400;
            const ctx=cv.getContext('2d');
            ctx.fillStyle='#0f0f23';ctx.fillRect(0,0,800,400);
            ctx.font='bold 28px -apple-system,sans-serif';ctx.fillStyle='#10b981';
            ctx.fillText('Macrely API Usage',30,50);
            ctx.font='16px -apple-system,sans-serif';ctx.fillStyle='#fff';
            ctx.fillText(`User: ${cur}`,30,90);
            ctx.fillText(`Today: ${todayCalls} calls`,30,120);
            ctx.fillText(`Total: ${totalCalls} calls`,30,150);
            ctx.fillText(`Date: ${getD()}`,30,180);
            // Usage history bars
            const days=Object.entries(usage).sort((a,b)=>a[0].localeCompare(b[0])).slice(-14);
            if(days.length>0){
              ctx.fillText('Last 14 days:',30,220);
              const maxVal=Math.max(...days.map(d=>d[1]),1);
              days.forEach(([date,count],i)=>{
                const x=30+i*52;
                const h=Math.max(4,(count/maxVal)*120);
                ctx.fillStyle='#10b981';ctx.beginPath();ctx.roundRect(x,340-h,44,h,4);ctx.fill();
                ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='10px sans-serif';ctx.textAlign='center';
                ctx.fillText(count,x+22,335-h);
                ctx.fillText(date.split('/')[0],x+22,358);
                ctx.textAlign='left';
              });
            }
            ctx.font='12px sans-serif';ctx.fillStyle='rgba(255,255,255,0.3)';ctx.fillText('Macrely Usage Report',30,390);
            const blob=await new Promise(r=>cv.toBlob(r,'image/png'));
            const file=new File([blob],'nutritrack-usage.png',{type:'image/png'});
            if(navigator.canShare&&navigator.canShare({files:[file]})){
              await navigator.share({files:[file],title:'Macrely Usage'});
            }else{
              const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='nutritrack-usage.png';a.click();
            }
          }} className="btn btn-secondary" style={{width:'100%',padding:12,marginBottom:12}}>ðŸ“Š Share Usage Report</button>
        </div>
        <div style={{borderTop:'1px solid var(--subtle)',marginTop:4,paddingTop:12}}>
          <p style={{fontSize:12,color:'var(--muted)',marginBottom:8}}>Or enter PIN to use shared key</p>
          <div style={{display:'flex',gap:8}}>
            <input id="pin-input" type="password" placeholder="Enter PIN" maxLength={8} style={{flex:1,textAlign:'center',letterSpacing:4}}/>
            <button onClick={()=>{
              const pin=document.getElementById('pin-input').value;
              const PINS={'1234':'REMOVED_KEY'};
              if(PINS[pin]){setApi(PINS[pin]);st.set('nt_api',PINS[pin]);alert('API key activated!')}
              else{alert('Invalid PIN')}
            }} className="btn btn-secondary" style={{padding:'12px 20px'}}>Unlock</button>
          </div>
        </div>
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>API Usage (All Users) ðŸ“Š</h3>
        <div style={{display:'flex',gap:8,marginBottom:12}}>
          {['today','yesterday','week'].map(p=><button key={p} onClick={()=>{setApiUsageDate(p);const now=new Date();if(p==='today'){loadApiUsage(getD().replace(/\//g,'-'))}else if(p==='yesterday'){now.setDate(now.getDate()-1);loadApiUsage(getD(now).replace(/\//g,'-'))}else{setApiUsageData({});const week={};for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()-i);const dk=getD(d).replace(/\//g,'-');db&&db.ref(`apiUsage/${dk}`).once('value',snap=>{const data=snap.val()||{};Object.entries(data).forEach(([u,c])=>{week[u]=(week[u]||0)+c});setApiUsageData({...week})})}}}} className="btn" style={{flex:1,padding:8,fontSize:12,background:apiUsageDate===p?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',border:'1px solid var(--card-border)',color:apiUsageDate===p?'#fff':'var(--text)'}}>{p==='today'?'Today':p==='yesterday'?'Yesterday':'This Week'}</button>)}
        </div>
        {Object.keys(apiUsageData).length===0&&<p style={{fontSize:13,color:'var(--muted)',textAlign:'center',padding:16}}>No API usage data. Tap a date range to load.</p>}
        {Object.entries(apiUsageData).sort((a,b)=>b[1]-a[1]).map(([username,count])=><div key={username} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:10,background:'var(--subtle-bg)',borderRadius:10,marginBottom:6}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <div style={{width:32,height:32,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,color:'#fff',fontWeight:700}}>{username.charAt(0).toUpperCase()}</div>
            <span style={{fontWeight:600,fontSize:14}}>{username}</span>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <span style={{fontWeight:700,color:'var(--primary)'}}>{count}</span>
            {apiUsageFriendCodes[username]&&<span style={{fontSize:11,color:'var(--muted)',background:'var(--subtle)',padding:'2px 6px',borderRadius:6}}>{apiUsageFriendCodes[username]}</span>}
          </div>
        </div>)}
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <div onClick={()=>{const u={...users};u[cur]={...ud,showLogs:!ud.showLogs};save(u)}} style={{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}}>
          <h3 style={{fontWeight:600}}>Logs ðŸ“‹</h3>
          <span style={{fontSize:18,transition:'transform 0.3s',transform:ud.showLogs?'rotate(180deg)':'rotate(0deg)'}}>â–¼</span>
        </div>
        {ud.showLogs&&<div style={{marginTop:16}}>
          <div style={{display:'flex',gap:8,marginBottom:16}}>
            <button onClick={()=>{const u={...users};u[cur]={...ud,logTab:'changelog'};save(u)}} className="btn" style={{flex:1,padding:10,fontSize:13,background:(ud.logTab||'changelog')==='changelog'?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',border:'1px solid var(--card-border)'}}>Changelog</button>
            <button onClick={()=>{const u={...users};u[cur]={...ud,logTab:'weekly'};save(u)}} className="btn" style={{flex:1,padding:10,fontSize:13,background:ud.logTab==='weekly'?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--card)',border:'1px solid var(--card-border)'}}>Weekly Stats</button>
          </div>
          {(ud.logTab||'changelog')==='changelog'&&<div>
            {PATCH_NOTES.map((pn,pi)=><div key={pi} style={{marginBottom:16,padding:12,background:'var(--subtle-bg)',borderRadius:12}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                <span style={{background:'linear-gradient(135deg,var(--primary),var(--secondary))',borderRadius:6,padding:'2px 8px',fontSize:11,fontWeight:700,color:'#fff'}}>v{pn.version}</span>
                <span style={{fontSize:12,color:'var(--muted)'}}>{pn.date}</span>
              </div>
              <p style={{fontWeight:600,fontSize:14,marginBottom:6}}>{pn.title}</p>
              {pn.items.map((item,ii)=><div key={ii} style={{display:'flex',gap:6,marginBottom:4,fontSize:12,color:'var(--muted)'}}>
                <span style={{color:'var(--primary)',flexShrink:0}}>â€¢</span>
                <span>{item}</span>
              </div>)}
            </div>)}
          </div>}
          {ud.logTab==='weekly'&&<div>
            {(ud.weeklyLogs||[]).length===0&&<p style={{color:'var(--muted)',fontSize:13,textAlign:'center',padding:20}}>No weekly logs yet. Stats are saved at the end of each week.</p>}
            {[...(ud.weeklyLogs||[])].reverse().map((wk,wi)=><div key={wi} style={{marginBottom:12,padding:12,background:'var(--subtle-bg)',borderRadius:12}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
                <span style={{fontWeight:700,fontSize:14}}>{wk.start} â€” {wk.end}</span>
                <span style={{fontSize:11,color:'var(--muted)'}}>{wk.days} days logged</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8}}>
                {[['Calories',wk.avgs.calories,'cal'],['Protein',wk.avgs.protein,'g'],['Carbs',wk.avgs.carbs,'g'],['Fat',wk.avgs.fat,'g'],['Water',wk.avgWater,'ml'],['Meals',Math.round(wk.totalMeals/wk.days),'avg/day']].map(([label,val,unit],mi)=><div key={mi} style={{textAlign:'center',padding:8,background:'var(--subtle-bg)',borderRadius:8}}>
                  <p style={{fontSize:16,fontWeight:700}}>{val}</p>
                  <p style={{fontSize:10,color:'var(--muted)'}}>{label} ({unit})</p>
                </div>)}
              </div>
            </div>)}
          </div>}
        </div>}
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Daily Targets ðŸŽ¯</h3>
        {Object.entries(tgt).map(([k,v])=><div key={k} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--subtle-bg)'}}>
          <span style={{textTransform:'capitalize'}}>{k}</span>
          <span style={{color:'var(--primary)'}}>{v}{k==='calories'?'':k==='sodium'?'mg':'g'}</span>
        </div>)}
      </div>

      <div className="glass" style={{padding:20,marginBottom:16}}>
        <h3 style={{fontWeight:600,marginBottom:12}}>Photo Storage ðŸ“·</h3>
        <div style={{marginBottom:12}}>
          <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
            <span style={{color:'var(--muted)'}}>Storage used</span>
            <span>{(getStorageUsage()/1024/1024).toFixed(2)} MB / {(STORAGE_LIMIT/1024/1024).toFixed(0)} MB</span>
          </div>
          <div style={{height:8,background:'var(--subtle)',borderRadius:4}}>
            <div style={{height:'100%',width:`${Math.min(100,(getStorageUsage()/STORAGE_LIMIT)*100)}%`,background:getStorageUsage()>STORAGE_LIMIT*0.8?'var(--danger)':'linear-gradient(90deg,var(--primary),var(--secondary))',borderRadius:4}}/>
          </div>
        </div>
        <button onClick={()=>{
          const u={...users};const d={...u[cur]};
          const thirtyDaysAgo=Date.now()-30*24*60*60*1000;
          d.log=(d.log||[]).map(m=>m.id<thirtyDaysAgo?{...m,photo:undefined}:m);
          d.hist=(d.hist||[]).map(h=>({...h,meals:(h.meals||[]).map(m=>({...m,photo:undefined}))}));
          u[cur]=d;save(u);alert('Old photos cleared!');
        }} className="btn btn-secondary" style={{width:'100%',padding:12}}>Clear Photos Older Than 30 Days</button>
      </div>

      <button onClick={sw} className="btn" style={{width:'100%',background:'rgba(239,68,68,0.2)',border:'1px solid rgba(239,68,68,0.3)',color:'var(--danger)'}}>Switch User</button>
    </div>}
  </div>

  {/* FAB */}
  <button onClick={()=>{tapFeedback();setModal('add')}} style={{position:'fixed',bottom:100,right:20,width:60,height:60,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',border:'none',color:'#fff',fontSize:28,cursor:'pointer',boxShadow:'0 4px 20px rgba(16,185,129,0.4)',transition:'transform 0.15s'}} className="animate-pulse">+</button>

  {/* Bottom Nav */}
  <div style={{position:'fixed',bottom:0,left:0,right:0,background:'var(--nav-bg)',backdropFilter:'blur(20px)',borderTop:'1px solid var(--card-border)',display:'flex',padding:'8px 0'}}>
    {[['home','ðŸ ','Home'],['friends','ðŸ‘¥','Friends'],['badges','ðŸ†','Badges'],['settings','âš™ï¸','Settings']].filter(([k])=>k!=='badges'||gamificationOn).map(([k,ic,l])=>
      <button key={k} onClick={()=>{tapFeedback();setTab(k);if(k==='friends')setFriendsNotify(false)}} className="nav-item" style={{background:'none',border:'none',cursor:'pointer',position:'relative',transition:'transform 0.15s ease'}}>
        {tab===k&&<span style={{position:'absolute',top:-2,width:20,height:4,background:'var(--primary)',borderRadius:2,animation:'navDotIn 0.3s ease'}}/>}
        <span style={{fontSize:24,transition:'transform 0.2s ease',transform:tab===k?'scale(1.15)':'scale(1)',display:'inline-block'}}>{ic}</span>
        <span style={{fontSize:11,transition:'color 0.2s'}}>{l}</span>
        {k==='friends'&&friendsNotify&&<span style={{position:'absolute',top:4,right:'calc(50% - 20px)',width:8,height:8,borderRadius:'50%',background:'var(--accent)'}}/>}
      </button>
    )}
  </div>

  {/* Modals */}
  {modal==='add'&&<div className="modal-overlay" onClick={()=>setModal(null)}>
    <div className="modal" onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:20}}>Add Food</h2>
      <button onClick={()=>document.getElementById('cam').click()} className="btn btn-primary" style={{width:'100%',padding:16,marginBottom:12,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
        <span>ðŸ“¸</span> Take Photo
      </button>
      <input id="cam" type="file" accept="image/*" capture="environment" onChange={photo} style={{display:'none'}}/>
      <button onClick={()=>document.getElementById('gal').click()} className="btn btn-secondary" style={{width:'100%',padding:16,marginBottom:12}}>
        ðŸ–¼ï¸ Choose from Gallery
      </button>
      <input id="gal" type="file" accept="image/*" onChange={photo} style={{display:'none'}}/>
      <button onClick={startBarcodeScanner} className="btn btn-secondary" style={{width:'100%',padding:16,marginBottom:12}}>
        ðŸ“Š Scan Barcode
      </button>
      <button onClick={()=>{setModal(null);startVoiceRecording()}} className="btn btn-secondary" style={{width:'100%',padding:16,marginBottom:12}}>
        ðŸŽ™ï¸ Speak Meal
      </button>
      <button onClick={()=>{setManual({...EMPTY});setModal('manual')}} className="btn btn-secondary" style={{width:'100%',padding:16}}>
        âœï¸ Manual Entry
      </button>
    </div>
  </div>}

  {modal==='barcode'&&<div className="modal-overlay modal-center" onClick={()=>{stopBarcodeScanner();setModal(null)}}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:16}}>Scan Barcode ðŸ“Š</h2>
      {barcodeScanning&&<div style={{position:'relative',width:'100%',borderRadius:16,overflow:'hidden',marginBottom:16,background:'#000'}}>
        <video ref={barcodeVideoRef} style={{width:'100%',height:240,objectFit:'cover'}} playsInline muted/>
        <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',pointerEvents:'none'}}>
          <div style={{width:'70%',height:80,border:'2px solid var(--primary)',borderRadius:12,boxShadow:'0 0 0 9999px rgba(0,0,0,0.4)'}}/>
        </div>
      </div>}
      {barcodeError&&<p style={{color:'var(--accent)',fontSize:13,marginBottom:12,padding:12,background:'rgba(245,158,11,0.1)',borderRadius:12}}>{barcodeError}</p>}
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Or enter barcode number</label>
        <div style={{display:'flex',gap:8}}>
          <input id="barcodeInput" type="text" inputMode="numeric" placeholder="e.g. 5000159484695" style={{flex:1}}/>
          <button onClick={()=>{const v=document.getElementById('barcodeInput').value.trim();if(v)lookupBarcode(v);else setBarcodeError('Enter a barcode number')}} className="btn btn-primary" style={{padding:'12px 20px'}}>Look Up</button>
        </div>
      </div>
      <button onClick={()=>{stopBarcodeScanner();setModal('add')}} className="btn btn-secondary" style={{width:'100%',padding:14}}>Back</button>
    </div>
  </div>}

  {modal==='manual'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:20}}>Manual Entry</h2>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
        {Object.keys(EMPTY).map(k=><div key={k}>
          <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block',textTransform:'capitalize'}}>{k}</label>
          <input type="number" value={manual[k]||''} onChange={e=>setManual({...manual,[k]:+e.target.value})} placeholder="0"/>
        </div>)}
      </div>
      <button onClick={()=>add({...manual,category:getM(),time:getT(),items:[{name:'Manual',quantity:'1',...manual}]})} className="btn btn-primary" style={{width:'100%',marginTop:20,padding:14}}>Add Meal</button>
    </div>
  </div>}

  {modal==='confirm'&&pending&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:4}}>Confirm Meal</h2>
      <p style={{fontSize:13,color:'var(--muted)',marginBottom:16}}>{pending.category}{pending.date&&pending.date!==getD()?' â€” '+pending.date:''} at {pending.time}</p>
      {foodPhoto&&<img src={foodPhoto} style={{width:'100%',height:160,objectFit:'cover',borderRadius:16,marginBottom:16}}/>}
      {(pending.items||[]).map((it,i)=><div key={i}>
        <div onClick={()=>{setEditingItem(i);setEditItemText('');setEditItemSuggestion(null)}} style={{padding:12,background:'var(--subtle-bg)',borderRadius:12,marginBottom:it.clarify?4:8,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div style={{flex:1}}><p style={{fontWeight:600}}>{it.name}</p>
        <p style={{fontSize:13,color:'var(--muted)'}}>{it.quantity} â€” {Math.round(it.calories||0)} cal</p></div>
        {dp.showGutHealth&&it.gutHealth&&<div style={{display:'flex',flexDirection:'column',alignItems:'center',marginRight:8}}><span style={{fontSize:11,fontWeight:700,padding:'2px 8px',borderRadius:8,color:'#fff',background:it.gutHealth>=7?'#22c55e':it.gutHealth>=4?'#f59e0b':'#ef4444'}}>{it.gutHealth}/10</span>{it.gutTip&&<span style={{fontSize:9,color:'var(--muted)',maxWidth:80,textAlign:'center'}}>{it.gutTip}</span>}</div>}
        <span style={{fontSize:14,color:'var(--muted)'}}>âœï¸</span>
      </div>
      {it.clarify&&<div style={{padding:8,background:'rgba(245,158,11,0.1)',border:'1px solid rgba(245,158,11,0.2)',borderRadius:10,marginBottom:8,display:'flex',alignItems:'center',gap:6}}>
        <span style={{fontSize:12,color:'var(--accent)',flex:1}}>{it.clarify}</span>
        <input id={`clarify-${i}`} placeholder="Answer..." style={{flex:1,padding:6,fontSize:12,borderRadius:8,border:'1px solid var(--input-border)',background:'var(--subtle-bg)',color:'inherit'}}/>
        <button onClick={(e)=>{e.stopPropagation();const ans=document.getElementById(`clarify-${i}`).value;if(ans.trim()){setEditItemLoading(true);aiCleanupItem(ans.trim()+' '+it.name).then(()=>{if(editItemSuggestion){replaceIngredient(i,editItemSuggestion)}})}}} style={{background:'var(--primary)',border:'none',borderRadius:6,color:'#fff',padding:'4px 8px',fontSize:12,cursor:'pointer'}}>âœ“</button>
        <button onClick={(e)=>{e.stopPropagation();const items=[...(pending.items||[])];items[i]={...items[i],clarify:null};recalcPending(items)}} style={{background:'none',border:'none',color:'var(--muted)',fontSize:14,cursor:'pointer',padding:'2px 4px'}}>âœ•</button>
      </div>}
      </div>)}
      <button onClick={(e)=>{e.stopPropagation();setAddingItem(true);setAddItemText('');setAddItemSuggestion(null)}} style={{width:'100%',padding:10,background:'none',border:'1px dashed var(--muted)',borderRadius:12,color:'var(--muted)',cursor:'pointer',marginBottom:8,fontSize:14}}>+ Add Item</button>
      {dp.showGutHealth&&pending.items&&pending.items.some(it=>it.gutHealth)&&<div style={{padding:10,background:'var(--subtle-bg)',borderRadius:12,marginBottom:8,display:'flex',alignItems:'center',justifyContent:'space-between'}}><span style={{fontSize:13,fontWeight:600}}>Gut Health Score</span>{(()=>{const scores=pending.items.filter(it=>it.gutHealth).map(it=>it.gutHealth);const avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length*10)/10;return<span style={{fontWeight:700,padding:'2px 10px',borderRadius:8,color:'#fff',background:avg>=7?'#22c55e':avg>=4?'#f59e0b':'#ef4444'}}>{avg}/10</span>})()}</div>}
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,margin:'16px 0'}}>
        {[['ðŸ”¥',pending.calories,'cal'],['ðŸ’ª',pending.protein,'g'],['ðŸŒ¾',pending.carbs,'g'],['ðŸ«’',pending.fat,'g']].map(([ic,v,u])=>
          <div key={ic} style={{padding:10,background:'var(--subtle-bg)',borderRadius:12,textAlign:'center'}}>
            <span>{ic}</span>
            <p style={{fontWeight:700,fontSize:14}}>{r2(v)}</p>
            <p style={{fontSize:10,color:'var(--muted)'}}>{u}</p>
          </div>
        )}
      </div>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>{setModal(null);setPending(null);setFoodPhoto(null)}} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={()=>add(pending,foodPhoto)} className="btn btn-primary" style={{flex:1,padding:14}}>Add Meal</button>
      </div>
      {foodPhoto&&<button onClick={()=>shareMeal(foodPhoto,pending,pending.items,pending.category,pending.time)} className="btn" style={{width:'100%',marginTop:12,padding:14,background:'linear-gradient(135deg,#3b82f6,#8b5cf6)',border:'none',color:'#fff'}}>ðŸ“¤ Share with Macros</button>}
    </div>
  </div>}

  {showPatchNotes&&<div className="modal-overlay modal-center" onClick={()=>{setShowPatchNotes(false);st.set('nt_last_version',APP_VERSION)}}>
    <div className="modal" style={{borderRadius:24,maxWidth:420,maxHeight:'80vh',overflowY:'auto'}} onClick={e=>e.stopPropagation()}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
        <h2 style={{fontSize:20,fontWeight:700}}>What's New</h2>
        <button onClick={()=>{setShowPatchNotes(false);st.set('nt_last_version',APP_VERSION)}} style={{background:'none',border:'none',color:'var(--muted)',fontSize:20,cursor:'pointer'}}>âœ•</button>
      </div>
      {PATCH_NOTES.map((pn,pi)=><div key={pi} style={{marginBottom:pi<PATCH_NOTES.length-1?24:0}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
          <span style={{background:'linear-gradient(135deg,var(--primary),var(--secondary))',borderRadius:8,padding:'2px 8px',fontSize:11,fontWeight:700,color:'#fff'}}>v{pn.version}</span>
          <span style={{fontSize:12,color:'var(--muted)'}}>{pn.date}</span>
        </div>
        <p style={{fontWeight:600,fontSize:15,marginBottom:8}}>{pn.title}</p>
        {pn.items.map((item,ii)=><div key={ii} style={{display:'flex',gap:8,marginBottom:6,fontSize:13,color:'var(--muted)'}}>
          <span style={{color:'var(--primary)',flexShrink:0}}>â€¢</span>
          <span>{item}</span>
        </div>)}
      </div>)}
    </div>
  </div>}

  {editingItem!==null&&pending&&pending.items&&pending.items[editingItem]&&<div className="modal-overlay modal-center" onClick={()=>setEditingItem(null)}>
    <div className="modal" style={{borderRadius:24,maxWidth:400}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:18,fontWeight:700,marginBottom:12}}>Edit Ingredient</h2>
      <div style={{padding:12,background:'var(--subtle-bg)',borderRadius:12,marginBottom:16}}>
        <p style={{fontWeight:600}}>{pending.items[editingItem].name}</p>
        <p style={{fontSize:13,color:'var(--muted)'}}>{pending.items[editingItem].quantity} â€” {Math.round(pending.items[editingItem].calories||0)} cal</p>
      </div>
      {!editItemSuggestion&&<div>
        <input value={editItemText} onChange={e=>setEditItemText(e.target.value)} placeholder='e.g. "1 tbsp Pics peanut butter"' style={{width:'100%',padding:12,borderRadius:12,border:'1px solid var(--input-border)',background:'var(--subtle-bg)',color:'inherit',fontSize:14,marginBottom:8,boxSizing:'border-box'}}/>
        <p style={{fontSize:11,color:'var(--muted)',marginBottom:16}}>Tip: include product name, brand, and amount for best accuracy</p>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>{removeIngredient(editingItem)}} className="btn btn-secondary" style={{flex:1,padding:12}}>Remove</button>
          <button onClick={()=>{if(editItemText.trim())aiCleanupItem(editItemText.trim())}} disabled={!editItemText.trim()||editItemLoading} className="btn btn-primary" style={{flex:1,padding:12}}>{editItemLoading?'Analyzing...':'Replace'}</button>
        </div>
      </div>}
      {editItemSuggestion&&<div>
        <p style={{fontSize:13,color:'var(--muted)',marginBottom:8}}>Did you mean:</p>
        <div style={{padding:12,background:'var(--subtle)',borderRadius:12,marginBottom:16}}>
          <p style={{fontWeight:700}}>{editItemSuggestion.name}</p>
          <p style={{fontSize:13,color:'var(--muted)'}}>{editItemSuggestion.quantity} â€” {Math.round(editItemSuggestion.calories||0)} cal, {Math.round(editItemSuggestion.protein||0)}g protein, {Math.round(editItemSuggestion.carbs||0)}g carbs, {Math.round(editItemSuggestion.fat||0)}g fat</p>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>setEditItemSuggestion(null)} className="btn btn-secondary" style={{flex:1,padding:12}}>Edit Again</button>
          <button onClick={()=>replaceIngredient(editingItem,editItemSuggestion)} className="btn btn-primary" style={{flex:1,padding:12}}>Accept</button>
        </div>
      </div>}
    </div>
  </div>}

  {addingItem&&pending&&<div className="modal-overlay modal-center" onClick={()=>setAddingItem(false)}>
    <div className="modal" style={{borderRadius:24,maxWidth:400}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:18,fontWeight:700,marginBottom:12}}>Add Item</h2>
      {!addItemSuggestion&&<div>
        <input value={addItemText} onChange={e=>setAddItemText(e.target.value)} placeholder='e.g. "1 banana" or "200g chicken breast"' style={{width:'100%',padding:12,borderRadius:12,border:'1px solid var(--input-border)',background:'var(--subtle-bg)',color:'inherit',fontSize:14,marginBottom:8,boxSizing:'border-box'}}/>
        <p style={{fontSize:11,color:'var(--muted)',marginBottom:16}}>Describe the food item with quantity for best accuracy</p>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>setAddingItem(false)} className="btn btn-secondary" style={{flex:1,padding:12}}>Cancel</button>
          <button onClick={()=>{if(addItemText.trim())aiCleanupItem(addItemText.trim(),true)}} disabled={!addItemText.trim()||editItemLoading} className="btn btn-primary" style={{flex:1,padding:12}}>{editItemLoading?'Analyzing...':'Analyze'}</button>
        </div>
      </div>}
      {addItemSuggestion&&<div>
        <p style={{fontSize:13,color:'var(--muted)',marginBottom:8}}>Found:</p>
        <div style={{padding:12,background:'var(--subtle)',borderRadius:12,marginBottom:16}}>
          <p style={{fontWeight:700}}>{addItemSuggestion.name}</p>
          <p style={{fontSize:13,color:'var(--muted)'}}>{addItemSuggestion.quantity} â€” {Math.round(addItemSuggestion.calories||0)} cal, {Math.round(addItemSuggestion.protein||0)}g protein, {Math.round(addItemSuggestion.carbs||0)}g carbs, {Math.round(addItemSuggestion.fat||0)}g fat</p>
          {dp.showGutHealth&&addItemSuggestion.gutHealth&&<p style={{fontSize:12,marginTop:4}}><span style={{padding:'2px 6px',borderRadius:6,color:'#fff',fontSize:11,background:addItemSuggestion.gutHealth>=7?'#22c55e':addItemSuggestion.gutHealth>=4?'#f59e0b':'#ef4444'}}>{addItemSuggestion.gutHealth}/10</span> {addItemSuggestion.gutTip||''}</p>}
        </div>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>setAddItemSuggestion(null)} className="btn btn-secondary" style={{flex:1,padding:12}}>Edit Again</button>
          <button onClick={()=>appendIngredient(addItemSuggestion)} className="btn btn-primary" style={{flex:1,padding:12}}>Add</button>
        </div>
      </div>}
    </div>
  </div>}

  {selMeal&&<div className="modal-overlay modal-center" onClick={()=>setSelMeal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      {selMeal.photo&&<img src={selMeal.photo} style={{width:'100%',height:180,objectFit:'cover',borderRadius:16,marginBottom:16}}/>}
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
        <h2 style={{fontSize:20,fontWeight:700}}>{selMeal.category}</h2>
        <span style={{color:'var(--muted)'}}>{selMeal.time}</span>
      </div>
      {(selMeal.items||[]).map((it,i)=><p key={i} style={{marginBottom:4}}>{it.name} <span style={{color:'var(--muted)'}}>({it.quantity})</span></p>)}
      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:8,margin:'16px 0'}}>
        {Object.entries(EMPTY).map(([k])=><div key={k} style={{padding:10,background:'var(--subtle-bg)',borderRadius:8}}>
          <span style={{fontSize:12,color:'var(--muted)',textTransform:'capitalize'}}>{k}</span>
          <p style={{fontWeight:600}}>{r2(selMeal[k])}</p>
        </div>)}
      </div>
      <button onClick={()=>del(selMeal.id)} className="btn" style={{width:'100%',background:'rgba(239,68,68,0.2)',border:'1px solid rgba(239,68,68,0.3)',color:'var(--danger)',padding:14}}>Delete Meal</button>
      {selMeal.photo&&<button onClick={()=>shareMeal(selMeal.photo,selMeal,selMeal.items,selMeal.category,selMeal.time)} className="btn" style={{width:'100%',marginTop:12,padding:14,background:'linear-gradient(135deg,#3b82f6,#8b5cf6)',border:'none',color:'#fff'}}>ðŸ“¤ Share with Macros</button>}
    </div>
  </div>}

  {loading&&<div className="modal-overlay modal-center" style={{background:lightMode?'rgba(255,255,255,0.9)':'rgba(0,0,0,0.9)'}}>
    <div style={{textAlign:'center'}}>
      <div style={{width:60,height:60,border:'4px solid var(--primary)',borderTopColor:'transparent',borderRadius:'50%',animation:'spin 1s linear infinite',margin:'0 auto 16px'}}/>
      <p style={{fontWeight:600}}>Analyzing your meal...</p>
      <p style={{fontSize:14,color:'var(--muted)'}}>Using AI to detect nutrition</p>
    </div>
    <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
  </div>}

  {/* Add Goal Modal */}
  {modal==='addGoal'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:16}}>ðŸŽ¯ New Shared Goal</h2>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Goal Title</label>
        <input value={newGoal.title} onChange={e=>setNewGoal({...newGoal,title:e.target.value})} placeholder="e.g., Hit calorie target 5 days"/>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Goal Type</label>
        <select value={newGoal.type} onChange={e=>setNewGoal({...newGoal,type:e.target.value})}>
          <option value="both_hit">Both hit target (X days each)</option>
          <option value="combined">Combined total (work together)</option>
          <option value="streak">Streak challenge (both maintain)</option>
        </select>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Target</label>
        <input type="number" value={newGoal.target} onChange={e=>setNewGoal({...newGoal,target:+e.target.value})} placeholder="7"/>
      </div>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setModal(null)} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={addSharedGoal} disabled={!newGoal.title} className="btn btn-primary" style={{flex:1,padding:14,opacity:newGoal.title?1:0.5}}>Create Goal</button>
      </div>
    </div>
  </div>}

  {/* Suggest Meal Modal */}
  {modal==='suggestMeal'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:16}}>ðŸ½ï¸ Suggest a Meal</h2>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Meal Name</label>
        <input value={newMealIdea.name} onChange={e=>setNewMealIdea({...newMealIdea,name:e.target.value})} placeholder="e.g., Chicken stir fry?"/>
      </div>

      {newMealIdea.photo?<div style={{marginBottom:16}}>
        <img src={newMealIdea.photo} style={{width:'100%',height:120,objectFit:'cover',borderRadius:12}}/>
        <button onClick={()=>setNewMealIdea({...newMealIdea,photo:null})} className="btn btn-secondary" style={{width:'100%',marginTop:8}}>Remove Photo</button>
      </div>:<div style={{marginBottom:16}}>
        <p style={{fontSize:12,color:'var(--muted)',marginBottom:8}}>Add a photo (optional)</p>
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>document.getElementById('mealIdeaCam').click()} className="btn btn-secondary" style={{flex:1}}>ðŸ“¸ Take</button>
          <button onClick={()=>document.getElementById('mealIdeaGal').click()} className="btn btn-secondary" style={{flex:1}}>ðŸ–¼ï¸ Choose</button>
          {log.length>0&&log.some(m=>m.photo)&&<button onClick={()=>{
            const lastPhoto=[...log].reverse().find(m=>m.photo);
            if(lastPhoto)setNewMealIdea({...newMealIdea,photo:lastPhoto.photo});
          }} className="btn btn-secondary" style={{flex:1}}>ðŸ“‹ Recent</button>}
        </div>
        <input id="mealIdeaCam" type="file" accept="image/*" capture="environment" onChange={async e=>{const f=e.target.files?.[0];if(f){const img=await compress(f,400);setNewMealIdea({...newMealIdea,photo:img})}}} style={{display:'none'}}/>
        <input id="mealIdeaGal" type="file" accept="image/*" onChange={async e=>{const f=e.target.files?.[0];if(f){const img=await compress(f,400);setNewMealIdea({...newMealIdea,photo:img})}}} style={{display:'none'}}/>
      </div>}

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>{setModal(null);setNewMealIdea({name:'',photo:null})}} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={suggestMeal} disabled={!newMealIdea.name} className="btn btn-primary" style={{flex:1,padding:14,opacity:newMealIdea.name?1:0.5}}>Suggest</button>
      </div>
    </div>
  </div>}

  {/* New Challenge Modal */}
  {modal==='newChallenge'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:16}}>ðŸ† New Challenge</h2>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Challenge Title</label>
        <input value={newChallenge.title} onChange={e=>setNewChallenge({...newChallenge,title:e.target.value})} placeholder="e.g., Log every day this week"/>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Challenge Type</label>
        <select value={newChallenge.type} onChange={e=>setNewChallenge({...newChallenge,type:e.target.value})}>
          <option value="log_daily">Log every day (consecutive days)</option>
          <option value="hit_protein">Hit protein target (days in period)</option>
          <option value="total_meals">Total meals (group combined)</option>
        </select>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Target</label>
        <input type="number" value={newChallenge.target} onChange={e=>setNewChallenge({...newChallenge,target:+e.target.value})} placeholder="7"/>
      </div>
      <div style={{marginBottom:16}}>
        <label style={{fontSize:12,color:'var(--muted)',marginBottom:4,display:'block'}}>Duration (days)</label>
        <input type="number" value={newChallenge.days} onChange={e=>setNewChallenge({...newChallenge,days:+e.target.value})} placeholder="7"/>
      </div>
      <p style={{fontSize:12,color:'var(--muted)',marginBottom:16}}>All {friends.length} friends will be auto-joined</p>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setModal(null)} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={createChallenge} disabled={!newChallenge.title} className="btn btn-primary" style={{flex:1,padding:14,opacity:newChallenge.title?1:0.5}}>Create</button>
      </div>
    </div>
  </div>}

  {/* Firebase Setup Modal */}
  {modal==='firebaseSetup'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24,maxHeight:'80vh',overflowY:'auto'}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:8}}>ðŸ”¥ Firebase Setup</h2>
      <p style={{color:'var(--muted)',fontSize:13,marginBottom:16}}>Create a free project at <a href="https://console.firebase.google.com" target="_blank" style={{color:'var(--primary)'}}>console.firebase.google.com</a></p>

      <ol style={{fontSize:13,color:'var(--muted)',marginBottom:16,paddingLeft:20}}>
        <li style={{marginBottom:8}}>Create a new Firebase project</li>
        <li style={{marginBottom:8}}>Go to Build â†’ Realtime Database â†’ Create Database</li>
        <li style={{marginBottom:8}}>Start in test mode (for now)</li>
        <li style={{marginBottom:8}}>Go to Project Settings â†’ Your apps â†’ Web</li>
        <li>Copy your config values below</li>
      </ol>

      <div style={{display:'flex',flexDirection:'column',gap:12,marginBottom:16}}>
        <input id="fb-apiKey" placeholder="apiKey" style={{fontSize:13}}/>
        <input id="fb-authDomain" placeholder="authDomain (yourproject.firebaseapp.com)" style={{fontSize:13}}/>
        <input id="fb-databaseURL" placeholder="databaseURL (https://yourproject-default-rtdb.firebaseio.com)" style={{fontSize:13}}/>
        <input id="fb-projectId" placeholder="projectId" style={{fontSize:13}}/>
      </div>

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setModal(null)} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={()=>{
          const config={
            apiKey:document.getElementById('fb-apiKey').value,
            authDomain:document.getElementById('fb-authDomain').value,
            databaseURL:document.getElementById('fb-databaseURL').value,
            projectId:document.getElementById('fb-projectId').value
          };
          if(!config.apiKey||!config.databaseURL){alert('API Key and Database URL are required');return}
          saveFirebaseConfig(config);
          setModal(null);
        }} className="btn btn-primary" style={{flex:1,padding:14}}>Connect</button>
      </div>
    </div>
  </div>}

  {/* Customize Home Modal */}
  {modal==='customizeHome'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:20}}>Customize Home Screen</h2>
      <p style={{color:'var(--muted)',fontSize:13,marginBottom:16}}>Toggle sections on or off. The calorie ring always shows.</p>
      {[['macros','ðŸ’ª','Macros'],['quests','âš”ï¸','Daily Quests'],['water','ðŸ’§','Hydration'],['meals','ðŸ½ï¸','Meals'],['analytics','ðŸ“Š','Analytics']].map(([key,icon,label])=>
        <div key={key} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid var(--subtle-bg)'}}>
          <span style={{display:'flex',alignItems:'center',gap:8}}><span>{icon}</span> {label}</span>
          <button onClick={()=>toggleSection(key)} style={{width:52,height:28,borderRadius:14,border:'none',cursor:'pointer',background:sections[key]?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--toggle-off)',position:'relative',transition:'background 0.3s'}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'#fff',position:'absolute',top:3,left:sections[key]?27:3,transition:'left 0.3s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}}/>
          </button>
        </div>
      )}
      <button onClick={()=>setModal(null)} className="btn btn-primary" style={{width:'100%',marginTop:20,padding:14}}>Done</button>
    </div>
  </div>}

  {modal==='selectMacros'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:8}}>Select Top 3 Macros</h2>
      <p style={{color:'var(--muted)',fontSize:13,marginBottom:16}}>Long-press the macros card to change. Pick exactly 3.</p>
      {Object.keys(MACRO_INFO).map(key=>{const info=MACRO_INFO[key];const sel=selectedMacros.includes(key);return<button key={key} onClick={()=>{let ns=[...selectedMacros];if(sel){if(ns.length<=1)return;ns=ns.filter(k=>k!==key)}else{if(ns.length>=3)ns.shift();ns.push(key)}const u={...users};u[cur]={...ud,selectedMacros:ns};save(u)}} style={{display:'flex',alignItems:'center',gap:12,width:'100%',padding:12,marginBottom:8,background:sel?'rgba(16,185,129,0.15)':'var(--subtle-bg)',border:sel?'1px solid rgba(16,185,129,0.4)':'1px solid var(--subtle-bg)',borderRadius:12,cursor:'pointer',textAlign:'left',color:'var(--text)'}}>
        <span style={{fontSize:20,width:32,textAlign:'center'}}>{info.emoji}</span>
        <div style={{flex:1}}><p style={{fontWeight:600,fontSize:14}}>{info.name}</p></div>
        <span style={{fontSize:18,color:sel?'var(--primary)':'var(--muted)'}}>{sel?'âœ“':'â—‹'}</span>
      </button>})}
      <button onClick={()=>setModal(null)} className="btn btn-primary" style={{width:'100%',marginTop:12,padding:14}}>Done</button>
    </div>
  </div>}

  {/* Pick Primary Macro Modal */}
  {modal==='pickPrimary'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:8}}>Track Which Macro?</h2>
      <p style={{color:'var(--muted)',fontSize:13,marginBottom:16}}>Choose what to display on your main progress ring.</p>
      {Object.keys(MACRO_INFO).map(key=>{const info=MACRO_INFO[key];const sel=primaryKey===key;const target=key==='calories'?tgt.calories:(tgt[key]||MACRO_TARGETS[key]||0);return<button key={key} onClick={()=>{const u={...users};u[cur]={...ud,primary:key};save(u);setModal(null)}} style={{display:'flex',alignItems:'center',gap:12,width:'100%',padding:12,marginBottom:8,background:sel?'rgba(16,185,129,0.15)':'var(--subtle-bg)',border:sel?'1px solid rgba(16,185,129,0.4)':'1px solid var(--subtle-bg)',borderRadius:12,cursor:'pointer',textAlign:'left',color:'var(--text)'}}>
        <span style={{fontSize:20,width:32,textAlign:'center'}}>{info.emoji}</span>
        <div style={{flex:1}}><p style={{fontWeight:600,fontSize:14}}>{info.name}</p><p style={{fontSize:12,color:'var(--muted)'}}>Goal: {target} {info.unit}</p></div>
        {sel&&<span style={{fontSize:18,color:'var(--primary)'}}>âœ“</span>}
      </button>})}
    </div>
  </div>}

  {/* Friend Nudge Modal */}
  {modal==='nudgeFriend'&&<div className="modal-overlay modal-center" onClick={()=>setModal(null)}>
    <div className="modal" style={{borderRadius:24}} onClick={e=>e.stopPropagation()}>
      <h2 style={{fontSize:20,fontWeight:700,marginBottom:16}}>ðŸ‘‹ Nudge {nudgeFriendName}</h2>
      <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:16}}>
        {["Log your meals! ðŸ“","Let's hit our goals! ðŸ’ª","Miss you! ðŸ’•","Custom..."].map(msg=>
          <button key={msg} onClick={()=>setNudgeFriendMsg(msg==='Custom...'?'':msg)} style={{padding:12,background:nudgeFriendMsg===msg?'linear-gradient(135deg,var(--primary),var(--secondary))':'var(--subtle-bg)',border:'none',borderRadius:12,textAlign:'left',cursor:'pointer',color:'var(--text)'}}>{msg}</button>
        )}
      </div>
      <input value={nudgeFriendMsg} onChange={e=>setNudgeFriendMsg(e.target.value)} placeholder="Write your own..." style={{marginBottom:12}}/>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setModal(null)} className="btn btn-secondary" style={{flex:1,padding:14}}>Cancel</button>
        <button onClick={()=>sendFriendNudge(nudgeFriendId,nudgeFriendMsg)} disabled={!nudgeFriendMsg} className="btn btn-primary" style={{flex:1,padding:14,opacity:nudgeFriendMsg?1:0.5}}>Send ðŸ‘‹</button>
      </div>
    </div>
  </div>}

  {/* Update Banner */}
  {updateAvailable&&<div style={{position:'fixed',top:0,left:0,right:0,zIndex:400,background:'linear-gradient(135deg,#7c3aed,#3b82f6)',padding:'16px 20px',display:'flex',alignItems:'center',justifyContent:'center',gap:12,boxShadow:'0 4px 20px rgba(0,0,0,0.4)'}}>
    <span style={{fontSize:24}}>ðŸŽ‰</span>
    <div style={{flex:1}}>
      <p style={{fontWeight:700,fontSize:15,color:'#fff'}}>New update available! v{updateAvailable}</p>
      <p style={{fontSize:12,color:'rgba(255,255,255,0.8)'}}>Tap update to get the latest features</p>
    </div>
    <button onClick={async()=>{if('caches' in window){const names=await caches.keys();await Promise.all(names.map(n=>caches.delete(n)))}window.location.reload(true)}} style={{background:'#fff',color:'#7c3aed',border:'none',borderRadius:10,padding:'10px 20px',fontWeight:700,fontSize:14,cursor:'pointer',flexShrink:0}}>Update</button>
    <button onClick={()=>setUpdateAvailable(null)} style={{background:'none',border:'none',color:'rgba(255,255,255,0.6)',fontSize:20,cursor:'pointer',padding:4,flexShrink:0}}>âœ•</button>
  </div>}

  {/* Rate Limit Toast */}
  {rateLimitMsg&&<div style={{position:'fixed',top:20,left:'50%',transform:'translateX(-50%)',zIndex:300,background:'linear-gradient(135deg,#92400e,#78350f)',border:'1px solid rgba(245,158,11,0.4)',borderRadius:16,padding:'16px 20px',display:'flex',alignItems:'center',gap:12,boxShadow:'0 8px 32px rgba(0,0,0,0.4)',animation:'toastSlideIn 0.4s ease-out',maxWidth:'90vw'}}>
    <span style={{fontSize:24,flexShrink:0}}>â³</span>
    <div>
      <p style={{fontWeight:700,fontSize:14,color:'#fff',marginBottom:2}}>Rate limit reached</p>
      <p style={{fontSize:12,color:'rgba(255,255,255,0.7)'}}>{rateLimitMsg}</p>
    </div>
  </div>}

  {/* Queue Indicator */}
  {photoQueue.length>0&&<div style={{position:'fixed',bottom:90,left:'50%',transform:'translateX(-50%)',zIndex:250,background:'linear-gradient(135deg,#1e3a5f,#1a2744)',border:'1px solid rgba(59,130,246,0.4)',borderRadius:12,padding:'10px 16px',display:'flex',alignItems:'center',gap:10,boxShadow:'0 4px 16px rgba(0,0,0,0.3)'}}>
    <div style={{width:20,height:20,border:'3px solid rgba(59,130,246,0.3)',borderTopColor:'#3b82f6',borderRadius:'50%',animation:'spin 1s linear infinite'}}/>
    <span style={{fontSize:13,color:'#fff'}}>{photoQueue.length} photo{photoQueue.length>1?'s':''} queued â€” auto-retrying</span>
    <button onClick={()=>setPhotoQueue([])} style={{background:'none',border:'none',color:'rgba(255,255,255,0.5)',cursor:'pointer',fontSize:16,padding:0}}>âœ•</button>
    <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
  </div>}

  {/* Voice Recording Overlay */}
  {voiceRecording&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.85)',backdropFilter:'blur(10px)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',zIndex:150}}>
    <div className="voice-pulse" style={{width:100,height:100,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:48,marginBottom:24}}>ðŸŽ™ï¸</div>
    <p style={{fontSize:20,fontWeight:700,marginBottom:8,color:'#fff'}}>{voiceProcessing?'Processing...':'Listening...'}</p>
    {!voiceFallback&&voiceTranscript&&<p style={{fontSize:15,color:'var(--muted)',maxWidth:300,textAlign:'center',marginBottom:16}}>"{voiceTranscript}"</p>}
    {!voiceFallback&&!voiceTranscript&&!voiceProcessing&&<p style={{fontSize:13,color:'var(--muted)',marginBottom:16}}>Speak what you ate...</p>}
    {voiceFallback&&<div style={{width:'80%',maxWidth:300,marginBottom:16}}>
      <p style={{fontSize:13,color:'var(--muted)',marginBottom:8,textAlign:'center'}}>Speech recognition unavailable. Type instead:</p>
      <input value={voiceFallbackText} onChange={e=>setVoiceFallbackText(e.target.value)} placeholder='e.g. "2 eggs and toast with butter"' style={{width:'100%',padding:12,borderRadius:12,border:'1px solid var(--input-border)',background:'var(--subtle-bg)',color:'inherit',fontSize:14,textAlign:'center',boxSizing:'border-box'}}/>
    </div>}
    {voiceProcessing&&<div style={{width:40,height:40,border:'3px solid var(--subtle)',borderTopColor:'var(--primary)',borderRadius:'50%',animation:'spin 1s linear infinite',marginBottom:16}}/>}
    <div style={{display:'flex',gap:12}}>
      <button onClick={()=>{stopVoiceRecording();setVoiceRecording(false);setVoiceTranscript('');setVoiceFallbackText('')}} className="btn btn-secondary" style={{padding:'12px 24px'}}>Cancel</button>
      {!voiceProcessing&&<button onClick={handleVoiceDone} className="btn btn-primary" style={{padding:'12px 24px'}}>Done</button>}
    </div>
  </div>}

  {/* Badge Toast */}
  {badgeToast&&<div className="badge-toast">
    <div style={{width:48,height:48,borderRadius:'50%',background:'linear-gradient(135deg,var(--primary),var(--secondary))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:24,flexShrink:0}}>{badgeToast.icon}</div>
    <div>
      <p style={{fontWeight:700,fontSize:15}}>{badgeToast.name}</p>
      <p style={{fontSize:12,color:'var(--muted)'}}>{badgeToast.desc}</p>
    </div>
    <span style={{color:'var(--secondary)',fontWeight:700,fontSize:13,marginLeft:'auto'}}>+50 XP</span>
  </div>}

  {/* Goal Celebration */}
  {celebrateGoal&&<div style={{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,0.8)',zIndex:200,animation:'fadeIn 0.3s'}}>
    <div style={{textAlign:'center',animation:'bounceIn 0.5s'}}>
      <div style={{fontSize:80,marginBottom:16}}>ðŸŽ‰</div>
      <h2 style={{fontSize:28,fontWeight:800,marginBottom:8}}>Goal Complete!</h2>
      <p style={{color:'var(--muted)',fontSize:18}}>{celebrateGoal}</p>
    </div>
    <style>{`
      @keyframes fadeIn{from{opacity:0}to{opacity:1}}
      @keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    `}</style>
  </div>}
</div>}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(sw=>sw.unregister()));}
</script>
</body>
</html>
